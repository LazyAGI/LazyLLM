# **18é«˜é˜¶RAGï¼šAgentic RAG**

>å‰é¢æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ åˆ°äº†å¦‚ä½•æ„å»º RAG ç³»ç»Ÿï¼Œä»¥åŠå¯¹ RAG ç³»ç»Ÿè¿›è¡Œæ•ˆæœæå‡ã€é€Ÿåº¦ä¼˜åŒ–ã€åŠŸèƒ½æ‰©å±•ç­‰ç­‰æ–¹é¢ã€‚æœ¬æ•™ç¨‹æˆ‘ä»¬å°†åœ¨æ­¤åŸºç¡€ä¸Šè¿›ä¸€æ­¥ä»‹ç»æœ€è¿‘å¾ˆç«çš„Agentic RAGï¼Œå®ƒæ˜¯RAGçš„å˜ç§ï¼Œä½†æ›´åŠ æ™ºèƒ½ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ï¼

 å¦‚æœæŠŠ **RAG â€‹**æ¯”ä½œå¸¦ç€**ä¹¦æœ¬**å»è€ƒè¯•çš„è€ƒç”Ÿï¼Œé‚£ä¹ˆ Agentic RAG å°±æ˜¯åŒæ—¶å¸¦ç€**è€å¸ˆå’Œä¹¦**ä¸€èµ·å»è€ƒè¯•çš„è€ƒç”Ÿï¼

![image.png](18_images/img1.png)

Agentic RAG å°±æ˜¯æ•´åˆäº† AI Agent çš„ RAGã€‚æœ¬æ–‡å°†å…ˆä» RAGã€AI Agent ç­‰æ¦‚å¿µä¸ºåŸºç¡€å¼•å‡º Agentic RAGï¼›ç„¶åè¯¦ç»†ä»‹ç» Agentic RAG çš„åŸºæœ¬åŸç†å’Œç»„æˆï¼›ç´§æ¥ç€ä»‹ç»ä¸ºä»€ä¹ˆè¦ç”¨ Agentic RAGï¼Œå¹¶ä¸ä¼ ç»Ÿçš„ RAG è¿›è¡Œå¯¹æ¯”ï¼›æœ€åä»‹ç»å¦‚ä½•æ­å»ºä¸€ä¸ª Agentic RAGã€‚

## åŸºæœ¬æ¦‚å¿µ

ä»€ä¹ˆæ˜¯ Agentic RAG ? è®©æˆ‘ä»¬å°†è¿™ä¸ªå¤æ‚çš„æ¦‚å¿µå…ˆæ‹†è§£ä¸º RAG å’Œ AI Agentï¼ˆAgentic å°±æ˜¯å¼•å…¥äº† AI Agentï¼‰æ¥é€ä¸ªè¿›è¡Œä»‹ç»ã€‚

### 1. å›é¡¾ RAG ç³»ç»Ÿ

é¦–å…ˆè®©æˆ‘ä»¬å…ˆå›é¡¾ä¸€ä¸‹ RAG çš„åŸºæœ¬æ¦‚å¿µã€‚

#### åŸºæœ¬æ¦‚å¿µ

æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRetrieval-Augmented Generationï¼Œç®€ç§°RAGï¼‰æŠ€æœ¯æ˜¯ä¸€ç§åˆ©ç”¨å¤–æŒ‚çŸ¥è¯†æºä¸ºå¤§è¯­è¨€æ¨¡å‹è¡¥å……ä¸Šä¸‹æ–‡æ¥å¼ºåŒ–è¾“å…¥ä»è€Œæé«˜å¤§è¯­è¨€æ¨¡å‹ç”Ÿæˆå†…å®¹è´¨é‡ï¼Œå¹¶å‡å°‘å¹»è§‰ï¼ˆhallucinationsï¼Œå¹»è§‰å³ LLM è‡ªä¿¡åœ°ç¼–é€ ä¿¡æ¯éšæ„å‘æŒ¥ç”Ÿæˆçš„ä¸çœŸå®çš„å†…å®¹ï¼‰çš„æŠ€æœ¯ã€‚æ‰“ä¸ªæ¯”æ–¹æ¥è¯´ï¼ŒRAGå°±æ˜¯ä¸€ä¸ªå¸¦ç€ä¹¦æœ¬å»è€ƒè¯•çš„è€ƒç”Ÿã€‚è€ƒé¢˜å°±æ˜¯è¾“å…¥ï¼Œä¹¦æœ¬å°±æ˜¯å¤–æŒ‚çš„çŸ¥è¯†åº“ï¼Œè€ƒç”Ÿå°±æ˜¯å¤§æ¨¡å‹ï¼Œè€ƒç”Ÿä½œç­”çš„å†…å®¹å°±æ˜¯å¤§æ¨¡å‹ç”Ÿæˆçš„å†…å®¹ã€‚ä¸€èˆ¬æ¥è¯´å¦‚æœä¸€é—¨é—­å·è€ƒèƒ½å¤Ÿå¸¦ç€æ•™ç§‘ä¹¦å»è€ƒè¯•ï¼Œé‚£ç­”å·çš„åˆ†æ•°éƒ½ä¼šå¾ˆé«˜ï¼Œè¿™ä¹Ÿæ­£æ˜¯RAGèƒ½æé«˜å¤§æ¨¡å‹ç”Ÿæˆå†…å®¹è´¨é‡çš„ä¸€ä¸ªå½¢è±¡è§£é‡Šã€‚

#### åŸºæœ¬ç»„ä»¶

RAG ä¸»è¦åŒ…æ‹¬äº†ä¸¤ä¸ªç»„ä»¶ï¼š

* æ£€ç´¢ç»„ä»¶ï¼ˆRetrieval Componentï¼‰ï¼šæ£€ç´¢ç»„ä»¶ç”¨äºæ ¹æ®è¾“å…¥å»åŒ¹é…çŸ¥è¯†åº“ä¸­çš„ä¿¡æ¯ï¼Œæ‰“ä¸ªæ¯”æ–¹å°±æ˜¯å¸¦ç€è€ƒé¢˜å»æ•™ç§‘ä¹¦ä¸­æœç´¢ç­”æ¡ˆã€‚
* ç”Ÿæˆç»„ä»¶ï¼ˆGenerative Componentï¼‰ï¼šç”Ÿæˆç»„ä»¶ç”¨äºæŠŠè¾“å…¥å’Œæ£€ç´¢åˆ°çš„ä¿¡æ¯é€ç»™å¤§æ¨¡å‹æ¥ç”Ÿæˆé«˜è´¨é‡çš„å›å¤ï¼Œæ‰“ä¸ªæ¯”æ–¹å°±æ˜¯ï¼šè€ƒç”Ÿç»“åˆé¢˜ç›®å’Œä»æ•™ç§‘ä¹¦ä¸­æ‰¾åˆ°çš„å†…å®¹æ¥å›ç­”è¯•é¢˜ã€‚

#### å·¥ä½œæµç¨‹

RAG ï¼ˆRetrieval-Augmented Generationï¼‰è¿™ä¸ªåå­—å·²ç»å°†è¿™ä¸ªæŠ€æœ¯çš„å·¥ä½œæµç¨‹ç»™æ­ç¤ºäº†å‡ºæ¥ï¼Œè®©æˆ‘ä»¬ç»“åˆå›¾ç¤ºå¹¶å°†åå­—è¿›è¡Œæ‹†è§£æ¥çœ‹ï¼š

* é¦–å…ˆæˆ‘ä»¬è¾“å…¥ä¸€ä¸ª queryï¼š
  * â‘  Retrievalï¼šæ£€ç´¢ï¼Œquery é¦–å…ˆè¢«ç”¨äºåœ¨ä¸€ä¸ªçŸ¥è¯†åº“ä¸­è¿›è¡Œæ£€ç´¢ï¼ˆè¿™é‡Œç®€åŒ–äº† RAG ä¸­embeddingã€å‘é‡åŒ–ç­‰ç»†èŠ‚ï¼Œè¯¦ç»†å¯è§å¾€æœŸæ•™ç¨‹[åŸºç¡€2ï¼šåˆè¯†RAG](https://github.com/LazyAGI/Tutorial/tree/main/rag/notebook/chapter2/2.ipynb)ï¼ŒçŸ¥è¯†åº“ä¸­çš„æ–‡æ¡£ä»¥åŠ query éƒ½ä¼šè¢«å‘é‡åŒ–ä»¥ä¾¿è¿›è¡Œç›¸ä¼¼åº¦è®¡ç®—ï¼Œä¸‹æ–‡å›¾ä¸­ Vector Search å¯¹åº”çš„å°±æ˜¯å¯¹çŸ¥è¯†åº“çš„æœç´¢ï¼‰ï¼›
  * â‘¡ Augmentedï¼šå¢å¼ºï¼Œå°†æ£€ç´¢åˆ°çš„å†…å®¹ï¼ˆcontextï¼‰ä¸æˆ‘ä»¬è¾“å…¥çš„ query è¿›è¡Œæ‹¼æ¥ï¼Œä»¥è¾¾åˆ°å¢å¼º query çš„æ•ˆæœï¼›
  * â‘¢ Generationï¼šç”Ÿæˆï¼Œå°†ä¸Šä¸€æ­¥å¢å¼ºåçš„ query é€å…¥åˆ° LLM å¤§æ¨¡å‹æ¥ç”Ÿæˆå›å¤çš„å†…å®¹ã€‚
* å°†ç”Ÿæˆçš„å†…å®¹è¿”å›ã€‚

![image.png](18_images/img2.png)

### 2. AI Agent ç®€ä»‹

#### åŸºæœ¬æ¦‚å¿µ

é¦–å…ˆ Agent æ˜¯ä»€ä¹ˆï¼Ÿä¸­æ–‡ä¸­å¸¸è§ç¿»è¯‘ä¸ºï¼šä»£ç†äººã€‚æˆ‘ä»¬è¦åšä¸€ä»¶äº‹ï¼Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼ï¼Œè‡ªå·±ä¸€æ­¥ä¸€æ­¥æ¥è¾¾æˆï¼›å¦å¤–å°±æ˜¯æ‰¾ä¸ªäººï¼Œè¿™ä¸ªäººå°±å«åšä»£ç†äººï¼Œæˆ‘ä»¬å…¨æƒæˆæƒç»™ä»£ç†äººè€Œä¸ç”¨å…³å¿ƒä»–æ€ä¹ˆåšï¼Œåªç®¡ä»–èƒ½å¸®æˆ‘ä»¬è¾¾åˆ°ç›®çš„ã€‚å‰è€…æˆ‘ä»¬éœ€è¦æ“å¿ƒæ¯ä¸ªç»†èŠ‚ï¼Œè€Œåè€…æˆ‘ä»¬å¯ä»¥åäº«å…¶æˆã€‚æ‰€ä»¥ Agent çš„ä¸€ä¸ªç‰¹ç‚¹å°±æ˜¯ï¼šä¸éœ€è¦æˆ‘ä»¬å»å…³å¿ƒè¾¾æˆæŸä¸ªä»»åŠ¡çš„ç»†èŠ‚ï¼Œè€Œåªéœ€è¦æ”¾å¿ƒæŠŠä»»åŠ¡äº¤ç»™ä»–ï¼Œè®©ä»–å»å¸®æˆ‘ä»¬è¾¾æˆã€‚

å›åˆ° AI æ™ºèƒ½ä½“ï¼ˆAI Agentï¼‰ï¼ŒAI Agent ä¸€èˆ¬è¢«è®¤ä¸ºä¸€ä¸ªå…·æœ‰ç‰¹å®šè§’è‰²å’Œä»»åŠ¡çš„ LLMï¼Œå®ƒå¯ä»¥è®¿é—®è®°å¿†å’Œå¤–éƒ¨å·¥å…·ã€‚ä½†æˆ‘è§‰å¾— AI æ™ºèƒ½ä½“æ›´åƒæ˜¯ä¸€ä¸ªäººï¼Œæˆ‘ä»¬è¯·æ¥çš„ä»£ç†äººã€‚æˆ‘æ›´æ„¿æ„æŠŠå®ƒæ¯”ä½œä¸€ä¸ªæœ‰ç€é«˜åº¦ä¸“ä¸šèƒ½åŠ›çš„äººâ€”â€”ä¸“å®¶ã€‚LLM æ˜¯å…¶å¤§è„‘ï¼Œå€ŸåŠ©ä»–èªæ˜çš„å¤§è„‘ï¼Œä»–å¯ä»¥è‡ªåŠ¨è§„åˆ’æ­¥éª¤ï¼Œç»“åˆåé¦ˆåå¤é‡‡å–è¡ŒåŠ¨ï¼ˆæ¯”å¦‚è°ƒç”¨å·¥å…·ï¼‰æ¥è§£å†³æ‰‹å¤´çš„ä»»åŠ¡ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸éœ€è¦æˆ‘ä»¬æ“å¿ƒï¼Œæˆ‘ä»¬åªéœ€è¦æ”¾æƒè®©ä»–å»åšå°±å¥½ï¼

æƒ³è±¡ä½ æ˜¯ä¸€ä½å›½ç‹ï¼Œå½“ä½ æƒ³æ‰©å¼ é¢†åœŸçš„æ—¶å€™ï¼Œä½ å¹¶ä¸éœ€è¦è‡ªå·±äº²å†äº²ä¸ºï¼Œä½ åªéœ€è¦æ‰¾ä»£ç†äººâ€”â€”ä½ çš„å¤§å°†ï¼ˆå³ï¼šå¸¦å…µä½œæˆ˜çš„ä¸“å®¶ï¼‰ï¼Œæ”¾æƒè®©å¤§å°†å»åšï¼Œä»–è‡ªå·±ä¼šè§„åˆ’ä½œæˆ˜è®¡åˆ’ï¼ˆè§„åˆ’ï¼‰ã€è°ƒå…µé£å°†ï¼ˆè°ƒç”¨å·¥å…·ï¼‰ã€å†²é”‹é™·é˜µï¼ˆé‡‡å–è¡ŒåŠ¨ï¼‰ã€‚ä½ åªéœ€è¦ç­‰å¾…ä»–å‡¯æ—‹çš„å¥½æ¶ˆæ¯ã€‚è¿™ä¸ªå¤§å°†å°±åƒæ˜¯æˆ‘ä»¬çš„ AI æ™ºèƒ½ä½“ã€‚

#### åŸºæœ¬ç»„ä»¶

ä¸€ä¸ª AI Agent ä¸»è¦ç”±ä¸‹é¢ç»„ä»¶æ„æˆï¼š

* LLMï¼šè¿™ä¸ªæ˜¯æ™ºèƒ½ä½“çš„å¤§è„‘ï¼Œå¯¹åº”å¤§å°†å†›çš„å¤§è„‘ï¼›
* è®°å¿†ï¼ˆMemoryï¼‰ï¼šæ™ºèƒ½ä½“çš„è®°å¿†ï¼Œå¯¹åº”äº†å¤§å°†å†›å¯¹æŸä¸ªé¢†åœŸæ‰©å¼ ä»»åŠ¡ä»å¼€å§‹åˆ°ç»“æŸçš„æ‰€æœ‰è®°å¿†ï¼Œç”šè‡³æ˜¯ä¹‹å‰çš„æˆ˜æ–—è®°å¿†ï¼›
* è§„åˆ’ï¼ˆPlanningï¼‰ï¼šæ™ºèƒ½ä½“å¯ä»¥è¿›è¡Œåæ€ã€è‡ªæˆ‘æ‰¹è¯„ã€è‡ªåŠ¨è·¯ç”±ï¼ˆé‡‡å–è¡ŒåŠ¨ï¼‰ç­‰ï¼Œå¯¹åº”äº†å›½ç‹æ”¾æƒç»™å¤§å°†å†›ï¼Œè®©ä»–èƒ½æŒ‰ç…§è‡ªå·±çš„æƒ³æ³•å»è¾¾æˆä»»åŠ¡ï¼›
* å·¥å…·ï¼ˆToolsï¼‰ï¼šæ˜¯æ™ºèƒ½ä½“å¯ä»¥è°ƒç”¨çš„å·¥å…·ï¼Œå¯¹åº”å¤§å°†å†›å¯ä»¥è°ƒç”¨çš„å…µåŠ›ï¼Œå¯ä»¥ä½¿ç”¨çš„æ­¦å™¨ç­‰ç­‰ï¼›

![image.png](18_images/img3.png)

#### å·¥ä½œæµç¨‹

AI Agent æœ‰å¾ˆå¤šç±»å‹çš„å·¥ä½œæµç¨‹ï¼Œè¿™é‡Œä»‹ç»å‡ ç§å¸¸è§çš„å·¥ä½œæµç¨‹ï¼šFunction Call Agentã€ReActã€PlanAndSolve ä»¥åŠ ReWOOã€‚AI æ™ºèƒ½ä½“çš„å·¥ä½œæµç¨‹ä¸»è¦å°±æ˜¯å…¶è¡Œä¸ºæ¨¡å¼ï¼Œå°±åƒæ˜¯ä¸€ä¸ªäººåšäº‹çš„è¡Œä¸ºä¹ æƒ¯ï¼š

* Function Call Agentï¼šåœ¨è¯¥æ™ºèƒ½ä½“æ¥åˆ°ä»»åŠ¡åï¼Œå®ƒä¼šä¸æ–­å°è¯•ä»¥å„ç§å‚æ•°è°ƒç”¨å·¥å…·å’Œè§‚å¯Ÿè¾“å‡ºï¼Œç›´åˆ°è§£å†³é—®é¢˜æˆ–è¾¾åˆ°æœ€å¤§é‡å¤æ¬¡æ•°ã€‚
* ReActï¼š è¯¥æ™ºèƒ½ä½“æ¥åˆ°ä»»åŠ¡åï¼Œå®ƒä¼šå…ˆæ€è€ƒï¼Œç„¶åå†å°è¯•è°ƒç”¨å·¥å…·å’Œè§‚å¯Ÿè¾“å‡ºï¼Œä¸æ–­é‡å¤è¿™ä¸ªè¿‡ç¨‹ç›´åˆ°è§£å†³é—®é¢˜æˆ–è¾¾åˆ°æœ€å¤§é‡å¤æ¬¡æ•°ã€‚
* PlanAndSolveï¼šè¯¥æ™ºèƒ½ä½“æ¥åˆ°ä»»åŠ¡åï¼Œä¼šå…ˆè®¡åˆ’æŠŠä»»åŠ¡åˆ†è§£ï¼Œç„¶åå°è¯•è§£å†³å½“å‰æ­¥éª¤ä»»åŠ¡ï¼Œæ ¹æ®å½“å‰æ­¥éª¤çš„ç»“æœæ¥ç»§ç»­æ‰§è¡Œä»»åŠ¡æˆ–è€…é‡æ–°è®¡åˆ’åé¢çš„ä»»åŠ¡ï¼Œç›´åˆ°ä»»åŠ¡è¢«è§£å†³æˆ–è¾¾åˆ°æœ€å¤§é‡å¤æ¬¡æ•°ã€‚
* ReWOO: è¯¥æ™ºèƒ½ä½“æ¥åˆ°ä»»åŠ¡åï¼Œä¹Ÿä¼šå…ˆè®¡åˆ’æŠŠä»»åŠ¡åˆ†è§£ï¼Œç„¶åå°†æ‰€æœ‰æ­¥éª¤å…¨éƒ¨æ‰§è¡Œå®Œæ¯•ï¼Œç»¼åˆæ‰€æœ‰æ­¥éª¤çš„ç»“æœæ¥è¿›è¡Œåé¦ˆã€‚

##### Function Call Agent

Function Call Agent ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹çš„æµç¨‹ï¼š

1. è¡ŒåŠ¨ï¼ˆActionï¼‰ï¼šAgent æ”¶åˆ°ä¸€ä¸ª query åï¼Œå®ƒä¼šç›´æ¥è¡ŒåŠ¨ï¼Œæ¯”å¦‚å»è°ƒç”¨æŸä¸ªå·¥å…·ï¼›
2. è§‚å¯Ÿï¼ˆObservationï¼‰: Agent è§‚å¯Ÿåˆ°è¡ŒåŠ¨çš„åé¦ˆï¼Œæ¯”å¦‚å·¥å…·çš„è¾“å‡ºã€‚

ä¸Šé¢è¿‡ç¨‹ä¼šä¸æ–­å¾ªç¯å¾€å¤ï¼Œå¦‚æœè§‚å¯Ÿåˆ°è¡ŒåŠ¨çš„åé¦ˆæ²¡é—®é¢˜ï¼Œæ»¡è¶³äº† query çš„è¦æ±‚ï¼Œæˆ–è€…è¾¾åˆ°äº†æœ€å¤§çš„è¿­ä»£æ¬¡æ•°ï¼Œé‚£ä¹ˆ Agent ä¼šé€€å‡ºå¹¶è¿”å›ç»“æœ responseã€‚

![image.png](18_images/img4.png)

æˆ‘ä»¬å¯ä»¥åœ¨LazyLLMä¸­ä½¿ç”¨AI Agentï¼Œé¦–å…ˆå®šä¹‰å·¥å…·ï¼Œç„¶åæŠŠå®šä¹‰å¥½çš„å·¥å…·æ³¨å†Œè¿› LazyLLM ä¸­ï¼Œä¹‹åå°±å¯ä»¥å®šä¹‰æ¨¡å‹ï¼Œå¹¶ä½¿ç”¨ FunctionCall Agentï¼š

```python
from typing import Literal
import json
import lazyllm
from lazyllm.tools import fc_register, FunctionCall, FunctionCallAgent
@fc_register("tool")
def get_current_weather(location: str, unit: Literal["fahrenheit", "celsius"] = "fahrenheit"):
Â  Â  ...
@fc_register("tool")
def get_n_day_weather_forecast(location: str, num_days: int, unit: Literal["celsius", "fahrenheit"] = 'fahrenheit'):
Â  Â  ...
llm = lazyllm.TrainableModule("internlm2-chat-20b").start() Â # or llm = lazyllm.OnlineChatModule()
tools = ["get_current_weather", "get_n_day_weather_forecast"]
fc = FunctionCall(llm, tools)
query = "What's the weather like today in celsius in Tokyo and Paris."
ret = fc(query)
print(f"ret: {ret}")
agent = FunctionCallAgent(llm, tools)
ret = agent(query)
print(f"ret: {ret}")

```

![image.png](18_images/img5.png)

##### React

React ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹çš„æµç¨‹ï¼š

1. æ€è€ƒï¼ˆThoughtï¼‰: Agent åœ¨æ”¶åˆ° query åï¼Œå®ƒä¼šå…ˆç»™å‡ºä¸‹ä¸€æ­¥è¦é‡‡å–çš„è¡ŒåŠ¨ï¼›
2. è¡ŒåŠ¨ï¼ˆActionï¼‰: Agent ä¼šé‡‡å–å¹¶æ‰§è¡Œä¸€ä¸ªè¡ŒåŠ¨ï¼Œæ¯”å¦‚ä½¿ç”¨å·¥å…·ï¼ˆæˆ–è€…ç»§ç»­æ€è€ƒï¼‰ï¼›
3. è§‚å¯Ÿï¼ˆObservationï¼‰: Agent è§‚å¯Ÿè¡ŒåŠ¨çš„åé¦ˆï¼Œæ¯”å¦‚å·¥å…·çš„è¾“å‡ºï¼›

ä¸Šé¢è¿‡ç¨‹ä¹Ÿæ˜¯ä¼šä¸æ–­å¾ªç¯å¾€å¤ï¼Œç›´åˆ°æ»¡è¶³ query çš„è¯·æ±‚ï¼Œæˆ–è€…è¾¾åˆ°äº†æœ€å¤§çš„è¿­ä»£æ¬¡æ•°ã€‚

![image.png](18_images/img6.png)

ReactAgent æ‰§è¡Œæµç¨‹å’Œ FunctionCallAgent çš„æ‰§è¡Œæµç¨‹ä¸€æ ·ï¼Œå”¯ä¸€åŒºåˆ«æ˜¯ prompt ä¸åŒï¼Œå¹¶ä¸” ReactAgent æ¯ä¸€æ­¥éƒ½è¦æœ‰ Thought è¾“å‡ºï¼Œè€Œæ™®é€š FunctionCallAgent å¯èƒ½åªæœ‰å·¥å…·è°ƒç”¨çš„ä¿¡æ¯è¾“å‡ºï¼Œæ²¡æœ‰ content å†…å®¹ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š

```python
import lazyllm
from lazyllm.tools import fc_register, ReactAgent
@fc_register("tool")
def multiply_tool(a: int, b: int) -> int:
    return a * b
@fc_register("tool")
def add_tool(a: int, b: int):
    return a + b
tools = ["multiply_tool", "add_tool"]
llm = lazyllm.OnlineChatModule(source="sensenova", model="DeepSeek-V3")
agent = ReactAgent(llm, tools)
query = "What is 20+(2*4)? Calculate step by step."
res = agent(query)
print(res)
```

![image.png](18_images/img7.png)

##### PlanAndSolve

PlanAndSolve ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹çš„æµç¨‹ï¼š

1. è®¡åˆ’ï¼ˆPlanï¼‰ï¼šAgent åœ¨æ”¶åˆ° query åï¼Œå®ƒä¼šå°†è¿™ä¸ªä»»åŠ¡åˆ†è§£ä¸ºæ›´å°çš„å­ä»»åŠ¡ï¼›
2. è¡ŒåŠ¨ï¼ˆActionï¼‰: Agent å¯¹å½“å‰çš„å­ä»»åŠ¡è¿›è¡Œæ‰§è¡Œï¼›
3. è§‚å¯Ÿï¼ˆObservationï¼‰: Agent è§‚å¯Ÿå½“å‰è¡ŒåŠ¨çš„ç»“æœï¼Œå¦‚æœè§£å†³é—®é¢˜å°±è¿”å›ï¼Œå¦‚æœä»…è§£å†³å½“å‰å­ä»»åŠ¡å°±ç»§ç»­æ‰§è¡Œè®¡åˆ’ï¼Œå¦‚æœæ²¡è§£å†³å½“å‰å­ä»»åŠ¡å°±é‡æ–°è®¡åˆ’åç»­æ­¥éª¤ï¼›

![image.png](18_images/img8.png)

\* æ³¨æ„ï¼š ä¸Šå›¾ä¸­ â‘¡ Action x1 è¡¨ç¤ºæ¯æ¬¡è¡ŒåŠ¨åªæ‰§è¡Œä¸€ä¸ªå­ä»»åŠ¡ï¼ˆä¸ä¼šå…¨éƒ¨å°†å­ä»»åŠ¡æ‰§è¡Œå®Œï¼ŒåŒºåˆ« ReWOOçš„å¯¹åº”æµç¨‹ä¸­çš„ â‘¡ Action xNï¼‰ã€‚

PlanAndSolveAgentç”±ä¸¤ä¸ªç»„ä»¶ç»„æˆï¼šé¦–å…ˆï¼Œå°†æ•´ä¸ªä»»åŠ¡åˆ†è§£ä¸ºæ›´å°çš„å­ä»»åŠ¡ï¼Œå…¶æ¬¡ï¼Œæ ¹æ®è®¡åˆ’æ‰§è¡Œè¿™äº›å­ä»»åŠ¡ã€‚æœ€åç»“æœä½œä¸ºç­”æ¡ˆè¿›è¡Œè¾“å‡ºã€‚

```python
import lazyllm
from lazyllm.tools import fc_register, PlanAndSolveAgent
@fc_register("tool")
def multiply(a: int, b: int) -> int:
    return a * b
@fc_register("tool")
def add(a: int, b: int):
    return a + b
llm = lazyllm.OnlineChatModule(source="sensenova", model="DeepSeek-V3")
tools = ["multiply", "add"]
agent = PlanAndSolveAgent(llm, tools=tools)
query = "What is 20+(2*4)? Calculate step by step."
ret = agent(query)
print(ret)
```

![image.png](18_images/img9.png)

##### ReWOO

ReWOO (Reasoning WithOut Observation) ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æµç¨‹ï¼š

1. è®¡åˆ’ï¼ˆPlanï¼‰ï¼šAgent åœ¨æ”¶åˆ° query åï¼Œå®ƒä¼šç”Ÿæˆä¸€ä¸ªè®¡åˆ’è¡¨ï¼Œè®¡åˆ’è¡¨ä¸­åŒ…å«äº†è¿™ä¸ªä»»åŠ¡åˆ†è§£çš„æ›´å°å­ä»»åŠ¡ï¼Œå­ä»»åŠ¡é—´çš„æ‰§è¡Œç»“æœç”¨å ä½ç¬¦è¡¨ç¤ºï¼›
2. è¡ŒåŠ¨ï¼ˆActionï¼‰: Agent å¯¹æ¯ä¸ªå­ä»»åŠ¡ä¾æ¬¡è¿›è¡Œæ‰§è¡Œï¼ˆè°ƒç”¨å·¥å…·ï¼‰ï¼Œå°†ç»“æœéƒ½å¡«å…¥è®¡åˆ’è¡¨çš„å ä½ç¬¦ä¸­ï¼›
3. è§£å†³ï¼ˆSolveï¼‰: Agent è§‚å¯Ÿæ‰€æœ‰è¡ŒåŠ¨çš„åé¦ˆï¼Œå°†ç»“æœresponseè¿”å›ç»™ç”¨æˆ·ï¼›

![image.png](18_images/img10.png)

ReWOOAgent åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼šPlanner ã€ Worker å’Œ Solverã€‚å…¶ä¸­ï¼Œ Planner ä½¿ç”¨å¯é¢„è§æ¨ç†èƒ½åŠ›ä¸ºå¤æ‚ä»»åŠ¡åˆ›å»ºè§£å†³æ–¹æ¡ˆè“å›¾ï¼› Worker é€šè¿‡å·¥å…·è°ƒç”¨æ¥ä¸ç¯å¢ƒäº¤äº’ï¼Œå¹¶å°†å®é™…è¯æ®æˆ–è§‚å¯Ÿç»“æœå¡«å……åˆ°æŒ‡ä»¤ä¸­ï¼› Solver å¤„ç†æ‰€æœ‰è®¡åˆ’å’Œè¯æ®ä»¥åˆ¶å®šåŸå§‹ä»»åŠ¡æˆ–é—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚

```python
import lazyllm
from lazyllm import fc_register, ReWOOAgent, deploy
import wikipedia
@fc_register("tool")
def WikipediaWorker(input: str):
    try:
        evidence = wikipedia.page(input).content
        evidence = evidence.split("\n\n")[0]
    except wikipedia.PageError:
        evidence = f"Could not find [{input}]. Similar: {wikipedia.search(input)}"
    except wikipedia.DisambiguationError:
        evidence = f"Could not find [{input}]. Similar: {wikipedia.search(input)}"
    return evidence
@fc_register("tool")
def LLMWorker(input: str):
    llm = lazyllm.OnlineChatModule(stream=False)
    query = f"Respond in short directly with no extra words.\n\n{input}"
    response = llm(query, llm_chat_history=[])
    return response
tools = ["WikipediaWorker", "LLMWorker"]
llm = lazyllm.TrainableModule("Qwen2-72B-Instruct-AWQ").deploy_method(deploy.vllm).start()
agent = ReWOOAgent(llm, tools=tools)
query = "What is the name of the cognac house that makes the main ingredient in The Hennchata?"
ret = agent(query)
print(ret)
```

![image.png](18_images/img11.png)

è®©æˆ‘ä»¬ç®€å•æ€»ç»“å¦‚ä¸‹ï¼š

|  | Function Call Agent | ReAct | PlanAndSolve | ReWOO |
| --- | --- | --- | --- | --- |
| å·¥ä½œæµç¨‹ | æœ€å¤§å¾ªç¯æ¬¡æ•°å†…å¾ªç¯ï¼š<br><br> - è¯•å‚è°ƒç”¨å·¥å…·ï¼›<br> - è§‚å¯Ÿå·¥å…·è¾“å‡ºï¼Œå®Œæˆä»»åŠ¡å°±ç»“æŸå¾ªç¯ã€‚ | æœ€å¤§å¾ªç¯æ¬¡æ•°å†…å¾ªç¯ï¼š<br><br> - æ€è€ƒï¼›<br> - è¯•å‚è°ƒç”¨å·¥å…·ï¼›<br> - è§‚å¯Ÿå·¥å…·è¾“å‡ºï¼Œå®Œæˆä»»åŠ¡å°±ç»“æŸå¾ªç¯ã€‚ | æœ€å¤§å¾ªç¯æ¬¡æ•°å†…å¾ªç¯ï¼š<br><br> - ï¼ˆé‡ï¼‰è®¡åˆ’å¹¶åˆ†è§£ä»»åŠ¡ï¼›<br> - è°ƒç”¨å·¥å…·è§£å†³å½“å‰å­ä»»åŠ¡ï¼›<br> - è§‚å¯Ÿå·¥å…·è¾“å‡ºï¼Œç¡®å®šæ˜¯å¦å®Œæˆå­ä»»åŠ¡ï¼Œå®Œæˆæ•´ä¸ªä»»åŠ¡å°±ç»“æŸå¾ªç¯ |  - è®¡åˆ’å¹¶åˆ†è§£ä»»åŠ¡ï¼›<br> - è°ƒç”¨å·¥å…·é€æ­¥è§£å†³æ‰€æœ‰å­ä»»åŠ¡<br> - ç»¼åˆæ‰€æœ‰æ­¥éª¤ç»“æœè¿›è¡Œåé¦ˆ |
| å·¥ä½œç‰¹ç‚¹ | ç®€å•ç›´æ¥ï¼Œæ€è€ƒè¿‡ç¨‹ä¸å¯è§ | å¼•å…¥æ€è€ƒç¯èŠ‚ï¼Œæ€è€ƒå¯è§ | å¼ºè°ƒä»»åŠ¡çš„åˆ†è§£å’Œä»»åŠ¡çš„åŠ¨æ€è°ƒæ•´ | å¼ºè°ƒæ•´ä½“è§„åˆ’å’Œç»¼åˆåé¦ˆ |

#### ç®€åŒ–Agentå·¥ä½œæµç¨‹

åœ¨Agentå¼€å‘ä¸­ï¼Œé‡å¤é€ è½®å­ã€å·¥å…·æ¥å£ä¸ç»Ÿä¸€ã€ä¸Šä¸‹æ–‡ç®¡ç†å¤æ‚ç­‰é—®é¢˜è®©å¼€å‘æµç¨‹å†—é•¿ä¸”ä½æ•ˆã€‚ä¸ºäº†è§£å†³è¿™äº›éš¾ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡â€œâ€‹**MCPåè®®**â€‹+**â€‹LazyLLMâ€â€‹**çš„æ¡†æ¶ï¼Œæå‡å¼€å‘æ•ˆç‡ã€é™ä½é—¨æ§›ï¼Œè®©å¼€å‘è€…èƒ½ä¸“æ³¨äºæ ¸å¿ƒä¸šåŠ¡å’Œåˆ›æ–°è®¾è®¡ï¼Œä»è€Œæ¨åŠ¨å¤§æ¨¡å‹åº”ç”¨æ›´å¿«è½åœ°ã€‚

##### **MCPåè®®çš„åŸºæœ¬æ¦‚å¿µ**

**â€‹MCPï¼ˆModel Context Protocolï¼Œæ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼‰â€‹**æ˜¯ç”±Anthropicå…¬å¸äº2024å¹´11æœˆæ¨å‡ºçš„ä¸€ç§â€‹**å¼€æ”¾æ ‡å‡†åè®®**â€‹ï¼Œæ—¨åœ¨è®©å¤§è¯­è¨€æ¨¡å‹èƒ½å¤Ÿâ€œæ— ç¼è¿æ¥â€å¤–éƒ¨å·¥å…·å’Œæ•°æ®æºã€‚

ç®€å•æ¥è¯´ï¼ŒMCPå°±æ˜¯ä¸ºäº†è§£å†³å¼€å¤´é‚£äº›ç—›ç‚¹è€Œç”Ÿçš„â€œæ ‡å‡†åŒ–åˆ©å™¨â€ã€‚ä¸€ä¸ªæ›´å½¢è±¡çš„æ¯”å–»æ˜¯ï¼šâ€‹**MCP ç›¸å½“äº AI åº”ç”¨çš„USB-Cæ¥å£**â€‹ã€‚

æ­£å¦‚USB-Cç»Ÿä¸€äº†ä¸åŒå“ç‰Œç”µå­è®¾å¤‡çš„å……ç”µå’Œæ•°æ®æ¥å£ä¸€æ ·ï¼ŒMCPåˆ™æ ‡å‡†åŒ–äº†â€‹**AIä¸å¤–éƒ¨ä¸–ç•Œäº¤äº’çš„æ–¹å¼**â€‹ï¼Œä½¿å¾—æ¨¡å‹èƒ½å¤Ÿä»¥**æ ‡å‡†åŒ–**çš„å½¢å¼**é«˜æ•ˆè°ƒç”¨**æ•°æ®åº“ã€å·¥å…·å’Œç½‘ç»œæœç´¢ç­‰å¤šç§èµ„æºï¼Œä»è€Œå®ç°â€‹**æ¨¡å‹ä¸å¤–éƒ¨ç³»ç»Ÿçš„é«˜æ•ˆè”åŠ¨**â€‹ã€‚

æ¢å¥è¯è¯´ï¼Œè¿‡å»æ¯æ¥å…¥ä¸€ä¸ªæ–°å·¥å…·å°±å¤´å¤§çš„â€œæ¥å£ä¸ç»Ÿä¸€â€é—®é¢˜ï¼Œæœ‰äº†MCPåå°±åƒä½¿ç”¨ç»Ÿä¸€æ¥å£çš„å¤–è®¾ä¸€æ ·ï¼Œâ€‹**æ’ä¸Šå°±èƒ½ç”¨**â€‹ã€‚è¿™æ ·ä¸€æ¥ï¼Œâ€‹**æ— éœ€äºŒæ¬¡å¼€å‘**â€‹ï¼Œå¤šç§æ•°æ®åº“ã€Web APIã€æ–‡ä»¶ç³»ç»Ÿã€GitHubâ€¦æµ·é‡è€Œå¼ºå¤§çš„åŠŸèƒ½ç»Ÿç»Ÿéƒ½å¯ä»¥é€šè¿‡è¿™ä¸€ä¸ªåè®®â€‹**è½»æ¾æ¥å…¥**â€‹ã€‚

![image.png](18_images/img12.png)

ä»¥å‰ï¼Œæƒ³è®©AI AgentæŸ¥å¤©æ°”ã€è¯»PDFã€æ‰§è¡ŒPythonä»£ç ï¼Œå¯èƒ½éœ€è¦é’ˆå¯¹æ¯ä¸ªåŠŸèƒ½å†™ä¸€å †é›†æˆä»£ç ï¼Œå…¶ä¸­åŒ…å«å·¥å…·çš„æè¿°ã€å…¥å‚ç­‰ç­‰ï¼Œå¹¶å°è£…æˆâ€œå·¥å…·ï¼ˆToolï¼‰â€ç»™åˆ°æ¨¡å‹ï¼›è€Œæœ‰äº†MCPï¼Œåªéœ€è¦æŠŠç¬¦åˆéœ€æ±‚çš„MCPæœåŠ¡å™¨æ¥ä¸Šï¼Œæ¨¡å‹å°±ä¼šè‡ªåŠ¨çŸ¥é“æœ‰ä»€ä¹ˆå·¥å…·å¯ç”¨ã€è¯¥å¦‚ä½•è°ƒç”¨ï¼Œå¹¶ä¸”è¾“å…¥è¾“å‡ºæ ¼å¼ä¹Ÿæ˜¯ç»Ÿä¸€å¥½çš„ã€‚

![image.png](18_images/img13.png)

æ•´ä¸ªè¿‡ç¨‹å°±åƒç»™ç¬”è®°æœ¬ç”µè„‘æ’ä¸Š**æ‰©å±•åçš„**ç¬é—´ï¼Œé¢å¤–å†’å‡ºHDMIã€SDå¡ã€ç½‘çº¿ç­‰æ¥å£ç­‰**ç¹ççš„å¯¹æ¥ç»†èŠ‚**ç”±åè®®å¸®ä½ æå®šï¼Œä»æ­¤å¼€å‘è€…æ— éœ€å…³å¿ƒé‚£äº›è½¬æ¢è¿‡ç¨‹ã€‚å› æ­¤ï¼ŒMCPçš„å‡ºç°**å¤§å¹…æå‡äº†AI Agentåº”ç”¨å¼€å‘çš„æ•ˆç‡ã€‚**

##### MCPçš„æŠ€æœ¯æ¶æ„

ä»æŠ€æœ¯æ¶æ„ä¸Šçœ‹ï¼ŒMCPéµå¾ªçš„æ˜¯å…¸å‹çš„â€‹**å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å‹**â€‹ï¼Œå®ƒæŠŠAIåº”ç”¨çš„**å†…éƒ¨é€»è¾‘å’Œå¤–éƒ¨æ‰©å±•åŠŸèƒ½è§£è€¦**ä¸ºä¸‰ä¸ªæ ¸å¿ƒæ¨¡å—ï¼š

![image.png](18_images/img14.png)

**1. Hostï¼ˆä¸»æœºï¼‰**

æŒ‡è¿è¡ŒAIåº”ç”¨ï¼ˆç±»ä¼¼æ”¯æŒAIå¯¹è¯çš„IDEæ’ä»¶å¦‚Cursorã€æ¡Œé¢åº”ç”¨å¦‚Claude Desktopä»¥åŠæˆ‘ä»¬æ‰€åˆ›å»ºçš„æ™ºèƒ½ä½“åº”ç”¨ï¼‰æœ¬èº«çš„â€‹**å®¿ä¸»ç¯å¢ƒ**â€‹ã€‚Hostè´Ÿè´£â€‹**æä¾›AIäº¤äº’ç¯å¢ƒ**â€‹ï¼Œå¹¶åœ¨å†…éƒ¨â€‹**å¯åŠ¨MCP Client**â€‹ã€‚

**2. Clientï¼ˆå®¢æˆ·ç«¯ï¼‰**

è¿è¡Œåœ¨Hostå†…éƒ¨çš„å®¢æˆ·ç«¯ï¼Œå®ƒä¸MCP Serverå»ºç«‹è¿æ¥ï¼Œå……å½“AIåº”ç”¨å’Œå¤–éƒ¨ä¸–ç•Œæ²Ÿé€šçš„â€‹**æ¡¥æ¢**â€‹ã€‚MCPå®¢æˆ·ç«¯ç»´æŒä¸æœåŠ¡å™¨çš„ 1:1 è¿æ¥ï¼Œå½“AIæ¨¡å‹éœ€è¦è°ƒç”¨å·¥å…·æˆ–è·å–æ•°æ®æ—¶ï¼Œéƒ½æ˜¯ç”±ClientæŒ‰ç…§åè®®ä¸Serveré€šä¿¡æ¥å®Œæˆã€‚

**3. Serverï¼ˆæœåŠ¡å™¨ï¼‰**

MCPæœåŠ¡å™¨æä¾›å…·ä½“çš„åŠŸèƒ½å’Œæ•°æ®ï¼Œç›¸å½“äºAIå¤§è„‘å¯ä»¥è¿œç¨‹è°ƒç”¨çš„â€‹**å¤–è®¾**â€‹ã€‚ä¸€ä¸ªæœåŠ¡å™¨ä¸Šé€šå¸¸ä¼šæš´éœ²å‡ ç±»å†…å®¹ä¾›AIä½¿ç”¨ï¼š

* Toolsï¼ˆå·¥å…·ï¼‰ï¼šå…è®¸å¤§æ¨¡å‹è°ƒç”¨çš„åŠŸèƒ½å‡½æ•°ã€‚ä¾‹å¦‚ä»£ç æ‰§è¡Œã€ç½‘é¡µæµè§ˆã€å‘é€é‚®ä»¶ç­‰ï¼Œè¿™äº›èƒ½åŠ›éƒ½å¯ä»¥ä½œä¸ºå¯è°ƒç”¨çš„å·¥å…·ç”±Serveræ‰“åŒ…å¹¶æä¾›ç»™AIã€‚
* Resourcesï¼ˆèµ„æºï¼‰ï¼šç»™å¤§æ¨¡å‹æä¾›çš„æ•°æ®æˆ–å†…å®¹ã€‚ä¾‹å¦‚æ•°æ®åº“è®°å½•ã€æ–‡ä»¶å†…å®¹ã€æµè§ˆç½‘é¡µæˆªå›¾ç­‰ï¼ŒServerå¯ä»¥å°†è¿™äº›å¤–éƒ¨æ•°æ®é€šè¿‡åè®®å‘é€ç»™AIåº”ç”¨ï¼Œä»¥å……å½“LLMçš„ä¸Šä¸‹æ–‡ã€‚
* Promptsï¼ˆæç¤ºæ¨¡æ¿ï¼‰ï¼šé¢„è®¾çš„å¯å¤ç”¨æç¤ºè¯æ¨¡æ¿æˆ–äº¤äº’å·¥ä½œæµã€‚Serverå¯ä»¥å‚¨å­˜ä¸€äº›å¸¸ç”¨æç¤ºè¯ï¼ŒæŒ‰éœ€æä¾›ç»™AIï¼Œé¿å…æ¯æ¬¡éƒ½ä»é›¶ç¼–å†™å¤æ‚æç¤ºã€‚

æ›´å¤šMCPæŠ€æœ¯æ¶æ„çš„ç»†èŠ‚å¯æŸ¥é˜…ï¼šhttps://modelcontextprotocol.io/docs/concepts/architecture

é€šè¿‡ä¸Šè¿°æ¶æ„ï¼Œè¿‡å»ä¸œæ‹¼è¥¿å‡‘è§£å†³çš„éš¾é¢˜ï¼Œç°åœ¨æœ‰äº†æ˜ç¡®çš„åè®®è§„èŒƒå¯å¾ªï¼Œé‚£ä¹ˆï¼ŒMCPã€Agentã€LLMã€Tool Call...è¿™äº›åè¯ä¹‹é—´åˆ°åº•æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ

* **LLM**æ˜¯Agentçš„â€‹**â€œå¤§è„‘â€**â€‹ï¼Œèƒ½å¤Ÿæ ¹æ®è¾“å…¥ä¿¡æ¯ï¼ˆå¦‚ç³»ç»Ÿæç¤ºè¯ã€ç”¨æˆ·æŒ‡ä»¤ã€å†å²å¯¹è¯ä¿¡æ¯ã€å¯ç”¨å·¥å…·é›†ä¿¡æ¯ç­‰ï¼‰ï¼Œè¾“å‡ºå¯¹åº”çš„æ–‡å­—å†…å®¹ï¼Œå…¶ä¸­å¯èƒ½æ˜¯é˜¶æ®µæ€§çš„å·¥å…·è°ƒç”¨ä¿¡æ¯ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ä»»åŠ¡å®Œæˆåçš„æœ€ç»ˆè¾“å‡ºå†…å®¹ã€‚
* **Tool Call**æ˜¯LLMç»è¿‡å¤§é‡è®­ç»ƒåå…·å¤‡çš„ä¸€ç§â€‹**å·¥å…·è°ƒç”¨èƒ½åŠ›**â€‹ï¼Œè¿™ç§èƒ½åŠ›å…è®¸LLMèƒ½å¤Ÿç»¼åˆå†å²ä¿¡æ¯å’Œå¯ç”¨å·¥å…·ä¿¡æ¯ï¼ŒåŠ¨æ€å†³ç­–å¹¶è¾“å‡ºæ ¼å¼åŒ–çš„å·¥å…·è°ƒç”¨æŒ‡ä»¤ï¼ˆå†³å®šä½¿ç”¨å“ªä¸ªå·¥å…·ã€å·¥å…·è°ƒç”¨æ—¶å…·ä½“ä¼ å…¥ä»€ä¹ˆå‚æ•°ï¼‰ï¼Œé€šè¿‡è¿™ç§æŒ‡ä»¤æŒ‡å¯¼Agentæ­£ç¡®çš„å®Œæˆå·¥å…·è°ƒç”¨ï¼Œä»è€Œå®ç°ç‰¹å®šåŠ¨ä½œï¼ˆå¦‚æ“ä½œæ–‡ä»¶ã€æ‰§è¡Œä»£ç ï¼‰ã€è·å–å¿…è¦ä¿¡æ¯ï¼ˆå¦‚è¿”å›ç½‘é¡µçˆ¬è™«ç»“æœï¼‰ã€‚
* **MCP Server**åˆ™æ˜¯éµå¾ªMCPåè®®çš„â€‹**å·¥å…·ä¾›åº”å•†**â€‹ï¼Œå…¶æä¾›ç»™Agentå¼ºå¤§çš„å·¥å…·é›†ï¼Œä»¥ä¾›LLMè¾¨è¯†å¹¶æ‰§è¡ŒTool Callï¼ŒåŒæ—¶æ¥æ”¶Agentç»™åˆ°çš„Tool CallæŒ‡ä»¤å®‰å…¨çš„ä¸å¤–éƒ¨èµ„æºè¿›è¡Œäº¤äº’ï¼Œä»¥å®ç°ç‰¹å®šåŠ¨ä½œæˆ–è¿”å›ç‰¹å®šä¿¡æ¯ã€‚
* **Agent**ä½œä¸ºæ™ºèƒ½ä½“åº”ç”¨ä¸ç”¨æˆ·äº¤äº’çš„â€‹**å”¯ä¸€å…¥å£**â€‹ï¼Œåœ¨æ¥æ”¶åˆ°ä»»åŠ¡æŒ‡ä»¤åï¼Œä¼šæœ‰åºåœ°è°ƒç”¨LLMã€å„ç§å·¥å…·ï¼Œä»¥å®Œæˆä»»åŠ¡ã€‚

##### å®è·µï¼šåœ¨LazyLLMä¸­ä½¿ç”¨MCP

é’ˆå¯¹MCPï¼ŒLazyLLMæä¾›äº†ä¸¤ç§æ¥å…¥æ–¹å¼ï¼š**ç›´æ¥æ¥å…¥**å’Œâ€‹**éƒ¨ç½²å¹¶è¿œç¨‹æ¥å…¥**â€‹ã€‚

* **â€‹ç›´æ¥æ¥å…¥ï¼šâ€‹**å°†æŒ‡å®šMCP Serverçš„å¯åŠ¨é…ç½®ç›´æ¥ç»™åˆ°lazyllm.tools.MCPClientï¼Œä»¥Stdioæ¨¡å¼å¯åŠ¨Serverï¼Œå¹¶è·å–Agentå¯è°ƒç”¨çš„å·¥å…·é›†ã€‚
* **â€‹éƒ¨ç½²å¹¶è¿œç¨‹æ¥å…¥ï¼šâ€‹**é’ˆå¯¹ä¸€äº›èµ„æºå ç”¨é«˜ï¼Œæˆ–è€…æœŸæœ›å¯åŠ¨çš„MCP Serverå¯å¤ç”¨çš„åœºæ™¯ï¼ŒLazyLLMæ”¯æŒMCP Serverçš„ä¸€é”®éƒ¨ç½²ï¼Œåªéœ€ä¸€è¡Œå‘½ä»¤ï¼Œä¾¿å¯ä»¥å°†MCP Serverå•ç‹¬å¯åŠ¨ï¼Œéšåä¾¿å¯ä»¥SSEæ¨¡å¼è¿œç¨‹æ¥å…¥MCP Serverã€‚

å…·ä½“æ¥è¯´ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š

1.é…ç½®LazyLLMæ‰€éœ€è¦çš„æ‰€æœ‰ä¾èµ–

é¦–å…ˆå‚è€ƒhttps://docs.lazyllm.ai/zh-cn/latest/ çš„Getting startedéƒ¨åˆ†ï¼Œå®‰è£…LazyLLMå¹¶å®Œæˆç¯å¢ƒé…ç½®ã€‚

åŒæ—¶ï¼Œç”±äºMCP Serverçš„ä½¿ç”¨ä¾èµ–Node.jså’Œnpmï¼Œå¯å‚è€ƒhttps://nodejs.org/en/download å®Œæˆæœ€æ–°ç‰ˆæœ¬çš„å®‰è£…å’Œé…ç½®ã€‚

2.åˆ©ç”¨å·²æœ‰çš„MCPæœåŠ¡

è‹¥éœ€æ¥å…¥å·²æœ‰çš„ MCP æœåŠ¡ï¼ˆå¦‚é«˜å¾·åœ°å›¾çš„åœ°ç†ä½ç½®æœåŠ¡ï¼‰ï¼Œå¯é€šè¿‡ LazyLLM çš„ MCPClient å·¥å…·ç›´æ¥è¿æ¥ï¼Œæ— éœ€è‡ªè¡Œéƒ¨ç½² Serverã€‚

SSE URL æ¥å…¥ï¼ˆä»¥é«˜å¾· MCP ä¸ºä¾‹ï¼‰ï¼š

æ— éœ€å¯åŠ¨æœ¬åœ° Serverï¼Œç›´æ¥é€šè¿‡æœåŠ¡æä¾›å•†æä¾›çš„ SSE é•¿è¿æ¥ URL é…ç½® Clientã€‚éœ€å°†â€xxxâ€æ›¿æ¢ä¸ºè‡ªå·±çš„keyã€‚

ï¼ˆåˆ›å»ºkeyï¼šhttps://lbs.amap.com/api/mcp-server/create-project-and-keyï¼‰

```python
import lazyllm
from lazyllm.tools.agent import ReactAgent
from lazyllm.tools import MCPClient
mcp_configs = {
    "amap_mcp": {
        "url": "http://mcp.amap.com/sse?key=xxx"
    }
}
client = MCPClient(command_or_url=mcp_configs["amap_mcp"]["url"])
llm = lazyllm.OnlineChatModule(source='qwen', model='qwen-max-latest', stream=False)
agent = ReactAgent(llm=llm.share(), tools=client.get_tools(), max_retries=15)
print(agent("æŸ¥è¯¢åŒ—äº¬çš„å¤©æ°”"))
```

![image.png](18_images/img15.png)

3.ä½¿ç”¨**ç›´æ¥æ¥å…¥**çš„æ–¹å¼è°ƒç”¨MCP

  - é…ç½®è·å–

  æˆ‘ä»¬é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ç®¡ç† MCP Server å¹¶è·å–å¯åŠ¨é…ç½®ï¼š

```python

{  
    "mcpServers": {    
        "filesystem": {     
            "command": "npx",      
            "args": [        
                "-y",        
                "@modelcontextprotocol/server-filesystem",        
                "/Users/username/Desktop"      
            ]    
        }  
    }
}

```

  æ³¨æ„ï¼Œå¦‚æœä½ æ˜¯Windowsç³»ç»Ÿï¼Œcommandéœ€è¦ä½¿ç”¨"cmd"ï¼ŒåŒæ—¶å¯åŠ¨å‚æ•°å¼€å¤´éœ€è¦åŠ ä¸Š"/c"ã€‚å¯åŠ¨é…ç½®ä¼šæœ‰äº›å˜åŒ–ï¼š

```python

{  
    "mcpServers": {    
        "filesystem": {     
            "command": "cmd",      
            "args": [
                "/c", 
                "npx",         
                "-y",        
                "@modelcontextprotocol/server-filesystem",        
                "/Users/username/Desktop"      
            ]    
        }  
    }
}

```

  - MCPæ¥å…¥

  éšåä¾¿å¯ä½¿ç”¨LazyLLMçš„MCPClientå·¥å…·å®ç°MCP Serverçš„æ¥å…¥ï¼ˆè¿™é‡Œçš„è·¯å¾„ç¤ºä¾‹/xxx/xxx/xxxï¼‰

```python
import lazyllm
from lazyllm.tools import MCPClient
config = {"command": "npx", "args": ["-y", "@modelcontextprotocol/server-filesystem", "/xxx/xxx/xxx"]}
client = MCPClient(command_or_url=config["command"], args=config["args"], env=config.get("env"))
```

  - å·¥å…·é›†è·å–

```bash
>>> tools = client.get_tools()
Secure MCP Filesystem Server running on stdio
Allowed directories: [ '/Users/username/Desktop' ]
>>> tools
[<function generate_lazyllm_tool.<locals>.dynamic_lazyllm_func at 0x7f269cad11c0>, <function generate_lazyllm_tool.<locals>.dynamic_lazyllm_func at 0x7f269c91e520>, <function generate_lazyllm_tool.<locals>.dynamic_lazyllm_func at 0x7f269c91d800>, <function generate_lazyllm_tool.<locals>.dynamic_lazyllm_func at 0x7f269c91d8a0>, <function generate_lazyllm_tool.<locals>.dynamic_lazyllm_func at 0x7f269c91e5c0>, <function generate_lazyllm_tool.<locals>.dynamic_lazyllm_func at 0x7f269c91e0c0>, <function generate_lazyllm_tool.<locals>.dynamic_lazyllm_func at 0x7f269c91d940>, <function generate_lazyllm_tool.<locals>.dynamic_lazyllm_func at 0x7f269c91e480>, <function generate_lazyllm_tool.<locals>.dynamic_lazyllm_func at 0x7f269c91db20>, <function generate_lazyllm_tool.<locals>.dynamic_lazyllm_func at 0x7f269c91da80>, <function generate_lazyllm_tool.<locals>.dynamic_lazyllm_func at 0x7f269c91dda0>]
```

  **ä»£ç è®²è§£**ï¼šè°ƒç”¨client.get_tools()å¯ä»¥è·å–å½“å‰è¿æ¥çš„MCP Serverä¸­æ‰€æœ‰çš„å·¥å…·ï¼ˆåœ¨å¼‚æ­¥ç¯å¢ƒä¸­ï¼Œä»¥ä¸‹ä»£ç æ”¹ä¸ºtools = await client.aget_tools()å³å¯ï¼‰ã€‚åŒæ—¶ï¼ŒLazyLLMæ”¯æŒå¼€å‘è€…é€šè¿‡ä¼ å…¥å·¥å…·åç§°åˆ—è¡¨è‡³æ–¹æ³•çš„æ–¹å¼è·å–ç‰¹å®šçš„å·¥å…·é›†ï¼Œä¾‹å¦‚client.get_tools(["tool_name1", "tool_name2"])ã€‚

  - å·¥å…·è°ƒç”¨

  **ä»£ç è®²è§£**ï¼šéå†ä»MCP Serverè·å–çš„toolsï¼Œå…¶ä¸­æ¯ä¸ªæˆå‘˜éƒ½æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚æ¯ä¸ªåŠŸèƒ½å‡½æ•°éƒ½æœ‰å‡½æ•°åï¼ˆ__name__ï¼‰ã€å‡½æ•°æè¿°ï¼ˆ__doc__ï¼ŒåŒ…å«äº†åŠŸèƒ½æä¸å‚æ•°æè¿°ï¼‰ä»¥åŠå…¥å‚å£°æ˜ï¼ˆ__annotations__ï¼‰ï¼Œè°ƒç”¨å¯¹åº”å‡½æ•°æ—¶ï¼Œåªéœ€è¦ä¼ å…¥æ­£ç¡®çš„å‚æ•°å³å¯ã€‚ä¸‹é¢ç»™å‡ºä¸¤ä¸ªå‡½æ•°è°ƒç”¨çš„ä¾‹å­ï¼š

  - è°ƒç”¨æ–‡ä»¶è¯»å–å·¥å…·read_fileï¼Œä¼ å…¥æ‰€éœ€å…¥å‚pathï¼Œå³å¯è·å–è¯»å–æ–‡ä»¶åçš„è¿”å›ä¿¡æ¯ï¼›

  - è°ƒç”¨è·å–æœ‰æƒé™è·¯å¾„å·¥å…·list_allowed_directoriesï¼Œè¯¥å·¥å…·æ— éœ€ä»»ä½•å…¥å‚ï¼Œä¼ å…¥ç©ºå³å¯è·å¾—å·¥å…·è¿”å›ã€‚

```json
>>> for t in tools:
...     print(f"\nTool name:\n{t.__name__}\nTool desc:\n{t.__doc__}\nTool params:\n{t.__annotations__}\n")
... 
Tool name:
read_file
Tool desc:
Read the complete contents of a file from the file system. Handles various text encodings and provides detailed error messages if the file cannot be read. Use this tool when you need to examine the contents of a single file. Only works within allowed directories.
Args:    
    path (str): type: string.
Tool params:
{'path': <class 'str'>}
Tool name:
write_file
Tool desc:
Create a new file or completely overwrite an existing file with new content. Use with caution as it will overwrite existing files without warning. Handles text content with proper encoding. Only works within allowed directories.
Args:    
    path (str): type: string.    
    content (str): type: string.
Tool params:
{'path': <class 'str'>, 'content': <class 'str'>}
......
Tool name:
list_allowed_directories
Tool desc:
Returns the list of directories that this server is allowed to access. Use this to understand which directories are available before trying to access files.
Args:    
    No parameters.
Tool params:
{}
```

```json
>>> t1 = tools[0]
>>> t1.__name__
'read_file'
>>> t1(path="xxx/xxx/xxx/test.md")
Secure MCP Filesystem Server running on stdio
Allowed directories: [ 'xxx/xxx/xxx' ]
'Tool call result:\nReceived text message:\nThis is a test file for LazyLLM and MCP.\n\nEnd\n'
>>> t2 = tools[-1]
>>> t2.__name__
'list_allowed_directories'
>>> t2()
Secure MCP Filesystem Server running on stdio
Allowed directories: [ 'xxx/xxx/xxx' ]
'Tool call result:\nReceived text message:\nAllowed directories:\n/xxx/xxx/xxx'
```

4.ä½¿ç”¨LazyLLMéƒ¨ç½²MCP Serverå¹¶æ¥å…¥

LazyLLMæ”¯æŒMCP Serverçš„ä¸€é”®éƒ¨ç½²ï¼Œåªéœ€ä¸€è¡Œå‘½ä»¤ï¼Œä¾¿å¯ä»¥å°†MCP Serverå•ç‹¬å¯åŠ¨ï¼Œä¸»ç¨‹åºå¯ä½¿ç”¨SSEæ¨¡å¼æ¥å…¥MCP Serverã€‚

* ä¸€é”®éƒ¨ç½²MCP Server
  
  é€‰æ‹©æµè§ˆå™¨å·¥å…· platwrightï¼ˆhttps://github.com/microsoft/playwright-mcp ï¼‰ï¼Œè·å–é…ç½®ä¿¡æ¯ï¼š

```python

{  
    "mcpServers": {    
        "playwright": {      
            "command": "npx",      
            "args": [        
                "@playwright/mcp@latest"     
            ]    
        }  
    }
}

```

åœ¨å‘½ä»¤è¡Œä¸­åªéœ€è¦ä½¿ç”¨â€œlazyllm deploy mcp\_server xxxxxxâ€å‘½ä»¤ï¼Œå¹¶é…ç½®hostã€portï¼Œå³å¯å®ŒæˆMCP Serverçš„éƒ¨ç½²ã€‚ç”±äºlinuxç¯å¢ƒæ²¡æœ‰GUIï¼Œè¿™é‡Œæ¼”ç¤ºWindowsç¯å¢ƒä¸‹çš„å¯åŠ¨å‘½ä»¤ï¼š

```bash
lazyllm deploy mcp_server --sse-port 11238 cmd -- /c npx @playwright/mcp@latest
```

å¯åŠ¨åå¦‚ä¸‹æ‰€ç¤ºï¼š

![image.png](18_images/img16.png)

* æ¥å…¥éƒ¨ç½²å®Œæˆçš„MCP Server
  
  æˆ‘ä»¬å¯ä»¥åœ¨å…¶ä»–ç¨‹åºä¸­ä¼ å…¥urlï¼Œä»¥SSEçš„æ–¹å¼æ¥å…¥MCP Serverï¼Œæ³¨æ„ï¼Œè¿™é‡Œçš„urléœ€è¦åŠ ä¸Š'/sse'ï¼Œå¦åˆ™æ— æ³•æ­£å¸¸è¿è¡Œï¼š

```bash
>>> config = {"url": "http://127.0.0.1:11238/sse"}
>>> client = MCPClient(command_or_url=config["url"])
```

ç”¨ä»¥ä¸Šæ–¹å¼æ¥å…¥MCP Serveråï¼Œå…·ä½“çš„å·¥å…·è·å–ã€å·¥å…·è°ƒç”¨æ–¹å¼ä¸ç›´æ¥æ¥å…¥ä¿æŒä¸€è‡´ã€‚

5.LazyLLMè°ƒç”¨MCPå·¥å…·

æ­¥éª¤ 1ï¼šè·å–å·¥å…·åˆ—è¡¨

```python
tools = client.get_tools()  # åŒæ­¥è·å–
# æˆ– tools = await client.aget_tools()  # å¼‚æ­¥ç¯å¢ƒ
```

æ­¥éª¤ 2ï¼šæŸ¥çœ‹å·¥å…·è¯¦æƒ…

```python
for t in tools:
    print(f"Tool name: {t.__name__}")
    print(f"Tool desc: {t.__doc__}")
    print(f"Tool params: {t.__annotations__}\n")
```

æ­¥éª¤ 3ï¼šè°ƒç”¨MCPå·¥å…·

ä»¥è¯»å–æ–‡ä»¶å·¥å…·ä¸ºä¾‹ï¼Œå‡è®¾ tools[0] ä¸º read\_file

```python
t1 = tools[0]
result = t1(path="xxx/xxx/xxx/test.md")
```

![image.png](18_images/img17.png)

6.LazyLLM+MCPæ™ºèƒ½ä½“Demo

æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨filesystem+playwrightï¼Œç»“åˆLazyLLMçš„Agentæ¨¡å—ï¼Œåˆ›å»ºä¸€ä¸ªæ™ºèƒ½ä½“ï¼š

```python
import lazyllm
import lazyllm.tools.agent 
from lazyllm.tools import ReactAgent
import MCPClient
if __name__ == "__main__":    
    mcp_configs = {        
        "file_system": {            
            "command": "cmd",            
            "args": [                
                "/c",                
                "npx",                
                "-y",                
                "@modelcontextprotocol/server-filesystem",                
                "./"            
            ]        
        },        
        "play_wright": {            
            "url": "http://127.0.0.1:11244/sse"        
        }    
    }    
client1 = MCPClient(command_or_url=mcp_configs["file_system"]["command"], args=mcp_configs["file_system"]["args"])    
client2 = MCPClient(command_or_url=mcp_configs["play_wright"]["url"])    
llm = lazyllm.OnlineChatModule(source="deepseek")    
agent = ReactAgent(llm=llm.share(), tools=client1.get_tools()+client2.get_tools(), max_retries=15)    
print(agent("æµè§ˆè°·æ­Œæ–°é—»ï¼Œå¹¶å†™ä¸€ä¸ªä»Šæ—¥æ–°é—»ç®€æŠ¥ï¼Œä»¥markdownæ ¼å¼ä¿å­˜è‡³æœ¬åœ°ã€‚"))
```

é€šè¿‡æœ¬æ¬¡å®è·µï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ï¼ŒMCP Serverçš„å‡ºç°ç›´æ¥çœå»äº†Agentå¼€å‘ç¯èŠ‚ä¸­å·¥å…·ç ”å‘å’Œè°ƒè¯•çš„æˆæœ¬ï¼Œâ€‹**å¤§å¤§æå‡äº†ç ”å‘æ•ˆç‡**â€‹ã€‚LazyLLMå¯¹äºMCPæä¾›äº†çµæ´»çš„æ¥å…¥æ–¹å¼ï¼Œè®©å¼€å‘è€…ä½¿ç”¨MCPçš„â€‹**æˆæœ¬å¤§å¤§é™ä½**â€‹ã€‚

æ€»ç»“ï¼šåœ¨å¤§æ¨¡å‹æ—¶ä»£ï¼Œâ€‹**å¼€å‘æ•ˆç‡å°±æ˜¯æ ¸å¿ƒç«äº‰åŠ›**â€‹ã€‚ä»å¤´é€ è½®å­æˆ–è®¸å¯ä»¥ç»ƒæ‰‹ï¼Œä½†åœ¨çœŸæ­£è½åœ°AIåº”ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ›´åº”è¯¥æŠŠå®è´µçš„æ—¶é—´å’Œè„‘åŠ›ï¼Œç•™ç»™çœŸæ­£åˆ›é€ ä»·å€¼çš„éƒ¨åˆ†â€”â€”å¦‚ä¸šåŠ¡é€»è¾‘è®¾è®¡ã€ç”¨æˆ·ä½“éªŒä¼˜åŒ–ã€åˆ›æ–°äº¤äº’æ–¹å¼ç­‰ï¼Œè€Œä¸æ˜¯é‡å¤é€ å·¥å…·ã€ä¸Šä¸‹æ–‡æ‹¼æ¥ç­‰åŸºç¡€ç»„ä»¶ã€‚

**MCP** æä¾›äº†ä¸€å¥—é«˜æ•ˆã€ç»Ÿä¸€çš„â€‹**æ ‡å‡†åè®®**â€‹ï¼›**LazyLLM** åˆ™æä¾›äº†ä¸€å¥—â€‹**çµæ´»çš„MCPæ¥å…¥æ–¹æ¡ˆ**â€‹ï¼Œè®©æ¯ä¸€ä¸ªå¼€å‘è€…éƒ½èƒ½è½»æ¾ä¸Šæ‰‹ï¼Œå¿«é€Ÿæ„å»ºå±äºè‡ªå·±çš„æ™ºèƒ½Agentåº”ç”¨ï¼Œä»è€Œç«™åœ¨**ç¤¾åŒºå’Œå¼€æºç”Ÿæ€**çš„â€œè‚©è†€â€ä¸Šçœ‹å¾—æ›´è¿œã€åšå¾—æ›´å¤šã€‚

## ç†æ€§çœ‹å¾… MCP

å°½ç®¡MCPç®€åŒ–äº†å¼€å‘æµç¨‹ï¼Œä½†éœ€æ³¨æ„å…¶å±€é™æ€§ï¼š

ä¾èµ–æ€§é£é™©ï¼šè¿‡åº¦ä¾èµ–ç¬¬ä¸‰æ–¹MCPæœåŠ¡å¯èƒ½å¯¼è‡´ä¸šåŠ¡å—åˆ¶äºå¤–éƒ¨ç¨³å®šæ€§ä¸æ”¿ç­–å˜åŒ–ã€‚

å·¥å…·é€‰æ‹©ï¼šMCPæ²¡æœ‰è§£å†³å½“å‰Agentçš„ä¸€ä¸ªå›°å¢ƒï¼šå½“å·¥å…·æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œå¦‚ä½•å¿«é€Ÿè€Œå‡†ç¡®åœ°é€‰åˆ°æœ€åˆé€‚çš„å·¥å…·ã€‚

å¼€å‘è€…åº”æ ¹æ®å®é™…éœ€æ±‚æƒè¡¡é€‰æ‹©ï¼Œä¼˜å…ˆåœ¨è½»é‡çº§åœºæ™¯ä¸­å°è¯•MCPï¼Œé€æ­¥éªŒè¯å…¶é€‚ç”¨æ€§

![image.png](18_images/img18.png)

### 3. Agentic RAG ç®€ä»‹

#### åŸºæœ¬æ¦‚å¿µ

Agentic RAG æ˜¯ RAG çš„ä¸€ç§æ‰©å±•ï¼Œå®ƒé€šè¿‡å¼•å…¥ AIæ™ºèƒ½ä½“ æ¥å¢å¼º RAG çš„åŠŸèƒ½ï¼Œä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿæ‰§è¡Œæ›´å¤æ‚çš„ä»»åŠ¡ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœè¯´ RAG æ˜¯å¸¦ç€**ä¹¦æœ¬**å»è€ƒè¯•çš„è€ƒç”Ÿï¼ŒAI Agent æ˜¯â€‹**ä¸“å®¶**â€‹ï¼Œé‚£ä¹ˆ Agentic RAG å°±æ˜¯å¸¦ç€**ä¸“å®¶**å»è€ƒè¯•çš„è€ƒç”Ÿï¼

ç®€å•æ¥çœ‹ï¼Œä¸‹å›¾ä¸­ï¼Œå•ä¸ª LLM å°±å¥½æ¯”ä¸€ä¸ªå»å‚åŠ é—­å·è€ƒçš„å­¦ç”Ÿï¼›æˆ‘ä»¬ç»™è¿™ä¸ªå­¦ç”Ÿå¸¦æœ¬ä¹¦ï¼Œé‚£ä¹ˆå°±å¯ä»¥è·å¾—ä¸€ä¸ªRAGï¼›å¦‚æœæˆ‘ä»¬æŠŠä¹¦æ›¿æ¢ä¸ºä¸“å®¶ï¼Œé‚£æˆ‘ä»¬å°±è·å¾—äº†ä¸€ä¸ª Agentic RAGã€‚

![image.png](18_images/img19.png)

#### åŸºæœ¬æ¶æ„

Agentic RAG å°±æ˜¯å¼•å…¥äº† AIæ™ºèƒ½ä½“çš„ RAGã€‚å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°† RAG çš„æœç´¢ç»„ä»¶ï¼ˆRetrival Componentï¼‰ç»™æ›¿æ¢ä¸ºäº†å•AIæ™ºèƒ½ä½“ã€‚é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬è¿˜å¯ä»¥å°†æœç´¢ç»„ä»¶ç»™æ›¿æ¢ä¸ºå¤šAIæ™ºèƒ½ä½“ï¼Œç”šè‡³ä¹Ÿå¯ä»¥æŠŠç”Ÿæˆç»„ä»¶ï¼ˆGenerative Componentï¼‰ç»™æ›¿æ¢ä¸º AI æ™ºèƒ½ä½“ã€‚

##### å•Agent RAG

ä¸‹é¢æ˜¯ä¸€ä¸ªå¸¸è§çš„ Agentic RAGï¼Œå…¶ä¸­çš„ AI Agent æ¨¡å—æä¾›äº†ä¸¤ä¸ªå¤–æŒ‚çŸ¥è¯†åº“ã€ä¸€ä¸ªç½‘ç»œæœç´¢å·¥å…·ã€ä¸€ä¸ªè®¡ç®—å™¨å’Œä¸€ä¸ªæ•°æ®åº“ï¼Œè¿™æ ·æ™ºèƒ½ä½“å¯ä»¥æ ¹æ®ä¸Šä¸‹æ–‡çš„éœ€æ±‚æ¥å†³å®šä»å“ªé‡Œæ¥æ£€ç´¢ä¿¡æ¯ã€‚å¹¶ä¸”å¦‚æœåœ¨ä¸€è½®æ£€ç´¢ä¸­ä¸èƒ½è·å¾—æ»¡æ„çš„ä¿¡æ¯ï¼Œæ™ºèƒ½ä½“è¿˜å¯ä»¥å†æ¬¡é‡æ–°æ£€ç´¢ï¼ˆå®ƒå¯ä»¥è‡ªåŠ¨æ›´æ¢æ£€ç´¢çš„å…³é”®è¯ï¼Œé€‰å–ä¸åŒçš„å·¥å…·ç­‰ç­‰ï¼‰ã€‚

![image.png](18_images/img20.png)

åœ¨ Agentic RAG ä¸­ï¼Œå¯ä»¥å°† AI æ™ºèƒ½ä½“èå…¥æ£€ç´¢ç»„ä»¶ï¼Œå½¢æˆ Retrieval Agentã€‚æ£€ç´¢è¿‡ç¨‹å˜å¾—æ™ºèƒ½ï¼Œæ™ºèƒ½ä½“èƒ½æ ¹æ® query å¾ªç¯æ£€ç´¢ï¼ŒåŠ¨æ€ä¼˜åŒ–ç»“æœã€‚åŒæ—¶ï¼Œæ™ºèƒ½ä½“å¯æ¥å…¥ç½‘ç»œã€æ•°æ®åº“ç­‰å¤šç§å·¥å…·ï¼Œçªç ´å•ä¸€çŸ¥è¯†åº“é™åˆ¶ï¼Œè·å–æ›´ä¸°å¯Œã€å‡†ç¡®çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚

å•Agent RAGçš„å·¥ä½œæµç¨‹å¯ä»¥æ‹†è§£ä¸ºï¼š

ç”¨æˆ·è¾“å…¥Query â†’ AgentåŠ¨æ€è§„åˆ’æ£€ç´¢ç­–ç•¥

å¤šæ¬¡æ£€ç´¢ï¼ˆæ›´æ¢å…³é”®è¯/å·¥å…·ï¼‰â†’ å¤šæºæ•°æ®èåˆ

ç»“æœå¢å¼º â†’ LLMç”Ÿæˆå›å¤

å¼•å…¥æ™ºèƒ½ä½“åï¼ŒæŸ¥è¯¢è¿‡ç¨‹å®ç°è‡ªåŠ¨åŒ–ä¸æ™ºèƒ½åŒ–ï¼Œç³»ç»Ÿå¯è‡ªä¸»å¤šè½®æ£€ç´¢ï¼Œæ— éœ€äººå·¥å¹²é¢„å³å¯æå‡ä¿¡æ¯åŒ¹é…æ•ˆæœã€‚

##### å¤šAgent RAG

æˆ‘ä»¬è¿˜å¯ä»¥å¼•è¿›ä¸“å®¶ç»„ï¼æ˜¯çš„å°±æ˜¯å¤šAgentæ™ºèƒ½ä½“ï¼Œä¸‹å›¾ä¸­ Retrival Agent A ä¸“å®¶è´Ÿè´£ä¸¤ä¸ªçŸ¥è¯†åº“çš„æ£€ç´¢ï¼ŒRetrival Agent B ä¸“å®¶è´Ÿè´£ç½‘ç»œæœç´¢ï¼ŒRetrival Agent C ä¸“å®¶è´Ÿè´£ä¸¤ä¸ªæ•°æ®åº“çš„æœç´¢ï¼Œä»–ä»¬éƒ½æ˜¯å„ä¸ªæ•°æ®æºçš„æœç´¢ä¸“å®¶ï¼Œæœ€åæœ‰ä¸€ä¸ªRetrival Agent ä¸“å®¶ä½œä¸ºæ€»æŒ‡æŒ¥ï¼Œä»–æ“…é•¿æœç´¢ä»»åŠ¡çš„åˆ†é…ã€‚

![image.png](18_images/img21.png)

å¦‚æœä½ æƒ³ï¼Œæˆ‘ä»¬å½“ç„¶ä¹Ÿå¯ä»¥æŠŠç”Ÿæˆæ¨¡å—ç»™æ›¿æ¢ä¸ºä¸€ä¸ª AI æ™ºèƒ½ä½“ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚è¿™æ ·æˆ‘ä»¬å°±æ‹¥æœ‰äº†ä¸¤ä¸ªä¸“å®¶ï¼Œä¸€ä¸ªä¸“å®¶è´Ÿè´£æ£€ç´¢ï¼Œå¦å¤–ä¸€ä¸ªä¸“å®¶è´Ÿè´£ç”Ÿæˆå†…å®¹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ£€ç´¢ä¸“å®¶æ‹¥æœ‰å¾ˆå¤šé€”å¾„æ¥è‡ªä¸»å†³ç­–æ£€ç´¢ä¿¡æ¯ï¼Œç”Ÿæˆä¸“å®¶ä¹Ÿå¯ä»¥è¾¹æœç´¢è¾¹ç”Ÿæˆå†…å®¹ï¼Œå¦‚æœå®ƒè§‰å¾—ç”Ÿæˆçš„å†…å®¹ä¸æ»¡æ„ï¼Œè¿˜ä¼šè‡ªåŠ¨é‡æ–°ç”Ÿæˆï¼

![image.png](18_images/img22.png)

#### å·¥ä½œæµç¨‹

åœ¨ Agentic RAG ä¸­ï¼Œå¯ä»¥å°† AI æ™ºèƒ½ä½“èå…¥åˆ°ä¸åŒçš„ç»„ä»¶ä¸­ï¼Œä¸€èˆ¬å¸¸è§çš„æ˜¯å°†æ£€ç´¢ç»„ä»¶æ›¿æ¢ä¸º AI æ™ºèƒ½ä½“ï¼ˆå˜æˆï¼šRetrival Agentï¼‰ã€‚è¿™ä¹Ÿå°±æ„å‘³ç€æ£€ç´¢ç»„ä»¶å°†å˜å¾—æ™ºèƒ½ï¼Œå¯ä»¥æ ¹æ® query ä¸æ–­åœ°å»æ£€ç´¢æ¥è·å–æ›´åŠ ä¸°å¯Œå’Œå‡†ç¡®çš„ä¸Šä¸‹æ–‡ã€‚åŒæ—¶ç”±äº AI æ™ºèƒ½ä½“å¯ä»¥æ¥å…¥å¾ˆå¤šå·¥å…·ï¼Œè¿™æå¤§å¢å¼ºäº†æ£€ç´¢çš„èƒ½åŠ›ï¼Œç”šè‡³å¦‚æœåœ¨çŸ¥è¯†åº“ä¸­æ— æ³•æ£€ç´¢åˆ°åˆé€‚çš„å†…å®¹ï¼ŒAI æ™ºèƒ½ä½“ä¹Ÿèƒ½ä»ç½‘ç»œã€æ•°æ®åº“æˆ–è€…å…¶ä»–ä¸€åˆ‡å¯è®¿é—®çš„å·¥å…·ä¸­æ¥è·å¾—æ›´å¤šçš„å†…å®¹ã€‚

è®©æˆ‘ä»¬ä»¥å• Agent RAG ä¸ºä¾‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ¥çœ‹ä¸€ä¸‹åœ¨ä¸åŒçš„æ™ºèƒ½ä½“å·¥ä½œæµä¸‹æ˜¯å¦‚ä½•å®Œæˆæ£€ç´¢çš„ã€‚

* é¦–å…ˆï¼Œä¸€æ¡ query è¢«ä¼ ç»™äº†æ™ºèƒ½ä½“â‘ ã€‚
  * å¦‚æœæ™ºèƒ½ä½“æ˜¯ Function Call Agentï¼Œé‚£ä¹ˆå®ƒä¼šæ ¹æ® query æ¥ä¸æ–­è°ƒç”¨å·¥å…·ï¼Œå¹¶è§‚å¯ŸæŸ¥è¯¢åˆ°çš„ä¿¡æ¯ï¼Œä»¥æ­¤ä¸æ–­å¾ªç¯â‘¡ç›´åˆ°æŸ¥è¯¢åˆ°ä»¤å®ƒæ»¡æ„çš„ä¿¡æ¯ï¼Œæˆ–è€…è¾¾åˆ°æœ€å¤§å¾ªç¯æ¬¡æ•°ï¼›
  * å¦‚æœæ™ºèƒ½ä½“æ˜¯ Reactï¼Œé‚£ä¹ˆå®ƒå…ˆæ ¹æ® query æ¥åšä¸ªæ€è€ƒï¼Œç„¶åå¼€å§‹è°ƒç”¨å·¥å…·ï¼Œå¹¶è§‚å¯ŸæŸ¥è¯¢åˆ°çš„ä¿¡æ¯ï¼Œä»¥æ­¤ä¸æ–­å¾ªç¯â‘¡ï¼Œä¹Ÿæ˜¯ç›´åˆ°æŸ¥è¯¢åˆ°ä»¤å®ƒæ»¡æ„çš„ä¿¡æ¯ï¼Œæˆ–è¾¾åˆ°æœ€å¤§å¾ªç¯æ¬¡æ•°ï¼›
  * å¦‚æœæ™ºèƒ½ä½“æ˜¯ PanAndSolveï¼Œé‚£ä¹ˆå®ƒä¼šå…ˆæ ¹æ® query æ¥åšä¸ªè®¡åˆ’å°†æŸ¥è¯¢ä»»åŠ¡è¿›è¡Œåˆ†è§£ä¸ºå­ä»»åŠ¡ï¼Œç„¶åå®ƒå¼€å§‹æ‰§è¡Œå­ä»»åŠ¡ï¼Œæ¯”å¦‚è°ƒç”¨æŸ¥è¯¢çŸ¥è¯†åº“çš„å·¥å…·ï¼Œåœ¨çŸ¥è¯†åº“è¿”å›ä¿¡æ¯åï¼Œå®ƒä¼šè§‚å¯Ÿç»“æœï¼Œå¦‚æœç»“æœä¸æ»¡æ„å®ƒä¼šé‡æ–°ä¿®æ”¹è®¡åˆ’ï¼Œå¦‚æœç»“æœè¿˜è¡Œå®ƒä¼šç»§ç»­æ²¿ç€è®¡åˆ’æ‰§è¡Œä¸‹ä¸€ä¸ªå­ä»»åŠ¡ï¼Œä»¥æ­¤ä¸æ–­å¾ªç¯â‘¡ï¼Œç›´åˆ°æœ€åå®Œæˆå®ƒè‡ªå·±åˆ¶å®šçš„æ‰€æœ‰ä»»åŠ¡è€Œè·å¾—æŸ¥è¯¢çš„ä¿¡æ¯ï¼›
  * å¦‚æœæ™ºèƒ½ä½“æ˜¯ ReWOOï¼Œé‚£ä¹ˆå®ƒä¹Ÿä¼šæ ¹æ® query æ¥åšä¸ªè®¡åˆ’ï¼Œå°†æŸ¥è¯¢ä»»åŠ¡åˆ†è§£ä¸ºå­ä»»åŠ¡ï¼Œç„¶åå®ƒä¼šä¾æ¬¡å°†å­ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæ¯•â‘¡ï¼Œæœ€åå°†ç»¼åˆæ‰€æœ‰çš„æ‰§è¡Œç»“æœæ¥ç»™å‡ºå®ƒæŸ¥è¯¢çš„ç»“æœã€‚
* åœ¨æ™ºèƒ½ä½“æŸ¥è¯¢åˆ°ä¿¡æ¯åï¼Œå°±å›åˆ°äº†ç»å…¸çš„ RAG å·¥ä½œæµï¼šæŸ¥è¯¢åˆ°çš„ä¿¡æ¯ï¼ˆå·²ç»æ˜¯è¢«æ™ºèƒ½ä½“å°† query èåˆå¢å¼ºåçš„ç»“æœï¼‰â‘¢ä¼šè¢«é€ç»™ LLM æ¥å®Œæˆå†…å®¹ç”Ÿæˆä»»åŠ¡â‘£ã€‚

è‡³æ­¤ï¼Œä¸€ä¸ªå• Agent RAG çš„å·¥ä½œæµç¨‹å°±å®Œæˆäº†ã€‚ä»ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œåœ¨æŸ¥è¯¢é˜¶æ®µï¼Œç”±äºæˆ‘ä»¬å¼•å…¥äº†æ™ºèƒ½ä½“ï¼ŒæŸ¥è¯¢å˜å¾—æ›´åŠ æ™ºèƒ½ï¼Œæ™ºèƒ½ä½“ä¼šè‡ªå·±ä¸æ–­å»æŸ¥è¯¢ï¼Œæˆ‘ä»¬ä¸ç”¨æ“å¿ƒæŸ¥è¯¢çš„è¿‡ç¨‹ï¼Œä»¥åŠæ‹…å¿ƒåªæŸ¥ä¸€æ¬¡æ‰¾ä¸åˆ°åŒ¹é…çš„ä¿¡æ¯ã€‚

![image.png](18_images/img23.png)

## å¼•å…¥åŠ¨æœº

Agentic RAG ä»…æ˜¯åœ¨åŸæœ‰ RAG çš„å·¥ä½œæµä¸­å°†å…¶ç»„ä»¶æ›¿æ¢ä¸ºäº†æ™ºèƒ½ä½“ã€‚ä¸ºä»€ä¹ˆè¦è¿™æ ·ï¼Ÿä¸ºä»€ä¹ˆè¦æå‡º Agentic RAG? æˆ–è€…è¯´ä¸ºä»€ä¹ˆè¦ç»™ RAG ä¸­å¼•å…¥æ™ºèƒ½ä½“ï¼Ÿä¸€ä¸ªå¾ˆç®€å•åŸå› å°±æ˜¯ä¸ºäº†è®©å®ƒæ›´å¼ºå¤§ï¼æ›´åŠ æ™ºèƒ½åŒ–ã€‚

![image.png](18_images/img24.png)

1. ç»å…¸çš„ RAG ä»…è¿›è¡Œå•æ¬¡æŸ¥è¯¢ï¼Œå¦‚æœå•æ¬¡æ— æ³•å¬å›åˆ°åˆé€‚çš„æ–‡æ¡£ä¿¡æ¯ï¼Œé‚£ä¹ˆåç»­çš„ç”Ÿæˆè¿‡ç¨‹çš„æ•ˆæœæ˜¯æ— æ³•ä¿éšœçš„ï¼Œä½†æ˜¯ Agentic RAG å¯ä»¥è¿›è¡Œå¤šæ¬¡æŸ¥è¯¢(multiple query)ï¼Œå¦‚æœæ­¤æ¬¡å¬å›æ•ˆæœä¸å¥½ï¼Œæ™ºèƒ½ä½“ä¼šè‡ªåŠ¨æ›´æ¢è¡¨ç¤ºæ–¹å¼æˆ–æ›´æ¢å·¥å…·è¿›è¡Œæ£€ç´¢ï¼›
2. ç»å…¸çš„ RAG çš„æ•°æ®æ¥æºå¾ˆå•ä¸€ï¼Œå¾€å¾€åªæœ‰ä¸€ä¸ªçŸ¥è¯†åº“ã€‚ä½†æ˜¯ Agentic RAG å¯ä»¥æ¥å…¥å¤§é‡çš„çŸ¥è¯†åº“ï¼Œè€Œä¸”ä¸æ­¢äºæ­¤ï¼Œå®ƒè¿˜å¯ä»¥æ¥å…¥æ•°æ®åº“ï¼Œç”šè‡³æ˜¯è”ç½‘æœç´¢ï¼Œè¿™æ„å‘³ç€ Agentic RAG çš„æ•°æ®æ¥æºæ˜¯å¤šæ ·çš„(multi source)ï¼›
   1. å¤šæ ·çš„æ•°æ®æºï¼Œä¸ä»…å¯ä»¥è¡¥å……å•æ•°æ®æºçš„ä¿¡æ¯ä¸è¶³ï¼Œæ‹¥æœ‰æ›´å¤šçš„ä¿¡æ¯ï¼›
   2. å¤šæ ·çš„æ•°æ®æºï¼Œä¹Ÿå¯ä»¥å¯¹æŸ¥è¯¢åˆ°çš„ä¿¡æ¯è¿›è¡Œç›¸äº’ä½è¯ï¼Œä¿éšœæŸ¥è¯¢ç»“æœçš„å‡†ç¡®æ€§ï¼›
3. Agentic RAG é¢å¤–è¿˜æœ‰å¤šå·¥å…·è°ƒç”¨çš„èƒ½åŠ›ï¼Œè¿™å……æ»¡äº†æ— é™çš„åŠŸèƒ½(multi-function)ï¼Œå®ƒå¯ä»¥å¯¹ä¿¡æ¯è¿›è¡Œå¤„ç†å’ŒåŠ å·¥ï¼›
4. Agentic RAG æ›´é‡è¦çš„æ˜¯å®ƒå¯ä»¥æ™ºèƒ½å†³ç­–(smart decision-making)ï¼å®ƒå¯ä»¥è‡ªåŠ¨åˆ¶å®šè®¡åˆ’æ¥å®ç°å¤æ‚çš„æŸ¥è¯¢è¿‡ç¨‹ã€‚æ•´ä¸ªè¿‡ç¨‹éƒ½ä¸éœ€è¦æˆ‘ä»¬æ“å¿ƒã€‚

å¯ä»¥æƒ³è±¡è¿™å°±æ˜¯å¸¦ç€ä¸€æœ¬æ•™ç§‘ä¹¦å’Œå¸¦ç€ä¸“å®¶å»è€ƒè¯•çš„åŒºåˆ«ï¼

## æ­å»ºå®ç°

è®©æˆ‘ä»¬ä»ä¸€ä¸ªåŸºç¡€çš„ RAG å¼€å§‹ï¼Œç„¶åç¤ºä¾‹åœ¨ LazyLLM ä¸­å¦‚ä½•æ³¨å†Œå·¥å…·å¹¶ä½¿ç”¨ React AI æ™ºèƒ½ä½“ï¼Œæœ€åå°†ä¸¤è€…ç»“åˆå®ç°ä¸€ä¸ªç®€å•çš„ Agentic RAGã€‚

### 1. æ­å»ºåŸºç¡€ RAG

åœ¨ä¹‹å‰æ•™ç¨‹çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ LazyLLM æ¥å¿«é€Ÿæ­å»ºä¸€ä¸ª RAG åº”ç”¨ã€‚è¯¥åº”ç”¨çš„é€»è¾‘å¦‚ä¸‹ï¼š

![image.png](18_images/img25.png)

å…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼Œåœ¨è¿™ä¸ªRAGä¸­ï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸ªæ£€ç´¢å™¨ Retriever å’Œ Reranker ç”¨äºæ£€ç´¢çŸ¥è¯†åº“ã€‚[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter18/basic_rag.py)

```python
import lazyllm
from lazyllm import pipeline, bind, OnlineEmbeddingModule, SentenceSplitter, Document, Retriever, Reranker

prompt = 'You will play the role of an AI Q&A assistant and complete a dialogue task. In this task, you need to provide your answer based on the given context and question.'

documents = Document(dataset_path="rag_master", embed=OnlineEmbeddingModule(), manager=False)
documents.create_node_group(name="sentences", transform=SentenceSplitter, chunk_size=1024, chunk_overlap=100)

with pipeline() as ppl:
    ppl.retriever = Retriever(documents, group_name="sentences", similarity="cosine", topk=1)
    ppl.reranker = Reranker("ModuleReranker", model=OnlineEmbeddingModule(type="rerank"), topk=1, output_format='content', join=True) | bind(query=ppl.input)
    ppl.formatter = (lambda nodes, query: dict(context_str=nodes, query=query)) | bind(query=ppl.input)
    ppl.llm = lazyllm.OnlineChatModule(stream=False).prompt(lazyllm.ChatPrompter(prompt, extro_keys=["context_str"]))

if __name__ == "__main__":
    lazyllm.WebModule(ppl, port=range(23467, 24000)).start().wait()
```

è®©æˆ‘ä»¬è¿è¡Œä¸€ä¸‹çœ‹çœ‹ç»“æœï¼š

![image.png](18_images/img26.png)

### 2. AIæ™ºèƒ½ä½“ React

Agentic RAG å°±æ˜¯å¼•å…¥äº† AI æ™ºèƒ½ä½“çš„ RAGï¼Œè¿™é‡Œè®©æˆ‘ä»¬ç”¨ LazyLLM æ¥æ³¨å†Œä¸€ä¸ªå‡çš„çŸ¥è¯†åº“æœç´¢å·¥å…·ï¼Œå®ç°ä¸€ä¸ª React:

[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/main/rag/codes/chapter18/react.py)

```python
import json
import lazyllm
from lazyllm import fc_register, ReactAgent

@fc_register("tool")
def search_knowledge_base(query: str):
    '''
    Get info from knowledge base in a given query.

    Args:
        query (str): The query for search knowledge base.
    '''
    return "æ— å½¢"

llm = lazyllm.OnlineChatModule(stream=False)

tools = ["search_knowledge_base"]
agent = ReactAgent(llm, tools)

if __name__ == "__main__":
    res = agent("ä½•ä¸ºå¤©é“ï¼Ÿ")
    print("Result: \n", res)
```

è®©æˆ‘ä»¬å°è¯•æ¥è¿è¡Œä¸€ä¸‹ï¼š

![image.png](18_images/img27.png)

æœ‰äº† Reactï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†å®ƒçš„å·¥å…·æ›¿æ¢ä¸º RAG ä¸­çš„ Retriever å’Œ Reranker æ¥ä½œä¸ºä¸€ä¸ªçœŸå®çš„çŸ¥è¯†åº“ã€‚è®©å®ƒå¯ä»¥è°ƒç”¨æ£€ç´¢å™¨ï¼š

```python
import lazyllm
from lazyllm import (pipeline, bind, OnlineEmbeddingModule, SentenceSplitter, Reranker,
                     Document, Retriever, fc_register, ReactAgent)

documents = Document(dataset_path="rag_master", embed=OnlineEmbeddingModule(), manager=False)
documents.create_node_group(name="sentences", transform=SentenceSplitter, chunk_size=1024, chunk_overlap=100)
with pipeline() as ppl_rag:
    ppl_rag.retriever = Retriever(documents, group_name="sentences", similarity="cosine", topk=3)
    ppl_rag.reranker = Reranker("ModuleReranker", model=OnlineEmbeddingModule(type="rerank"), topk=1, output_format='content', join=True) | bind(query=ppl_rag.input)

@fc_register("tool")
def search_knowledge_base(query: str):
    '''
    Get info from knowledge base in a given query.

    Args:
        query (str): The query for search knowledge base.
    '''
    return ppl_rag(query)

tools = ["search_knowledge_base"]
llm = lazyllm.OnlineChatModule(stream=False)

agent = ReactAgent(llm, tools)

if __name__ == "__main__":
    res = agent("ä½•ä¸ºå¤©é“ï¼Ÿ")
    print("Result: \n", res)
```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

![image-2.png](18_images/img28.png)

### 3. å®ç° Agentic RAG

è®©æˆ‘ä»¬å°† RAG çš„æ£€ç´¢ç»„ä»¶æ›¿æ¢ä¸ºå¸¦å•ä¸ªçŸ¥è¯†åº“çš„çš„ Reactï¼Œå®ç°ä¸‹é¢é€»è¾‘ï¼ˆè¿™é‡Œç®€å•èµ·è§ï¼Œåªç”¨äº†ä¸€ä¸ªçŸ¥è¯†åº“ä½œä¸ºå·¥å…·ï¼‰

![image.png](18_images/img29.png)

å¯¹åº”ä»£ç å¦‚ä¸‹ï¼š

[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/main/rag/codes/chapter18/rag_react.py)

```python
import lazyllm
from lazyllm import (pipeline, bind, OnlineEmbeddingModule, SentenceSplitter, Reranker,
                     Document, Retriever, fc_register, ReactAgent)

prompt = 'You will play the role of an AI Q&A assistant and complete a dialogue task. In this task, you need to provide your answer based on the given context and question.'

documents = Document(dataset_path="rag_master", embed=OnlineEmbeddingModule(), manager=False)
documents.create_node_group(name="sentences", transform=SentenceSplitter, chunk_size=1024, chunk_overlap=100)
with pipeline() as ppl_rag:
    ppl_rag.retriever = Retriever(documents, group_name="sentences", similarity="cosine", topk=3)
    ppl_rag.reranker = Reranker("ModuleReranker", model=OnlineEmbeddingModule(type="rerank"), topk=1, output_format='content', join=True) | bind(query=ppl_rag.input)

@fc_register("tool")
def search_knowledge_base(query: str):
    '''
    Get info from knowledge base in a given query.

    Args:
        query (str): The query for search knowledge base.
    '''
    return ppl_rag(query)

tools = ["search_knowledge_base"]

with pipeline() as ppl:
    ppl.retriever = ReactAgent(lazyllm.OnlineChatModule(stream=False), tools)
    ppl.formatter = (lambda nodes, query: dict(context_str=nodes, query=query)) | bind(query=ppl.input)
    ppl.llm = lazyllm.OnlineChatModule(stream=False).prompt(lazyllm.ChatPrompter(prompt, extro_keys=["context_str"]))

if __name__ == "__main__":
    lazyllm.WebModule(ppl, port=range(23467, 24000)).start().wait()
```

æ•ˆæœå¦‚ä¸‹ï¼š

![image.png](18_images/img30.png)

è‡³æ­¤ä¸€ä¸ªç®€å•çš„ Agentic RAG æˆ‘ä»¬å°±å®ç°äº†ã€‚

### 4. æ›´å¤šçš„å°è¯•

ä½ å¯ä»¥å°è¯•ä½¿ç”¨ä¸åŒçš„ AI æ™ºèƒ½ä½“å·¥ä½œæµæ¥æ›¿æ¢ä¸Šé¢çš„ Reactï¼š

[FunctionCallAgentä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/main/rag/codes/chapter18/rag_functioncall.py)

[PlanAndSolveAgentä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/main/rag/codes/chapter18/rag_planandsolve.py)

[ReWOOAgentä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/main/rag/codes/chapter18/rag_rewoo.py)

```python
from lazyllm import FunctionCallAgent, PlanAndSolveAgent, ReWOOAgent

# Use FunctionCallAgent:
ppl.retriever = FunctionCallAgent(lazyllm.OnlineChatModule(), tools)
# Use PlanAndSolveAgent:
ppl.retriever = PlanAndSolveAgent(lazyllm.OnlineChatModule(), tools)
# Use ReWOOAgent:
ppl.retriever = ReWOOAgent(lazyllm.OnlineChatModule(), tools)
```

è¿™é‡Œæˆ‘ä»¬å°è¯•å°†ReactAgent åˆ†åˆ«æ›¿æ¢ä¸ºFunctionCallAgent, PlanAndSolveAgent, ReWOOAgentæ¥æŸ¥çœ‹æ•ˆæœï¼š

#### FunctionCallAgent

FunctionCallAgentçš„æ•ˆæœï¼š

![image.png](18_images/img31.png)

#### PlanAndSolveAgent

PlanAndSolveAgentçš„æ•ˆæœï¼š

![image.png](18_images/img32.png)

#### ReWOOAgent

ReWOOAgentçš„æ•ˆæœï¼š

![image.png](18_images/img33.png)

ç”šè‡³ä½ ä¹Ÿå¯ä»¥å¼•å…¥å¤šAIæ™ºèƒ½ä½“ï¼Œä»¥åŠæ›´å¤šçš„RAGç»„ä»¶ï¼å¿«è¯•è¯•çœ‹å§ã€‚

## æ‰©å±•æ¡ˆä¾‹ï¼šå¤šAgent RAG

ä¸ºæå‡å¤æ‚é—®é¢˜çš„è¦†ç›–ç‡ä¸å“åº”è´¨é‡ï¼Œè¿˜å¯ä»¥å¼•å…¥å¤šAgent RAGçš„æ¶æ„è®¾è®¡ï¼š

ğŸ”§ Agent åˆ†å·¥

æ£€ç´¢Agentï¼šæ ¹æ®æŸ¥è¯¢å†…å®¹ç¡®å®šæ£€ç´¢å·¥å…·ï¼ˆæœ¬åœ°çŸ¥è¯†åº“/ç½‘ç»œæœç´¢ï¼‰ã€‚

Agent Aï¼ˆçŸ¥è¯†åº“ä¸“å®¶ï¼‰ï¼šè´Ÿè´£æœ¬åœ°çŸ¥è¯†åº“çš„é«˜æ•ˆæ£€ç´¢ï¼Œä¼˜å…ˆå¤„ç†ç»“æ„åŒ–ã€ç¨³å®šä¿¡æ¯ã€‚

Agent Bï¼ˆç½‘ç»œæœç´¢ä¸“å®¶ï¼‰ï¼šæ‰§è¡Œç½‘é¡µæœç´¢ã€æ•°æ®å†…å®¹æå–ï¼Œå¹¶å†™å…¥æœ¬åœ°ã€‚

æ£€ç´¢å®Œæˆåï¼Œæ‰€æœ‰ç»“æœç»Ÿä¸€é€å…¥LLMç”Ÿæˆå“åº”ï¼Œä¿è¯è¯­è¨€è´¨é‡ä¸ä¸Šä¸‹æ–‡ä¸€è‡´æ€§

![image.png](18_images/img34.png)

MCPç½‘ç»œæœç´¢å·¥å…·å®šä¹‰ä¸æ³¨å†Œ

```python
# MCP-Search Web and Save Local
mcp_client1 = lazyllm.tools.MCPClient(command_or_url="python", args=["-m", "mcp_server_fetch"],)
search_agent = CustomReactAgent(llm=lazyllm.OnlineChatModule(source="sensenova", stream=False),
    stream=False, custom_prompt=search_prompt, tools=mcp_client1.get_tools())

@fc_register("tool")
def search_web(query: str):
    '''
    Perform targeted web content retrieval using a combination of search terms and URL.
    This tool processes both natural language requests and specific webpage addresses 
    to locate relevant online information.
    Args:
        query (str): Combined input containing search keywords and/or target URL 
                   (e.g., "AI news from https://example.com/tech-updates")
    '''
    query += search_prompt
    res = search_agent(query)
    return res
```

RAGå·¥å…·å®šä¹‰ä¸æ³¨å†Œ+åº”ç”¨ç¼–æ’

```python
# RAG-Retriever
documents = Document(dataset_path='path/to/kb', manager=False)
documents.add_reader('*.json', process_json)
with pipeline() as ppl_rag:
    ppl_rag.retriever = Retriever(documents, Document.CoarseChunk,
        similarity="bm25", topk=1, output_format='content', join='='*20)
@fc_register("tool")
def search_knowledge_base(query: str):
    '''
    Get info from knowledge base in a given query.
    Args:
        query (str): The query for search knowledge base.
    '''
    res = ppl_rag(query)
    return res

# Agentic-RAG:
tools = ['search_knowledge_base', 'search_web']
with pipeline() as ppl:
    ppl.retriever = CustomReactAgent(lazyllm.OnlineChatModule(stream=False), tools, agent_prompt, stream=False)
    ppl.formatter = (lambda nodes, query: dict(context_str=nodes, query=query)) | bind(query=ppl.input)
    ppl.llm = lazyllm.OnlineChatModule(stream=False).prompt(lazyllm.ChatPrompter(gen_prompt, extra_keys=["context_str"]))
# Launch: Web-UI
lazyllm.WebModule(ppl, port=range(23467, 24000), stream=True).start().wait()

```

![image.png](18_images/img35.png)

## å¤šæ¨¡æ€Agentic RAGè®ºæ–‡ç³»ç»Ÿ

![image.png](18_images/img36.png)

é…ç½®ä¸¤ä¸ªMCPå·¥å…·åŠAgent

[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/main/rag/courseware_codes/chapter18/mcp_agent.py)

```python
import json
import lazyllm
from lazyllm import ReactAgent
mcp_client1 = lazyllm.tools.MCPClient(
    command_or_url="python",
    args=["-m", "mcp_simple_arxiv"],
)
mcp_client2 = lazyllm.tools.MCPClient(
    command_or_url="python",
    args=["-m", "mcp_server_calculator"],
)
llm = lazyllm.OnlineChatModule(stream=False)
paper_agent = ReactAgent(llm, mcp_client1.get_tools(), return_trace=True)
calculator_agent = ReactAgent(llm, mcp_client2.get_tools(), return_trace=True)
```

ç¯å¢ƒä¸­éœ€æå–å®‰è£…å¥½ä¸¤ä¸ªå·¥å…·ï¼š

```bash
pip install mcp-simple-arxiv
pip install mcp-server-calculator
```

åº”ç”¨ç¼–æ’

[ä»£ç GitHubé“¾æ¥](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/courseware_codes/chapter18/paper_assistant_multimodal.py#L25)

```python
# æ„å»º rag å·¥ä½œæµå’Œç»Ÿè®¡åˆ†æå·¥ä½œæµ
rag_ppl = build_paper_rag()
sql_ppl = build_statistical_agent()
# æ­å»ºå…·å¤‡çŸ¥è¯†é—®ç­”å’Œç»Ÿè®¡é—®ç­”èƒ½åŠ›çš„ä¸»å·¥ä½œæµ
def build_paper_assistant():
    llm = OnlineChatModule(source='qwen', stream=False)
    vqa = lazyllm.OnlineChatModule(source="sensenova",\
        model="SenseNova-V6-Turbo").prompt(lazyllm.ChatPrompter(gen_prompt))
    with pipeline() as ppl:
        ppl.ifvqa = lazyllm.ifs(
            lambda x: x.startswith('<lazyllm-query>'),
            lambda x: vqa(x), lambda x:x)
        with IntentClassifier(llm) as ppl.ic:
            ppl.ic.case["è®ºæ–‡é—®ç­”", rag_ppl]
            ppl.ic.case["ç»Ÿè®¡é—®ç­”", sql_ppl]
            ppl.ic.case["è®¡ç®—å™¨", calculator_agent]
            ppl.ic.case["ç½‘é¡µæœ€æ–°è®ºæ–‡æœç´¢", paper_agent]
    return ppl
if __name__ == "__main__":
    main_ppl = build_paper_assistant()
    lazyllm.WebModule(main_ppl, port=23459, static_paths="./images", encode_files=True).start().wait()
```

<div style="text-align:center; margin:20px 0;">
  <video controls style="width:900px; max-width:100%; height:auto; border:1px solid #ccc; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1);">
    <source src="../18_videos/å¤šæ¨¡æ€Agentic_RAGè®ºæ–‡ç³»ç»Ÿæ¼”ç¤º.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
</div>