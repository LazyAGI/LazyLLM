# 16è¿›é˜¶4-å®æˆ˜ï¼šæ‰“é€ å…·å¤‡å®è§‚é—®ç­”ä¸å›¾è¡¨ç”ŸæˆåŠŸèƒ½çš„è®ºæ–‡é—®ç­”çš„RAGç³»ç»Ÿ

> åœ¨å‰é¢çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨æ‰€å­¦çš„ RAG çŸ¥è¯†ï¼Œæ­å»ºäº†ä¸€ä¸ªåŸºäºè®ºæ–‡çš„é—®ç­”ç³»ç»Ÿã€‚ä½†æ˜¯å½“è®ºæ–‡æ•°é‡æ¯”è¾ƒå¤šæ—¶ï¼Œé’ˆå¯¹ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œæ¯”å¦‚æŸä¸ªæ–¹å‘çš„è®ºæ–‡æ•°é‡ã€æŸä¸ªä¼šè®®çš„è®ºæ–‡æ•°é‡ç­‰ï¼Œå¦‚æœåªé€šè¿‡ä¼ ç»Ÿçš„ RAG æ˜¯æ²¡åŠæ³•å¯¹è¿™äº›ä¿¡æ¯è¿›è¡Œæ£€ç´¢çš„ã€‚å¯¹æ­¤ï¼Œæœ¬ç« å°†å…ˆç®€å•å›é¡¾ä¹‹å‰å†…å®¹ï¼Œå¹¶å†æ­¤åŸºç¡€ä¸Šå†åšå‡çº§ï¼Œå®Œæˆä¸€ä¸ªé›†ç»Ÿè®¡åˆ†æå’ŒçŸ¥è¯†é—®ç­”åŠŸèƒ½äºä¸€ä½“çš„æ™ºèƒ½é—®ç­”ç³»ç»Ÿã€‚

## ä¸€ã€ä¸ŠèŠ‚å›é¡¾

ä¸ºäº†æ›´å¥½åœ°ç†è§£æœ¬ç« å†…å®¹ï¼Œæˆ‘ä»¬å…ˆç®€è¦å›é¡¾å‰ä¸¤ç« çš„å…³é”®å†…å®¹ã€‚

ç¬¬åå››ç« ä»‹ç»äº†è®ºæ–‡é—®ç­”ç³»ç»Ÿçš„æ„å»ºè¿‡ç¨‹ï¼Œä¾æ¬¡è®²è§£äº†æ ¸å¿ƒç»„ä»¶ï¼Œå¦‚è§£æå™¨ã€retrieverã€reranker ç­‰ï¼Œå¹¶å±•ç¤ºäº†å¦‚ä½•é€æ­¥æ­å»ºä¸€ä¸ªå®Œæ•´çš„ RAG ç³»ç»Ÿã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿæ¢è®¨äº†ä¸€äº›è¿›é˜¶æŠ€å·§ï¼Œä»¥æå‡ç³»ç»Ÿçš„æ€§èƒ½ä¸çµæ´»æ€§ã€‚

![image.png](16_images/img1.png)

ä¸è¿‡ï¼Œè¿™ä¸€ç³»ç»Ÿä»å±äºä¼ ç»Ÿ RAG æ¶æ„ã€‚åœ¨ç¬¬åäº”ç« ä¸­ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥æŒ‡å‡ºäº†ä¼ ç»Ÿ RAG åœ¨å¤„ç†ç»Ÿè®¡ç±»é—®é¢˜æ—¶çš„å±€é™æ€§ï¼Œå¹¶æå‡ºäº†åº”å¯¹æ€è·¯ï¼Œå¦‚ç»“åˆ SQL æ•°æ®åº“ã€Text2SQL æŠ€æœ¯åŠ sql\_tool å·¥å…·ã€‚ç„¶è€Œï¼Œå‰ç« ä»…æå‡ºäº†ç†è®ºæ–¹æ¡ˆï¼Œå°šæœªç»™å‡ºå®Œæ•´çš„å®è·µç¤ºä¾‹ã€‚

å› æ­¤ï¼Œæœ¬ç« å°†åœ¨æ­¤åŸºç¡€ä¸Šï¼Œç»“åˆå®é™…æ¡ˆä¾‹ï¼Œæ„å»ºä¸€ä¸ªæ›´å®Œæ•´ã€ æ›´å…·å®ç”¨æ€§çš„ç»Ÿè®¡é—®ç­”ç³»ç»Ÿï¼Œè¿›ä¸€æ­¥æ‹“å±• RAG åœ¨ç»“æ„åŒ–æ•°æ®å¤„ç†æ–¹é¢çš„èƒ½åŠ›ã€‚

## äºŒã€æœ¬èŠ‚æ¦‚è§ˆ

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å°†åœ¨å·²æœ‰çš„è®ºæ–‡é—®ç­”ç³»ç»ŸåŸºç¡€ä¸Šè¿›ä¸€æ­¥æ‹“å±•å…¶åŠŸèƒ½ï¼Œä½¿ç³»ç»Ÿä¸ä»…èƒ½å¤Ÿè¿›è¡ŒçŸ¥è¯†é—®ç­”ï¼Œè¿˜å…·å¤‡å¤„ç†ç»Ÿè®¡åˆ†æä»»åŠ¡çš„èƒ½åŠ›ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ä¼ ç»Ÿçš„ RAG æ¶æ„è¿›è¡Œè°ƒæ•´ï¼Œå¢å¼ºå…¶åœ¨ç»Ÿè®¡åœºæ™¯ä¸‹çš„é€‚åº”æ€§ã€‚

ç”±äºçŸ¥è¯†é—®ç­”ä¸ç»Ÿè®¡é—®ç­”åœ¨å¤„ç†é€»è¾‘å’Œæ‰€ä¾èµ–çš„ä¿¡æ¯ç±»å‹ä¸Šå­˜åœ¨æ˜¾è‘—å·®å¼‚ï¼Œé‡‡ç”¨ç»Ÿä¸€çš„ pipeline æ¥åº”å¯¹ä¸¤ç§éœ€æ±‚åœ¨å®è·µä¸­å­˜åœ¨è¾ƒå¤§å›°éš¾ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åœ¨åŸæœ‰ RAG pipeline çš„åŸºç¡€ä¸Šæ–°å¢äº†ä¸€æ¡ä¸“é—¨å¤„ç†ç»Ÿè®¡ä»»åŠ¡çš„ pipelineï¼Œå®ç°ä»ã€å›¾1ã€‘åˆ°ã€å›¾2ã€‘çš„ç³»ç»Ÿç»“æ„å˜åŒ–ã€‚

![image.png](16_images/img2.png)

å›¾1 åŸè®ºæ–‡ç³»ç»Ÿæ¶æ„å›¾

![image.png](16_images/img3.png)

å›¾2 å…·å¤‡ç»Ÿè®¡èƒ½åŠ›çš„é—®ç­”ç³»ç»Ÿæ¶æ„å›¾

åœ¨å¤ç”¨ç°æœ‰æ¨¡å—çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬æ–°å¢äº†ç”¨äºæ•°æ®åº“æŸ¥è¯¢ã€ç»Ÿè®¡åˆ†æå’Œå›¾è¡¨ç”Ÿæˆçš„ç»Ÿè®¡åˆ†æ pipelineã€‚è¯¥ pipeline ä¸ RAG pipeline å¹¶è¡Œè¿è¡Œï¼Œå¹¶é€šè¿‡ä¸€ä¸ªæ„å›¾è¯†åˆ«æ¨¡å—è¿›è¡Œç»Ÿä¸€è°ƒåº¦ã€‚è¯¥æ¨¡å—è´Ÿè´£åˆ¤æ–­ç”¨æˆ·æŸ¥è¯¢å±äºçŸ¥è¯†é—®ç­”è¿˜æ˜¯ç»Ÿè®¡åˆ†æï¼Œä»è€Œå¼•å¯¼è¯·æ±‚è¿›å…¥åˆé€‚çš„å¤„ç†æµç¨‹ã€‚

ä¸ºå®ç°è¿™ä¸€å¢å¼ºç³»ç»Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¼•å…¥è‹¥å¹²å…³é”®çš„æŠ€æœ¯æ¨¡å—ã€‚æ¥ä¸‹æ¥å°†åœ¨å®Œæˆæ•°æ®å‡†å¤‡åé€ä¸€ä»‹ç»è¿™äº›æ–°å¢æ¨¡å—åŠå…¶åœ¨ç³»ç»Ÿä¸­çš„ä½œç”¨ã€‚

## ä¸‰ã€æ•°æ®å‡†å¤‡

è¿™é‡Œæˆ‘ä»¬ä»¥ [ArXivQA](https://github.com/taesiri/ArXivQA) æ•°æ®é›†ä¸ºä¾‹ï¼Œä» Papers-2024.md ä¸­æŠ½å–äº†å‰é¢100ç¯‡æ¥æ¼”ç¤ºï¼Œåœ¨æ‰§è¡Œä»£ç ä¹‹å‰æ‚¨éœ€è¦å…ˆä¸‹è½½Papers-2024.mdï¼Œå¯ä»¥ç¦»çº¿ä¸‹è½½æˆ–è€…ä»¥ä¸‹å‘½ä»¤è¿›è¡Œä¸‹è½½ã€‚è¯¥æ–‡ä»¶åŒ…å«äº†è®ºæ–‡ä¿¡æ¯å’Œä¸‹è½½é“¾æ¥ã€‚

```python
wget https://raw.githubusercontent.com/taesiri/ArXivQA/main/Papers-2024.md -O 2024.md
```

**æˆ‘ä»¬éœ€è¦ä»ä¸¤æ–¹é¢å»å‡†å¤‡æ•°æ®ï¼š**

**â€‹ 1. çŸ¥è¯†åº“ï¼ˆä¸‹è½½è®ºæ–‡æ–‡ä»¶åˆ°æŒ‡å®šç›®å½•ä¸‹ï¼‰ ï¼Œç”¨äºçŸ¥è¯†é—®ç­”**

**â€‹ 2. æ•°æ®åº“ï¼ˆæ„å»ºè®ºæ–‡ä¿¡æ¯çš„è¡¨æ ¼å­˜å…¥æœ¬åœ°æ•°æ®åº“ï¼‰ï¼Œç”¨äºç»Ÿè®¡é—®ç­”ï¼Œè®ºæ–‡ä¿¡æ¯å¦‚titleã€authorç­‰**

ä»¥ä¸‹è„šæœ¬å¯ä»¥åŒæ—¶å®ç°å°†è®ºæ–‡ä¸‹è½½åˆ°æŒ‡å®šæ–‡ä»¶åŒæ—¶æ„å»ºè®ºæ–‡ä¿¡æ¯çš„æ•°æ®åº“ã€‚

[ä»£ç å—GitHubé“¾æ¥ğŸ”—](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter16/CreateDataBase.py#L1)

```python
import re
import requests
import time
import json
from tqdm import tqdm
from bs4 import BeautifulSoup

# ä¸‹è½½æ–‡ä»¶çš„å‡½æ•°
def spider(url, save_dir='./rag_data/papers'):
    response = requests.get(url)

    # æ£€æŸ¥è¯·æ±‚æ˜¯å¦æˆåŠŸ
    res = {}
    if response.status_code == 200:
        # è§£æç½‘é¡µå†…å®¹
        soup = BeautifulSoup(response.text, 'html.parser')
        elements = soup.find_all(class_='title mathjax')
        for ele in elements:
            res['title'] = ele.get_text().replace("Title:", '')
        elements = soup.find_all(class_='authors')
        authors = []
        for ele in elements:
            links = ele.find_all('a')
            for link in links:
                authors.append(link.get_text())
        res['author'] = ';'.join(authors)
        elements = soup.find_all(class_='tablecell subjects')
        for ele in elements:
            res['subject'] = ele.get_text()
           
        # ä¿å­˜è®ºæ–‡
        file_path = os.path.join(save_dir, res['title'] + '.pdf')
        with open(file_path, 'wb') as f:
            f.write(response.content)
        print(f"å·²ä¿å­˜ PDF åˆ° {file_path}")
        return res

    else:
        print(f"ç½‘é¡µåŠ è½½å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š{response.status_code}")


def get_information():
    with open('2024.md')as f:
        texts = f.readlines()[2:102]

    reses = []
    for text in tqdm(texts):
        abs_url = re.findall(r'\[.*?\]\((https?://arxiv.*?)\)', text)
        if len(abs_url) > 0:
            res = spider(abs_url[0])
            reses.append(res)
            time.sleep(5)

    with open('test.txt', 'w')as f:
        json.dump({"data": reses}, f)
```

ä¸Šé¢è¿™æ˜¯ä¸€ä¸ªè·å–æ–‡æ¡£ä¿¡æ¯è„šæœ¬ï¼Œè´Ÿè´£è§£æ 2024.md ä¸­çš„æ•°æ®ï¼Œå¹¶å–100ç¯‡ä¸ºä¾‹ï¼Œç„¶åè§£æå¯¹åº”çš„ url ï¼Œç„¶åé€šè¿‡è·å–æ¯ä¸ª url å¯¹åº”çš„è®ºæ–‡æ ‡é¢˜ã€ä½œè€…å’Œä¸»é¢˜çš„ä¿¡æ¯ï¼Œå¹¶è®°å½•ä¸‹æ¥ã€‚

[ä»£ç å—GitHubé“¾æ¥ğŸ”—](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter16/CreateDataBase.py#L52)

```python
import sqlite3
import json


def write_into_table():
    with open('test.txt', 'r')as f:
        data = json.load(f)

    data = data['data']

    # è¿æ¥åˆ° SQLite æ•°æ®åº“ï¼ˆå¦‚æœæ•°æ®åº“ä¸å­˜åœ¨ï¼Œå®ƒä¼šè¢«åˆ›å»ºï¼‰
    conn = sqlite3.connect('papers.db')
    cursor = conn.cursor()

    # åˆ›å»ºè¡¨æ ¼
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS papers (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        title TEXT,
        author TEXT,
        subject TEXT
    )
    ''')

    # æ’å…¥æ•°æ®
    for paper in data:
        cursor.execute('''
        INSERT INTO papers (title, author, subject)
        VALUES (?, ?, ?)
        ''', (paper['title'], paper['author'], paper['subject']))

    # æäº¤å¹¶å…³é—­è¿æ¥
    conn.commit()
    conn.close()

```

ä¸Šé¢çš„ä»£ç æ˜¯æ ¹æ®è·å–çš„ä¿¡æ¯ï¼Œåˆ›å»ºå¯¹åº”çš„æ•°æ®åº“ä¿¡æ¯ï¼Œå¹¶æŠŠè®°å½•ä¿¡æ¯å†™å…¥ï¼Œç”¨äº SQL Call çš„æŸ¥è¯¢ã€‚

ç°åœ¨å®Œæˆæ•°æ®å‡†å¤‡ï¼Œæˆ‘ä»¬å¾—åˆ°äº†å›ºå®šç›®å½•ä¸‹å·²ç»ä¸‹è½½å¥½çš„è®ºæ–‡ï¼š

![image.png](16_images/img4.png)

ä»¥åŠæ•°æ®åº“æ–‡ä»¶`papers.db` ã€‚

![image.png](16_images/img5.png)

## å››ã€ä¾èµ–æ¨¡å—è¯¦è§£

ä¸ºäº†æ„å»ºæ”¯æŒç»Ÿè®¡åˆ†æçš„é—®ç­”ç³»ç»Ÿï¼Œæˆ‘ä»¬éœ€è¦æŒæ¡å‡ ä¸ªæ ¸å¿ƒæ¨¡å—çš„åŸç†å’Œå®ç°æ–¹å¼ï¼Œåˆ†åˆ«åŒ…æ‹¬æ„å›¾è¯†åˆ«ã€SQL è°ƒç”¨ã€ç»Ÿè®¡åˆ†æåŠå›¾è¡¨ç”Ÿæˆã€‚

### 1. æ„å›¾è¯†åˆ«
   
   é¦–å…ˆæ˜¯æ„å›¾è¯†åˆ«æ¨¡å—ã€‚è¯¥æ¨¡å—çš„ä¸»è¦èŒè´£æ˜¯åˆ†æç”¨æˆ·çš„è¾“å…¥å†…å®¹ï¼Œåˆ¤æ–­å…¶æ„å›¾å±äºä¼ ç»Ÿçš„çŸ¥è¯†é—®ç­”ï¼Œè¿˜æ˜¯æ¶‰åŠåˆ°ç»“æ„åŒ–æ•°æ®å¤„ç†çš„ç»Ÿè®¡é—®ç­”ã€‚
   
   LazyLLMå†…ç½®äº†ç”¨äºå¯¹æ„å›¾è¿›è¡Œåˆ†æçš„ç±» IntentClassifier ï¼Œå…·ä½“ä»‹ç»å¦‚ä¸‹ï¼š

IntentClassifier æ˜¯ä¸€ä¸ªåŸºäºè¯­è¨€æ¨¡å‹çš„æ„å›¾è¯†åˆ«å™¨ï¼Œç”¨äºæ ¹æ®ç”¨æˆ·æä¾›çš„è¾“å…¥æ–‡æœ¬åŠå¯¹è¯ä¸Šä¸‹æ–‡è¯†åˆ«é¢„å®šä¹‰çš„æ„å›¾ï¼Œå¹¶é€šè¿‡é¢„å¤„ç†å’Œåå¤„ç†æ­¥éª¤ç¡®ä¿å‡†ç¡®è¯†åˆ«æ„å›¾ã€‚

å¯¹äº IntentClassifier ï¼Œæˆ‘ä»¬æä¾›äº†ä»¥ä¸‹å‚æ•°ï¼š

* llm: ç”¨äºæ„å›¾è¯†åˆ«çš„è¯­è¨€æ¨¡å‹å¯¹è±¡ï¼ŒOnlineChatModuleæˆ–TrainableModuleç±»å‹
* intent\_list (list): åŒ…å«æ‰€æœ‰å¯èƒ½æ„å›¾çš„å­—ç¬¦ä¸²åˆ—è¡¨ã€‚å¯ä»¥åŒ…å«ä¸­æ–‡æˆ–è‹±æ–‡çš„æ„å›¾ã€‚
* prompt (str): ç”¨æˆ·é™„åŠ çš„æç¤ºè¯ã€‚
* constrain (str): ç”¨æˆ·é™„åŠ çš„é™åˆ¶ã€‚
* examples (list[list]): é¢å¤–çš„ç¤ºä¾‹ï¼Œæ ¼å¼ä¸º `[[query, intent], [query, intent], ...]` ã€‚
* return\_trace (bool, å¯é€‰): å¦‚æœè®¾ç½®ä¸º Trueï¼Œåˆ™å°†ç»“æœè®°å½•åœ¨traceä¸­ã€‚é»˜è®¤ä¸º Falseã€‚

```python
ch_prompt_classifier_template = """
## roleï¼šæ„å›¾åˆ†ç±»å™¨
ä½ æ˜¯ä¸€ä¸ªæ„å›¾åˆ†ç±»å¼•æ“ï¼Œè´Ÿè´£æ ¹æ®å¯¹è¯ä¿¡æ¯åˆ†æç”¨æˆ·è¾“å…¥æ–‡æœ¬å¹¶ç¡®å®šå”¯ä¸€çš„æ„å›¾ç±»åˆ«ã€‚{user_prompt}

## é™åˆ¶:
ä½ åªéœ€è¦å›å¤æ„å›¾çš„åå­—å³å¯ï¼Œä¸è¦é¢å¤–è¾“å‡ºå…¶ä»–å­—æ®µï¼Œä¹Ÿä¸è¦è¿›è¡Œç¿»è¯‘ã€‚{user_constrains}

## æ³¨æ„:
{attention}

## æ–‡æœ¬æ ¼å¼
è¾“å…¥æ–‡æœ¬ä¸ºJSONæ ¼å¼ï¼Œ"human_input"ä¸­å†…å®¹ä¸ºç”¨æˆ·çš„åŸå§‹è¾“å…¥ï¼Œ"intent_list"ä¸ºæ‰€æœ‰æ„å›¾ååˆ—è¡¨

## ç¤ºä¾‹
User: {{"human_input": "åŒ—äº¬æ˜å¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ", "intent_list": ["æŸ¥çœ‹å¤©æ°”", "æœç´¢å¼•æ“æ£€ç´¢", "æŸ¥çœ‹ç›‘æ§", "å‘¨æŠ¥æ€»ç»“", "èŠå¤©"]}}
Assistant:  æŸ¥çœ‹å¤©æ°”
{user_examples}

## å†å²å¯¹è¯
äººç±»å’ŒåŠ©æ‰‹ä¹‹é—´çš„èŠå¤©è®°å½•å­˜å‚¨åœ¨ä¸‹é¢çš„ <histories></histories> XML æ ‡è®°ä¸­ã€‚
<histories>
{history_info}
</histories>

è¾“å…¥æ–‡æœ¬å¦‚ä¸‹:
"""  # noqa E501

```

åœ¨ IntentClassifier å†…ï¼Œå†…ç½®äº†å¦‚ä¸Šæ‰€ç¤ºçš„æ¨¡æ¿ï¼Œç”¨äºå°†ä¸Šè¿°å‚æ•°ä¼ å…¥ç»™å¤§æ¨¡å‹ã€‚IntentClassifier çš„è°ƒç”¨éå¸¸ç®€å•ï¼Œä¸‹é¢å°±æ˜¯ä¸¤ä¸ªå®Œæ•´è°ƒç”¨çš„ä¾‹å­[ä»£ç Githubé“¾æ¥ğŸ”—](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter16/intent_classifier.py#L1)ï¼š

```python
import lazyllm
from lazyllm.tools import IntentClassifier

classifier_llm = lazyllm.OnlineChatModule()
chatflow_intent_list = ["ç¿»è¯‘æœåŠ¡", "å¤©æ°”æŸ¥è¯¢", "å†…å®¹æ¨è", "é‡‘èè¡Œæƒ…æŸ¥è¯¢"]
classifier = IntentClassifier(classifier_llm, intent_list=chatflow_intent_list)

while True:
    query = input("è¾“å…¥æ‚¨çš„é—®é¢˜ï¼š\n")
    print(f"\nè¯†åˆ«åˆ°çš„æ„å›¾æ˜¯ï¼š\n {classifier(query)}\n" + "-"*40)

# ä»Šå¤©å¤©æ°”æ€ä¹ˆæ · â” å¤©æ°”æŸ¥è¯¢
# Aè‚¡è¡Œæƒ…æ€ä¹ˆæ · â” é‡‘èè¡Œæƒ…æŸ¥è¯¢
# ç»™æˆ‘æ¨èä¸€éƒ¨ç§‘å¹»ç”µå½± â” å†…å®¹æ¨è
# å¸®æˆ‘æŠŠè¿™è¾¹è®ºæ–‡è¯‘ä¸ºä¸­æ–‡ â” ç¿»è¯‘æœåŠ¡

```

<div style="text-align:center; margin:20px 0;">
  <video controls style="width:900px; max-width:100%; height:auto; border:1px solid #ccc; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1);">
    <source src="../16_videos/intent.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
</div>

#### æ„å›¾è¯†åˆ«-é«˜çº§ç”¨æ³•

é€šè¿‡withè¯­æ³•ï¼Œä½¿å¾—æ„å›¾è¯†åˆ«æ¨¡å—èƒ½å¤Ÿç›´æ¥è·Ÿéšå…·ä½“çš„æŒ‡ä»¤

```python
base = TrainableModule('internlm2-chat-7b')
with IntentClassifier(base) as ic:
    ic.case['èŠå¤©', base]
    ic.case['è¯­â¾³è¯†åˆ«', TrainableModule('SenseVoiceSmall')]
    ic.case['å›¾â½šé—®ç­”', TrainableModule('Mini-InternVL-Chat-2B-V1-5').deploy_method(deploy.LMDeploy)]
    ic.case['ç”»å›¾', pipeline(base.share().prompt(painter_prompt),
    TrainableModule('stable-diffusion-3-medium'))]
    ic.case['â½£æˆâ¾³ä¹', pipeline(base.share().prompt(musician_prompt), TrainableModule('musicgen-small'))]
    ic.case['â½‚å­—è½¬è¯­â¾³', TrainableModule('ChatTTS')]
    WebModule(ic, history=[base], audio=True, port=8847).start().wait()
```

â€¢ ä½¿ç”¨æ–¹å¼æœ‰case[a, b]ï¼Œcase[a: b]å’Œcase[a::b]ä¸‰ç§ï¼Œå¯ä»¥æ ¹æ®ä¸ªäººä¹ æƒ¯é€‰æ‹©ä½¿ç”¨ä¸‰è€…æ— åŒºåˆ«ï¼š

```python
with IntentClassifier(base) as ic:
    ic.case['èŠå¤©', base]
    ic.case['è¯­â¾³è¯†åˆ«': TrainableModule('SenseVoiceSmall')]
    ic.case['å›¾â½šé—®ç­”'::TrainableModule('Mini-InternVL-Chat-2B-V1-5').deploy_method(deploy.LMDeploy)]
```

### 2. Sql Manager

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è§£å†³ç»Ÿè®¡é—®ç­”æµç¨‹ä¸­çš„ç¬¬ä¸€ç¯èŠ‚ï¼šæ•°æ®åº“æŸ¥è¯¢ä¸æ•°æ®è·å–ã€‚

åœ¨ä¹‹å‰çš„å­¦ä¹ å†…å®¹ä¸­ï¼Œè™½ç„¶æˆ‘ä»¬ä»¥ SQLite ä¸ºä¾‹è®²è§£äº†æ•°æ®åº“çš„åŸºæœ¬ä½¿ç”¨æµç¨‹ï¼Œä½†åœ¨çœŸå®çš„ç”Ÿäº§ç¯å¢ƒé‡Œï¼Œä½¿ç”¨çš„æ•°æ®åº“ç§ç±»è¿œä¸æ­¢ SQLiteã€‚å¸¸è§çš„å…³ç³»å‹æ•°æ®åº“è¿˜åŒ…æ‹¬ MySQLã€PostgreSQLã€SQL Serverã€Oracle ç­‰ï¼Œè€Œåœ¨äº‘ç«¯ï¼Œè¯¸å¦‚é˜¿é‡Œäº‘ RDSã€è…¾è®¯äº‘ CynosDBã€AWS RDS è¿™æ ·çš„æ•°æ®åº“æœåŠ¡ä¹Ÿè¢«å¹¿æ³›ä½¿ç”¨ã€‚

ä¸ºäº†æ–¹ä¾¿åœ°è¿æ¥å’Œæ“ä½œä¸åŒç±»å‹çš„æ•°æ®åº“ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Python ä¸­éå¸¸æµè¡Œçš„ ORM æ¡†æ¶â€”â€”â€‹**SQLAlchemy**â€‹ã€‚SQLAlchemy æä¾›äº†ç»Ÿä¸€çš„æ•°æ®åº“æ“ä½œæ¥å£ï¼Œä¸ä»…æ”¯æŒæœ¬åœ°æ•°æ®åº“ï¼Œä¹Ÿæ”¯æŒå„ç§ä¸»æµäº‘æ•°æ®åº“ï¼Œæå¤§åœ°æå‡äº†æ•°æ®åº“äº¤äº’çš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚ä»¥ä¸‹ä¸ºé€šè¿‡**SQLAlchemy**è¿æ¥æœ¬åœ°å’Œè¿œç¨‹æ•°æ®åº“çš„ä»£ç ã€‚

```python
from sqlalchemy import create_engine

# åˆ›å»º SQLite æœ¬åœ°æ•°æ®åº“è¿æ¥
engine = create_engine('sqlite:///local_database.db')
# åˆ›å»ºè¿œç¨‹ MySQL æ•°æ®åº“è¿æ¥
# æ ¼å¼ï¼šmysql+pymysql://ç”¨æˆ·å:å¯†ç @æœåŠ¡å™¨åœ°å€:ç«¯å£/æ•°æ®åº“å
engine = create_engine('mysql+pymysql://user:password@host:3306/database_name')

# æµ‹è¯•è¿æ¥
with engine.connect() as connection:
    result = connection.execute("SELECT 1")
    print(result.fetchone())
```

åœ¨ lazyllm æ¡†æ¶ä¸­ï¼Œä¹Ÿå¯¹è¿™ä¸€åŠŸèƒ½è¿›è¡Œäº†å°è£…ï¼Œæä¾›äº†å†…ç½®çš„ **SQLManager** æ¨¡å—ã€‚é€šè¿‡ SQLManagerï¼Œç”¨æˆ·å¯ä»¥éå¸¸ç®€å•åœ°è¿æ¥æœ¬åœ°æˆ–äº‘ä¸Šçš„æ•°æ®åº“ï¼Œç»Ÿä¸€è°ƒç”¨ SQL æŸ¥è¯¢ã€æ‰§è¡Œ SQL-call ç›¸å…³æ“ä½œï¼Œæ— éœ€å…³å¿ƒåº•å±‚è¿æ¥çš„å¤æ‚ç»†èŠ‚ã€‚åªéœ€åœ¨é…ç½®ä¸­æŒ‡å®šæ•°æ®åº“åœ°å€ã€è´¦å·å¯†ç ç­‰ä¿¡æ¯ï¼Œå°±å¯ä»¥ä¸€é”®å¯åŠ¨æ•°æ®åº“äº¤äº’èƒ½åŠ›ï¼Œä¸ºåç»­çš„ç»“æ„åŒ–é—®ç­”æ‰“ä¸‹åšå®åŸºç¡€ã€‚
[ä»£ç å—GitHubé“¾æ¥ğŸ”—](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter16/sql_manager.py#L1)

```python
from lazyllm.tools import SqlManager

# è¿æ¥æœ¬åœ°æ•°æ®åº“
sql_manager = SqlManager("sqlite", None, None, None, None, db_name="papers.db",   tables_info_dict=table_info)
# è¿æ¥è¿œç¨‹æ•°æ®åº“
# sql_manager = SqlManager(type="PostgreSQL", user="", password="", host="",port="", name="",)

# æŸ¥è¯¢æ‰€æœ‰è®ºæ–‡æ•°é‡
res = sql_manager.execute_query("select count(*) as total_papser from papers;")
>>> [{"total_papser": 100}]

# æŸ¥è¯¢å¸¦æœ‰ LLM çš„è®ºæ–‡æ ‡é¢˜
res = sql_manager.execute_query("select title from papers where title like '%LLM%'")
>>> [{"title": "AmpleGCG: Learning a Universal and Transferable Generative Model of Adversarial Suffixes for Jailbreaking Both Open and Closed LLMs"}, {"title": "Learning to Localize Objects Improves Spatial Reasoning in Visual-LLMs"}, {"title": "LLMs in Biomedicine: A study on clinical Named Entity Recognition"}, {"title": "VLLMs Provide Better Context for Emotion Understanding Through Common Sense Reasoning"}]
```

æ³¨æ„ï¼Œ`db_name` å‚æ•°éœ€è¦ä¼ å…¥æ„å»ºå¥½çš„æ•°æ®åº“æ–‡ä»¶è·¯å¾„ï¼Œ`tables_info_dict` å‚æ•°éœ€ä¼ å…¥æ•°æ®åº“åŸºæœ¬ä¿¡æ¯å­—å…¸ï¼ˆè¡¨åã€åˆ—åç­‰ï¼‰ï¼Œæˆ‘ä»¬ä»¥è®ºæ–‡æ•°æ®åº“ä¸ºä¾‹ï¼ŒåŸºæœ¬ä¿¡æ¯çš„å®šä¹‰å¦‚ä¸‹ã€‚

```python
table_info = {
    "tables": [{
        "name": "papers",
        "comment": "è®ºæ–‡æ•°æ®",
        "columns": [
            {
                "name": "id",
                "data_type": "Integer",
                "comment": "åºå·",
                "is_primary_key": True,
            },
            {"name": "title", "data_type": "String", "comment": "æ ‡é¢˜"},
            {"name": "author", "data_type": "String", "comment": "ä½œè€…"},
            {"name": "subject", "data_type": "String", "comment": "é¢†åŸŸ"},
        ],
    }]
}
```

### 3. Sql Call

SQL Call æ¨¡å—ä¾èµ–äºSql Managerï¼Œå®ƒèƒ½å¤Ÿæ ¹æ®ç”¨æˆ·é—®é¢˜ç”Ÿæˆç¬¦åˆè¯­ä¹‰æ„å›¾çš„ SQL æŸ¥è¯¢è¯­å¥ï¼Œå¹¶å¯¹æ¥åç«¯æ•°æ®åº“è·å–åŸå§‹æ•°æ®ã€‚è¿™ä¸€æ¨¡å—ä¸ä»…æ˜¯ç»Ÿè®¡åˆ†æçš„å…¥å£ï¼Œä¹Ÿæ˜¯ç¡®ä¿ç»“æœå‡†ç¡®æ€§çš„å…³é”®ã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹æ•°æ®å‡†å¤‡é˜¶æ®µæˆ‘ä»¬å·²ç»æ„å»ºçš„æ•°æ®åº“æ–‡ä»¶ `papers.db` çš„å†…å®¹ï¼Œè¯¥åº“ä¸­åªæœ‰ä¸€å¼ è¡¨ï¼ŒåŒ…å«æ–‡ç« çš„titleã€author å’Œ subject ä¿¡æ¯ï¼š

![image.png](16_images/img6.png)

æ¥ä¸‹æ¥å¼€å§‹å®šä¹‰ sql callï¼š

* é€šè¿‡æŒ‡å®šæ•°æ®åº“åç§°å’Œæ•°æ®è¡¨ä¿¡æ¯åˆ›å»º sql\_managerï¼ŒåŒæ—¶å®ä¾‹åŒ–ä¸€ä¸ªå¤§æ¨¡å‹ç”¨äºå®ç°text2sqlã€‚
* å°†äºŒè€…ä¼ å…¥ä»¥æ„å»ºä¸€ä¸ª SQL Call å·¥ä½œæµ

è¯¥å·¥ä½œæµæ”¯æŒå°†è‡ªç„¶è¯­è¨€æŸ¥è¯¢è½¬åŒ–ä¸º SQL è¯­å¥å¹¶æ‰§è¡ŒæŸ¥è¯¢ï¼Œæœ€ç»ˆè¿”å›ç»“æœã€‚
[ä»£ç GitHubé“¾æ¥ğŸ”—](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter16/sql_call.py#L1)

```python
from lazyllm.tools import SqlManager, SqlCall

sql_manager = SqlManager("sqlite", None, None, None, None, db_name="papers.db",   tables_info_dict=table_info)
sql_llm = lazyllm.OnlineChatModule()
sql_call = SqlCall(sql_llm, sql_manager, 
  use_llm_for_sql_result=False)

query = "åº“ä¸­ä¸€å…±å¤šå°‘ç¯‡æ–‡ç« "
print(sql_call(query))
>>> [{"total_papers": 200}]
while True:
    query = input("è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼š")
    print("answerï¼š")
    print(sql_call(query))
# åº“ä¸­ä¸€å…±å¤šå°‘ç¯‡è®ºæ–‡
# åº“ä¸­æœ€å¤šçš„ä¸‰ä¸ªsubjectæ˜¯ä»€ä¹ˆ
# æŸ¥è¯¢æ•°æ®åº“å¹¶è¿”å› subject åŒ…å«Computer Visionçš„è®ºæ–‡é¢˜ç›®çš„ç»“æœ
```

<div style="text-align:center; margin:20px 0;">
  <video controls style="width:900px; max-width:100%; height:auto; border:1px solid #ccc; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1);">
    <source src="../16_videos/sql_call.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
</div>

### 4. ç»Ÿè®¡åˆ†æagent

è·å–æ•°æ®çš„é—®é¢˜è§£å†³åï¼Œæˆ‘ä»¬å°†è¿›å…¥ç»Ÿè®¡åˆ†æçš„æ ¸å¿ƒæµç¨‹ã€‚æœ¬æ¨¡å—åŸºäºsql callå®ç°æ•´æ¡ç»Ÿè®¡åˆ†æpipelineï¼Œå¯ä»¥çœ‹ä½œä¸€ä¸ªé¢å‘ç»Ÿè®¡ä»»åŠ¡çš„æ™ºèƒ½agentï¼Œèƒ½å¤Ÿæ ¹æ®ç”¨æˆ·é—®é¢˜è‡ªåŠ¨å®Œæˆ **æ•°æ®åº“æŸ¥è¯¢ â†’ æ•°æ®åˆ†æ â†’ å›¾è¡¨ç”Ÿæˆ â†’ ç»“æœæ±‡æ€»** çš„å®Œæ•´é—­ç¯æµç¨‹ã€‚ä¸ºç”¨æˆ·æä¾›å›¾æ–‡å¹¶èŒ‚çš„ç­”æ¡ˆã€‚

![image.png](16_images/img7.png)

#### ï¼ˆ1ï¼‰ä»£ç ç¼–å†™

æˆ‘ä»¬é¦–å…ˆå®šä¹‰ä¸¤ä¸ªå·¥å…·ï¼ˆToolï¼‰ï¼Œåˆ†åˆ«ç”¨äº **SQL æŸ¥è¯¢** å’Œ â€‹**ä»£ç æ‰§è¡Œ**â€‹ï¼Œå¹¶å°†å®ƒä»¬ä½œä¸ºå¯é€‰å·¥å…·æä¾›ç»™ Agentï¼Œæ”¯æŒå…¶åœ¨æ‰§è¡Œä»»åŠ¡è¿‡ç¨‹ä¸­å®Œæˆæ•°æ®åº“æŸ¥è¯¢å’Œç»Ÿè®¡åˆ†æã€‚

* `run_sql_query` æ–¹æ³•åŸºäºä¸Šä¸€èŠ‚æ„å»ºçš„ SQL Call å·¥ä½œæµå°è£…è€Œæˆï¼ŒAgent å¯åœ¨ä»ç”¨æˆ·æŸ¥è¯¢ä¸­è§£æå‡º SQL ç›¸å…³éœ€æ±‚åè°ƒç”¨è¯¥æ–¹æ³•ï¼Œè·å–ç»“æ„åŒ–æŸ¥è¯¢ç»“æœã€‚
* `run_code` æ–¹æ³•ç”¨äºæ¥æ”¶å¹¶æ‰§è¡Œå¤§æ¨¡å‹ç”Ÿæˆçš„ç»Ÿè®¡åˆ†æä»£ç ã€‚è¯¥æ–¹æ³•ä¼šè¿”å›å…³é”®ç»“æœæˆ–æŠ¥é”™ä¿¡æ¯ï¼Œä¸ºå¤§æ¨¡å‹ä¸‹ä¸€æ­¥çš„å†³ç­–å’Œè¡ŒåŠ¨æä¾›åé¦ˆä¾æ®ã€‚
  
  è¿™ä¸¤ä¸ªå·¥å…·é…åˆä½¿ç”¨ï¼Œä½¿ Agent èƒ½å¤ŸåŠ¨æ€å®Œæˆä»æ•°æ®è·å–åˆ°åˆ†ææ‰§è¡Œçš„å…¨æµç¨‹ä»»åŠ¡ã€‚

```python
@fc_register("tool")
def run_sql_query(query):
    """
    Automatically generates and executes an SQL query based on a natural language request.

    Given a natural language query describing a data retrieval task, this function generates the corresponding SQL 
    statement, executes it against the database, and returns the result.

    Args:
        query (str): A natural language description of the desired database query.

    Returns:
        list[dict]: A list of records returned from the SQL query, where each record is represented as a dictionary.
    """
    sql_manager = SqlManager("sqlite", None, None, None, None, db_name="papers.db", tables_info_dict=table_info)
    sql_llm = lazyllm.OnlineChatModule(source="sensenova")
    sql_call = SqlCall(sql_llm, sql_manager, use_llm_for_sql_result=False)
    return sql_call(query)


@fc_register("tool")
def run_code(code: str):
    """
    Run the given code in a separate thread and return the result.

    Args:
        code (str): code to run.
    Returns:
        dict: {
            "text": str,
            "error": str or None,
        }
    """
    result = {
        "text": "",
        "error": None,
    }

    def code_thread():
        nonlocal result
        stdout = io.StringIO()
        try:
            with contextlib.redirect_stdout(stdout):
                exec_globals = {}
                exec(code, exec_globals)
        except Exception:
            result["error"] = traceback.format_exc()
        result["text"] = stdout.getvalue()

    thread = threading.Thread(target=code_thread)
    thread.start()
    thread.join(timeout=10)

    if thread.is_alive():
        result["error"] = "Execution timed out."
        thread.join()  

    return result
```

> æ³¨æ„ï¼åœ¨æ’°å†™å‡½æ•°æ—¶ï¼Œä¸€å®šè¦åœ¨å‡½æ•°ä¸‹æ–¹åŠ ä¸Šæ³¨é‡Šï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```python
def myfunction(arg1: str, arg2: Dict[str, Any], arg3: Literal["aaa", "bbb", "ccc"]="aaa"):
       '''
       Function description ...

       Args:
              arg1 (str): arg1 description.
              arg2 (Dict[str, Any]): arg2 description
              arg3 (Literal["aaa", "bbb", "ccc"]): arg3 description
       '''
```

> åœ¨å¤§æ¨¡å‹è°ƒç”¨è¯¥å‡½æ•°æ—¶ï¼Œå°†é€šè¿‡å‡½æ•°çš„æè¿°ï¼Œä»¥åŠå‚æ•°çš„è¡¨è¿°ï¼Œå†³å®šä½•æ—¶è°ƒç”¨ä»¥åŠä¼ å…¥å‚æ•°ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å®ç°agentå®šä¹‰ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨lazyllmå†…ç½®çš„ReactAgentå·¥å…·ï¼Œå°†å‰æ–‡ä¸­å®šä¹‰çš„ä¸¤ä¸ªå·¥å…·ä¼ å…¥toolså‚æ•°ï¼Œå³å¯å®ç°æ¨¡å‹è‡ªåŠ¨è°ƒç”¨ã€‚

> ReactAgentæ˜¯æŒ‰ç…§ `Thought->Action->Observation->Thought...->Finish` çš„æµç¨‹ä¸€æ­¥ä¸€æ­¥çš„é€šè¿‡LLMå’Œå·¥å…·è°ƒç”¨æ¥æ˜¾ç¤ºè§£å†³ç”¨æˆ·é—®é¢˜çš„æ­¥éª¤ï¼Œæœ€åè¾“å‡ºæœ€ç»ˆç­”æ¡ˆã€‚

```python
from lazyllm.tools.agent import ReactAgent

agent = ReactAgent(
        llm=lazyllm.OnlineChatModule(stream=False),
        tools=['run_code', 'run_sql_query'],
        return_trace=True,
        max_retries=3,
    )
```

ç„¶ååŸºäºä¸Šè¿°agentï¼Œæˆ‘ä»¬å®šä¹‰promptï¼Œå¹¶æ­å»ºæ”¯æŒç»Ÿè®¡é—®é¢˜çš„sqlé—®ç­”æµç¨‹ï¼š

```python
sql_prompt = """
ä½ æ˜¯ä¸€ä½èµ„æ·±æ•°æ®ç§‘å­¦å®¶ï¼Œéœ€è¦åŸºäºç»™å®šçš„é—®é¢˜è¿›è¡Œå¿…è¦çš„ç»Ÿè®¡åˆ†æå’Œç»˜å›¾ï¼Œæ¥å›ç­”ç”¨æˆ·æå‡ºçš„ç»Ÿè®¡é—®é¢˜ã€‚
ä½ çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

1. ç†è§£é—®é¢˜å¹¶è¿›è¡Œæ•°æ®æŸ¥è¯¢
   - æ‹†è§£é—®é¢˜ä¸­éœ€è¦æŸ¥è¯¢æ•°æ®åº“çš„éƒ¨åˆ†ï¼Œè°ƒç”¨ç›¸åº”å·¥å…·è¿›è¡Œæ•°æ®è·å–ã€‚

2. åˆ¤æ–­æ ¹æ®æ•°æ®æ˜¯å¦å¯ç›´æ¥å¾—å‡ºç»Ÿè®¡é—®é¢˜çš„ç­”æ¡ˆ  
   - å¦‚æœæ•°æ®å¯ä»¥ç›´æ¥å›ç­”ç»Ÿè®¡é—®é¢˜ï¼Œåˆ™ç›´æ¥è¾“å‡ºç»“æœï¼Œå¿…è¦æ—¶è¡¥å……ç»˜åˆ¶å›¾è¡¨ã€‚
   - å¦‚æœä¸è¶³ä»¥å›ç­”ï¼Œåˆ™å…ˆè¿›è¡Œå¿…è¦çš„æ•°æ®åˆ†æï¼Œå†æ ¹æ®éœ€è¦ç»˜åˆ¶å›¾è¡¨ã€‚

3. é€šè¿‡ç¼–å†™ä»£ç å¹¶æ‰§è¡Œå¹¶è·å–ç»“æœçš„æ–¹å¼å®ç°æ•°æ®åˆ†æå’Œç»˜å›¾
   - ç¼–å†™å®Œæ•´å¯æ‰§è¡Œçš„ Python ä»£ç ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦çš„ importã€æ•°æ®åŠ è½½ã€åˆ†æé€»è¾‘ã€ç»˜å›¾ä»£ç ã€ç»“æœè¾“å‡ºã€‚  
   - ä½¿ç”¨å¸¸è§æ•°æ®ç§‘å­¦å·¥å…·åŒ…ï¼ˆå¦‚ pandasã€numpyã€scikit-learn ç­‰ï¼‰è¿›è¡Œæ•°æ®åˆ†æã€‚  
   - ä½¿ç”¨å¯è§†åŒ–å·¥å…·ï¼ˆå¦‚ matplotlibã€seabornï¼‰è¿›è¡Œå›¾è¡¨ç»˜åˆ¶ã€‚

4. å›¾åƒä¿å­˜  
   - æ‰€æœ‰ç”Ÿæˆçš„å›¾åƒå¿…é¡»ä¿å­˜åˆ°ä»¥ä¸‹è·¯å¾„ï¼š  
     {image_path}
   - ä¿å­˜æˆåŠŸåï¼Œä½¿ç”¨ä»¥ä¸‹æ ¼å¼å°†å›¾ç‰‡å±•ç¤ºåœ¨æœ€ç»ˆå›ç­”ä¸­ï¼ˆAnsweréƒ¨åˆ†ï¼‰ï¼ˆimage_nameä¸ºä¿å­˜çš„æ–‡ä»¶åï¼Œimage_pathä¸ºå®Œæ•´è·¯å¾„ï¼‰ï¼š 
     ![image_name](image_path)

5. é”™è¯¯å¤„ç†  
   - å¦‚æœä»£ç æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ ¹æ®æŠ¥é”™ä¿¡æ¯è‡ªåŠ¨ä¿®æ”¹ä»£ç å¹¶é‡æ–°æ‰§è¡Œï¼Œç›´åˆ°æˆåŠŸã€‚

é—®é¢˜ï¼š  
{query}

"""

with pipeline() as sql_ppl:
    sql_ppl.formarter = lambda query: sql_prompt.format(query=query, image_path=IMAGE_PATH) 
    sql_ppl.agent = ReactAgent(
            llm=lazyllm.OnlineChatModule(stream=False),
            tools=['run_code', 'run_sql_query'],
            return_trace=True,
            max_retries=3,
        )
    sql_ppl.clean_output = lazyllm.ifs(lambda x: "Answer:" in x, lambda x: x.split("Answer:")[-1], lambda x:x)

if __name__ == '__main__':
    lazyllm.WebModule(sql_ppl, port=23456, static_paths=image_save_path).start().wait()
```

#### ï¼ˆ2ï¼‰ç»“æœå±•ç¤º

è®©æˆ‘ä»¬æ ¹æ®ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹queryæ¥æ¢³ç†ä¸‹ä»£ç å®Œæ•´çš„æ‰§è¡Œè¿‡ç¨‹ï¼š

<div style="text-align:center; margin:20px 0;">
  <video controls style="width:900px; max-width:100%; height:auto; border:1px solid #ccc; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1);">
    <source src="../16_videos/function_call.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
</div>

## äº”ã€æ„å»ºæ”¯æŒç»Ÿè®¡åˆ†æçš„è®ºæ–‡é—®ç­”ç³»ç»Ÿ

åœ¨æŒæ¡äº†ç³»ç»Ÿæ‰€ä¾èµ–çš„å„é¡¹å…³é”®æŠ€æœ¯ä¹‹åï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å¼€å§‹åŠ¨æ‰‹æ„å»ºä¸€ä¸ªå®é™…å¯ç”¨çš„ç³»ç»Ÿï¼Œä»¥æ”¯æŒç»Ÿè®¡åˆ†æä¸çŸ¥è¯†é—®ç­”çš„èåˆèƒ½åŠ›ã€‚

æ•´ä¸ªç³»ç»Ÿçš„æ¶æ„å¦‚ä¸‹ï¼š

![image.png](16_images/img8.png)

ã€ä»£ç å®ç°ã€‘

æˆ‘ä»¬æ¥çœ‹æ€ä¹ˆåˆ©ç”¨ä¸Šæ–‡å·²ç»ç»™å‡ºçš„ç»“æ„æ­å»ºå®Œæ•´çš„å¤šåŠŸèƒ½é—®ç­”å·¥ä½œæµã€‚æ•´ä½“æ€è·¯å¦‚ä¸‹ï¼š

æˆ‘ä»¬é¦–å…ˆåˆ†åˆ«å®šä¹‰ä¸¤ä¸ªå­å·¥ä½œæµï¼š

* `chat_ppl`ï¼šç”¨äºå¤„ç†åŸºäº RAGï¼ˆRetrieval-Augmented Generationï¼‰çš„é€šç”¨é—®ç­”ä»»åŠ¡ï¼›
* `sql_ppl`ï¼šç”¨äºå¤„ç†ä¸ç»Ÿè®¡åˆ†æç›¸å…³çš„ SQL é—®ç­”ä»»åŠ¡ã€‚

éšåï¼Œåœ¨ä¸»å·¥ä½œæµä¸­å¼•å…¥ä¸€ä¸ªâ€‹**æ„å›¾è¯†åˆ«æ¨¡å—**â€‹ï¼Œç”¨äºè§£æç”¨æˆ·çš„æŸ¥è¯¢æ„å›¾ï¼Œå¹¶æ®æ­¤åœ¨ `chat_ppl` ä¸ `sql_ppl` ä¸¤æ¡å­å·¥ä½œæµä¸­é€‰æ‹©é€‚åˆçš„è·¯å¾„è¿›è¡Œå¤„ç†ã€‚é€šè¿‡è¿™æ ·çš„ç»“æ„è®¾è®¡ï¼Œç³»ç»Ÿèƒ½å¤Ÿæ ¹æ®ç”¨æˆ·é—®é¢˜çš„ç±»å‹è‡ªåŠ¨åŒ¹é…åˆé€‚çš„å·¥ä½œæµï¼Œå®ç°å¯¹è‡ªç„¶è¯­è¨€é—®ç­”å’Œç»Ÿè®¡åˆ†æä»»åŠ¡çš„ç»Ÿä¸€è°ƒåº¦ä¸å¤„ç†ã€‚

**â€‹æ³¨æ„ï¼Œåœ¨ç¬¬9ã€10è¡Œï¼Œæˆ‘ä»¬é€šè¿‡æ¨¡å—å¯¼å…¥çš„æ–¹å¼å¯¼å…¥åœ¨ç¬¬14è®²ä»‹ç»çš„rag pipelineï¼ˆ`build_paper_rag()`â€‹ï¼‰å’Œä¸Šæ–‡å®šä¹‰çš„ sql pipelineï¼ˆ`build_statistical_agent()`ï¼‰ï¼Œåœ¨æ­¤ä¸åœ¨é‡å¤ç¼–ç ã€‚**

[ä»£ç GitHubé“¾æ¥ğŸ”—](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter16/statistical_agent.py#L1)

```python
import lazyllm
from lazyllm import OnlineChatModule, pipeline, _0
from lazyllm.tools import IntentClassifier

from statistical_agent import build_statistical_agent
from paper_rag import build_paper_rag

# æ„å»º rag å·¥ä½œæµå’Œç»Ÿè®¡åˆ†æå·¥ä½œæµ
rag_ppl = build_paper_rag()
sql_ppl = build_statistical_agent()

# æ­å»ºå…·å¤‡çŸ¥è¯†é—®ç­”å’Œç»Ÿè®¡é—®ç­”èƒ½åŠ›çš„ä¸»å·¥ä½œæµ
def build_paper_assistant():
    llm = OnlineChatModule(source='qwen', stream=False)
    intent_list = [
        "è®ºæ–‡é—®ç­”",
        "ç»Ÿè®¡é—®ç­”",
    ]

    with pipeline() as ppl:
        ppl.classifier = IntentClassifier(llm, intent_list=intent_list)
        with lazyllm.switch(judge_on_full_input=False).bind(_0, ppl.input) as ppl.sw:
            ppl.sw.case[intent_list[0], rag_ppl]
            ppl.sw.case[intent_list[1], sql_ppl]

    return ppl

if __name__ == "__main__":
    main_ppl = build_paper_assistant()
    lazyllm.WebModule(main_ppl, port=23459, static_paths="./images").start().wait()
```

ç„¶åæˆ‘ä»¬å°±å¯ä»¥å¯åŠ¨è¿™ä¸ªå·¥ä½œæµäº†ã€‚æˆ‘ä»¬ä½¿ç”¨ WebModule æ¥å¯åŠ¨æœåŠ¡ï¼Œé€šè¿‡ WebModule æŠŠä¸Šé¢å®šä¹‰çš„å·¥ä½œæµåˆ›å»ºæˆä¸€ä¸ª web æœåŠ¡ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ï¼Œå¯åŠ¨ WebModule æ—¶ï¼Œéœ€è¦ä¼ å…¥å›¾ç‰‡çš„ä¿å­˜è·¯å¾„ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠè¯¥ç›®å½•è®¾ç½®ä¸ºé™æ€ç›®å½•ï¼Œgradio å°±å¯ä»¥ç›´æ¥è®¿é—®è¯¥ç›®å½•ä¸‹çš„å›¾ç‰‡æ–‡ä»¶äº†ã€‚å½“ web æœåŠ¡å¯åŠ¨æˆåŠŸåï¼Œåˆ™æ ¹æ®å¯åŠ¨åçš„ ip å’Œ portï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨æµè§ˆå™¨ä¸­ä½“éªŒä½¿ç”¨äº†ã€‚

ã€æ•ˆæœå±•ç¤ºã€‘

<div style="text-align:center; margin:20px 0;">
  <video controls style="width:900px; max-width:100%; height:auto; border:1px solid #ccc; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1);">
    <source src="../16_videos/sql+fuc.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
</div>

### **ç®€å•ç»Ÿè®¡é—®é¢˜ï¼ˆä¸éœ€è¦ç”»å›¾ï¼‰**

![image.png](16_images/img9.png)

**å¤„ç†æµç¨‹åˆ†æï¼š**

1. ç”¨æˆ·è¾“å…¥query **"åº“ä¸­ä¸€å…±æœ‰å¤šå°‘ç¯‡è®ºæ–‡"**
2. å¤§æ¨¡å‹æå–æ•°æ®æŸ¥è¯¢é—®é¢˜"åº“ä¸­ä¸€å…±å¤šå°‘ç¯‡è®ºæ–‡" è°ƒç”¨`SqlCall`ï¼š

```bash
inputï¼š 
"åº“ä¸­ä¸€å…±å¤šå°‘ç¯‡è®ºæ–‡"

text2sqlï¼š
select count(*) as total_papser from papers;

outputï¼š
[{"total_papers": 100}]
```

3. æ¨¡å‹åˆ¤æ–­è¯¥ç»“æœå·²ç»å¯ä»¥å›ç­”queryçš„é—®é¢˜ï¼Œç›´æ¥è¾“å‡ºå›ç­”â€åº“ä¸­ä¸€å…±æœ‰100ç¯‡è®ºæ–‡â€œã€‚

ã€é™„ï¼šæ‰§è¡Œæ—¥å¿—ã€‘

![image.png](16_images/img10.png)

---

### ç®€å•ç»Ÿè®¡é—®é¢˜ï¼ˆéœ€è¦ç”»å›¾ï¼‰

![image.png](16_images/img11.png)

1. ç”¨æˆ·è¾“å…¥query **"æ ¹æ®æ•°æ®åº“é‡Œçš„æ•°æ®ï¼Œå‘Šè¯‰æˆ‘æœ€å¤šçš„ä¸‰ä¸ªsubjectæ˜¯ä»€ä¹ˆï¼Œå¹¶ç»˜åˆ¶æŸ±çŠ¶å›¾"**
2. å¤§æ¨¡å‹å°†å¯¹ä¼ å…¥çš„`query`è¿›è¡Œåˆ†æï¼Œåˆ¤å®šéœ€è¦è°ƒç”¨run\_sql\_queryå·¥å…·è·å–æ•°æ®ï¼Œå…¶ä¼šè°ƒç”¨`lazyllm`å†…ç½®çš„Sqlè°ƒåº¦å·¥å…·`SqlCall`ï¼Œå®ƒå¯ä»¥è‡ªåŠ¨æ‰§è¡Œç›¸åº”çš„sqlæŸ¥è¯¢è¯­å¥ï¼Œä»æ•°æ®åº“ä¸­è·å¾—ç›¸åº”çš„ç»“æœï¼Œç»“æœå¦‚ä¸‹ã€‚

```bash
inputï¼š
 "æ‰¾å‡ºæ•°æ®åº“ä¸­æ•°é‡æœ€å¤šçš„ä¸‰ä¸ªsubjectåŠå…¶æ•°é‡"
 
text2sqlï¼š
select subject, count(*) as count
from papsers
group by count desc
limit 3;

outputï¼š
[{"subject": "\nComputer Vision and Pattern Recognition (cs.CV)", "count": 25}, {"subject": "\nRobotics (cs.RO)", "count": 6}, {"subject": "\nComputation and Language (cs.CL)", "count": 5}]
```

3. æ¨¡å‹åˆ¤æ–­è¯¥ç»“æœå·²ç»å¯ä»¥å›ç­”queryçš„é—®é¢˜ï¼Œä¸éœ€è¦è¿›ä¸€æ­¥è¿›è¡Œç»Ÿè®¡åˆ†æï¼Œä½†æ˜¯queryä¸­åŒ…å«ä½œå›¾éœ€æ±‚ï¼Œå› æ­¤å…¶ç¼–å†™ä»…ç”¨äºä½œå›¾çš„pythonä»£ç å¹¶è°ƒç”¨run\_codeå·¥å…·æ‰§è¡Œï¼Œä»¥ä¸‹ä¸ºå¤§æ¨¡å‹ç¼–å†™çš„ä»£ç ã€‚

```python
import matplotlib.pyplot as plt
import numpy as np

# æ•°æ®
labels = ['Computer Vision and Pattern Recognition (cs.CV)', 'Robotics (cs.RO)', 'Computation and Language (cs.CL)']
counts = [25, 6, 5]

# åˆ›å»ºæŸ±çŠ¶å›¾
x = np.arange(len(labels))
width = 0.35
fig, ax = plt.subplots()
rects = ax.bar(x, counts, width)

# æ·»åŠ æ ‡ç­¾ã€æ ‡é¢˜å’Œåˆ»åº¦
ax.set_ylabel('Count')
ax.set_title('Top Three Subjects')
ax.set_xticks(x)
ax.set_xticklabels(labels, rotation=45)

# æ˜¾ç¤ºå›¾è¡¨
plt.tight_layout()
image_path = './images/top_three_subjects.png'
plt.savefig(image_path)
```

4. ä½œå›¾å®Œæˆåå¤§æ¨¡å‹æ ¹æ®å›¾ç‰‡è·¯å¾„å¹¶æ•´åˆä¹‹å‰çš„ç»“æœä¸ºç”¨æˆ·ç”Ÿæˆæœ€ç»ˆçš„å›¾æ–‡å¹¶èŒ‚çš„å›ç­”ã€‚

ã€é™„ï¼šæ‰§è¡Œæ—¥å¿—ã€‘

![image.png](16_images/img12.png)

---

### å¤æ‚ç»Ÿè®¡é—®é¢˜ï¼ˆéœ€è¦ç”»å›¾ï¼‰

![image.png](16_images/img13.png)

**å¤„ç†æµç¨‹åˆ†æï¼š**

1. ç”¨æˆ·è¾“å…¥query **"æŸ¥è¯¢æ•°æ®åº“ä¸­æ‰€æœ‰è®ºæ–‡çš„é¢˜ç›®ï¼ŒåŸºäºé¢˜ç›®å†…å®¹å°†è®ºæ–‡èšç±»ä¸º5ç±»ï¼Œæ¯ç±»åˆ†åˆ«åˆ—ä¸¾å‡ ä¸ªæ–‡ç« ï¼Œå¹¶ç”¨æŸ±çŠ¶å›¾å±•ç¤ºæ¯ç±»çš„è®ºæ–‡æ•°é‡"**
2. å¤§æ¨¡å‹æå–æ•°æ®æŸ¥è¯¢é—®é¢˜"åº“ä¸­ä¸€å…±å¤šå°‘ç¯‡è®ºæ–‡" è°ƒç”¨`SqlCall`ï¼š

```bash
inputï¼š 
"æŸ¥è¯¢åº“ä¸­æ‰€æœ‰è®ºæ–‡é¢˜ç›®"

text2sqlï¼š
select title from papers;

outputï¼š
["View Selection for 3D Captioning via Diffusion Ranking", "The Role of Language Imbalance in Cross-lingual Generalisation: Insights from Cloned Language Experiments", "OSWorld: Benchmarking Multimodal Agents for Open-Ended Tasks in Real Computer Environments", "Ferret-v2: An Improved Baseline for Referring and Grounding with Large Language Models", "Rho-1: Not All Tokens Are What You Need", "Lyapunov-stable Neural Control for State and Output Feedback: A Novel Formulation", "On Unified Prompt Tuning for Request Quality Assurance in Public Code Review", "AmpleGCG: Learning a Universal and Transferable Generative Model of Adversarial Suffixes for Jailbreaking Both Open and Closed LLMs", "High-Dimension Human Value Representation in Large Language Models", "Overparameterized Multiple Linear Regression as Hyper-Curve Fitting", ...]
```

3. æ¨¡å‹ç¼–å†™ç¨‹åºè¿›ä¸€æ­¥è¿›è¡Œç»Ÿè®¡åˆ†æä»»åŠ¡ï¼Œå¹¶è°ƒç”¨ `run code` å·¥å…·æ‰§è¡Œã€‚

[å®Œæ•´ä»£ç GitHubé“¾æ¥ğŸ”—](https://github.com/LazyAGI/Tutorial/blob/7abc91dbb82a007a78731845dd8c360ac0cc1e75/rag/codes/chapter16/chat_sql_qa.py#L1)

```python
import pandas as pd
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.cluster import KMeans
import matplotlib.pyplot as plt
import os

# Load data
data = ["View Selection for 3D Captioning via Diffusion Ranking", "The Role of Language Imbalance in Cross-lingual Generalisation: Insights from Cloned Language Experiments", "OSWorld: Benchmarking Multimodal Agents for Open-Ended Tasks in Real Computer Environments", "Ferret-v2: An Improved Baseline for Referring and Grounding with Large Language Models", "Rho-1: Not All Tokens Are What You Need", "Lyapunov-stable Neural Control for State and Out..."]
# Create DataFrame
df = pd.DataFrame(data, columns=['title'])

# Vectorize titles
tfidf = TfidfVectorizer(stop_words='english')
X = tfidf.fit_transform(df['title'])

# Perform K-means clustering
kmeans = KMeans(n_clusters=5, random_state=42)
df['cluster'] = kmeans.fit_predict(X)

# Count papers per cluster
cluster_counts = df['cluster'].value_counts().sort_index()

# Plot cluster counts
plt.figure(figsize=(10, 6))
cluster_counts.plot(kind='bar', color='skyblue')
plt.title('Number of Papers per Cluster')
plt.xlabel('Cluster')
plt.ylabel('Count')
plt.xticks(rotation=0)

# Save plot
os.makedirs('./images', exist_ok=True)
image_path = './images/cluster_counts.png'
plt.savefig(image_path)
plt.close()

# Print cluster counts and example titles
print("Cluster Counts:")
print(cluster_counts)
print("\nExample Titles per Cluster:")
for cluster in range(5):
    print(f"\nCluster {cluster}:")
    print(df[df['cluster'] == cluster]['title'].head(3).to_string(index=False))

print(f"\nImage saved at: {image_path}")
```

4. æ‰§è¡Œå®Œæ¯•åå¤§æ¨¡å‹æ¥æ”¶åˆ°å›¾ç‰‡è·¯å¾„å’Œæ¯ç±»çš„ç»“æœï¼Œä¸ºç”¨æˆ·ç”Ÿæˆå›¾æ–‡å¹¶èŒ‚çš„å›ç­”ã€‚

ã€é™„ï¼šè¿è¡Œæ—¥å¿—ã€‘

![image.png](16_images/img15.png)
![image-2.png](16_images/img14.png)

### çŸ¥è¯†é—®ç­”

![image.png](16_images/img16.png)

è‡³æ­¤ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªåŒæ—¶å…·å¤‡**çŸ¥è¯†åº“é—®ç­”**ä¸**ç»Ÿè®¡åˆ†æ**èƒ½åŠ›çš„æ™ºèƒ½é—®ç­”ç³»ç»Ÿã€‚è¯¥ç³»ç»Ÿä¸ä»…æ”¯æŒç”¨æˆ·å›´ç»•æ–‡çŒ®å†…å®¹è¿›è¡Œè¯­ä¹‰æé—®ï¼Œè¿˜èƒ½å¤Ÿé’ˆå¯¹æ•°æ®åº“ä¸­çš„ç»“æ„åŒ–ä¿¡æ¯æ‰§è¡Œç»Ÿè®¡åˆ†æä¸å›¾è¡¨ç»˜åˆ¶ï¼Œä»è€Œæ”¯æŒå…¨å±€çš„æ•°æ®è§‚å¯Ÿéœ€æ±‚ã€‚

## å…­ã€RAGè®ºæ–‡ç³»ç»Ÿç»¼åˆå¤šæ¨¡æ€æ–¹æ¡ˆ

![image.png](16_images/img17.png)

ä¸»è¦ä»£ç å®ç°ï¼š

```python
# æ„å»º rag å·¥ä½œæµå’Œç»Ÿè®¡åˆ†æå·¥ä½œæµ
rag_ppl = build_paper_rag()
sql_ppl = build_statistical_agent()

# æ­å»ºå…·å¤‡çŸ¥è¯†é—®ç­”å’Œç»Ÿè®¡é—®ç­”èƒ½åŠ›çš„ä¸»å·¥ä½œæµ
def build_paper_assistant():
    llm = OnlineChatModule(source='qwen', stream=False)
    vqa = lazyllm.OnlineChatModule(source="sensenova",\
        model="SenseNova-V6-Turbo").prompt(lazyllm.ChatPrompter(gen_prompt))

    with pipeline() as ppl:
        ppl.ifvqa = lazyllm.ifs(
            lambda x: x.startswith('<lazyllm-query>'),
            lambda x: vqa(x), lambda x:x)
        with IntentClassifier(llm) as ppl.ic:
            ppl.ic.case["è®ºæ–‡é—®ç­”", rag_ppl]
            ppl.ic.case["ç»Ÿè®¡é—®ç­”", sql_ppl]

    return ppl

if __name__ == "__main__":
    main_ppl = build_paper_assistant()
    lazyllm.WebModule(main_ppl, port=23459, static_paths="./images", encode_files=True).start().wait()
```

ã€æ•ˆæœå±•ç¤ºã€‘

<div style="text-align:center; margin:20px 0;">
  <video controls style="width:900px; max-width:100%; height:auto; border:1px solid #ccc; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1);">
    <source src="../16_videos/rag_multimodal.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
</div>

## æ‰©å±•é˜…è¯»ï¼šä»çŸ¥è¯†åº“æ„å»ºæ•°æ®åº“

ä»£ç å®ç°ï¼š

```python
import lazyllm
from lazyllm.tools import SqlManager

# åˆ›å»ºSQLç®¡ç†å™¨
sql_manager = SqlManager(db_type="SQLite", user=None,
   password=None, host=None, port=None, db_name="doc.db")
# åˆ›å»ºçŸ¥è¯†åº“
documents = lazyllm.Document(dataset_path='/path/to/kb', create_ui=False)
# é…ç½®æå–å­—æ®µ
refined_schema = [
    {"key": "document_title", "desc": "The title of the paper.", "type": "text"},
    {"key": "author_name", "desc": "The names of the author of the paper.", "type": "text"},
    {"key": "keywords", "desc": "Key terms or themes discussed in the paer.", "type": "text"},
    {"key": "content_summary", "desc": "A brief summary of the paper's main content", "type": "text"},
]
# çŸ¥è¯†åº“è¿æ¥åˆ°SQLå¹¶è®¾ç½®å¾…æå–å­—æ®µ
documents.connect_sql_manager(
    sql_manager=sql_manager,
    schma=refined_schema,
    force_refresh=True,
)
# å¼€å§‹æå–çŸ¥è¯†åº“åˆ°æ•°æ®é›†
documents.update_database(llm=lazyllm.OnlineChatModule(source="qwen"))
# å±•ç¤ºæå–åˆ°çš„å†…å®¹ï¼š
str_result = sql_manager.execute_query(f"select * from {documents._doc_to_db_processor.doc_table_name}")
print(f"str_result: {str_result}")
```

ã€æ•ˆæœå±•ç¤ºã€‘

![image.png](16_images/img18.png)

```python
[
    {
        "lazyllm_uuid": "2c42c181-bc26-43ca-a822-505b22f5d19e",
        "lazyllm_created_at": "2025-05-16 19:10:12.014368",
        "lazyllm_doc_path": "/path/to/pdfs/DeepSeek_R1.pdf",
        "document_title": "DeepSeek-R1: Incentivizing Reasoning Capability in LLMs via Reinforcement Learning",
        "author_name": "DeepSeek-AI",
        "keywords": "DeepSeek-R1-Zero, DeepSeek-R1, reinforcement learning, reasoning models, multi-stage training, open-source, dense models, distilled models, Qwen, Llama",
        "content_summary": "The paper introduces the first-generation reasoning models, DeepSeek-R1-Zero and DeepSeek-R1. DeepSeek-R1-Zero is trained using large-scale reinforcement learning without supervised fine-tuning and demonstrates strong reasoning capabilities but faces challenges such as poor readability and language mixing. To improve upon this, DeepSeek-R1 incorporates multi-stage training and cold-start data before reinforcement learning, achieving performance comparable to OpenAI-o1-1217 on reasoning tasks. The research community is supported by the open-sourcing of DeepSeek-R1-Zero, DeepSeek-R1, and six dense models distilled from DeepSeek-R1 based on Qwen and Llama."
    }
]
```