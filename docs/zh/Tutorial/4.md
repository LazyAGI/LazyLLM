# ç¬¬4è®²ï¼šRAGé¡¹ç›®å·¥ç¨‹åŒ–å…¥é—¨ï¼šä»è„šæœ¬èµ°å‘æ¨¡å—åŒ–ä¸å¯ç»´æŠ¤æ€§

> ä¸€ä¸ªé¡¹ç›®å¦‚æœä»£ç ä¸è§„èŒƒä¼šå¯¼è‡´å¯è¯»æ€§å·®ã€ç»´æŠ¤å›°éš¾ã€å®¹æ˜“å¼•å…¥ Bugï¼Œå¹¶é™ä½ä»£ç çš„å¯æ‰©å±•æ€§å’Œä¸€è‡´æ€§ã€‚åœ¨å›¢é˜Ÿåä½œä¸­ï¼Œä¸ç»Ÿä¸€çš„é£æ ¼ä¼šå¢åŠ åˆå¹¶å†²>çªï¼Œå½±å“å¼€å‘æ•ˆç‡ã€‚æ­¤å¤–ï¼Œä»£ç ä¸è§„èŒƒå¯èƒ½å¯¼è‡´æµ‹è¯•å›°éš¾ï¼Œå½±å“ CI/CD æµç¨‹ï¼Œç”šè‡³å¸¦æ¥å®‰å…¨éšæ‚£ã€‚
>
> æœ¬æ•™ç¨‹å°†å¸¦ä½ ä»é›¶å¼€å§‹ï¼Œå°†ä¸€ä¸ªç®€å•çš„ Python è„šæœ¬é€æ­¥æ¼”åŒ–ä¸ºè§„èŒƒçš„å·¥ç¨‹é¡¹ç›®ï¼Œæ¶µç›– Gitç‰ˆæœ¬ç®¡ç†ã€ä»£ç è§„èŒƒæ£€æŸ¥ã€å•å…ƒæµ‹è¯•ã€CI/CDã€æ–‡æ¡£ç®¡ç†ï¼Œä»¥åŠæ‰“åŒ…å‘å¸ƒç­‰å…³é”®ç¯èŠ‚ã€‚

---

## 1. ä»£ç ç®¡ç†ï¼šä»é›¶å¼€å§‹æ­å»º Git é¡¹ç›®

### 1.1 ä»€ä¹ˆæ˜¯`Git`

* `Git` æ˜¯ä¸€ä¸ªâ€‹**åˆ†å¸ƒå¼ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ**â€‹ï¼Œç”¨äºè·Ÿè¸ªæ–‡ä»¶çš„æ›´æ”¹ï¼Œç‰¹åˆ«é€‚ç”¨äºè½¯ä»¶å¼€å‘ã€‚å®ƒå…è®¸å¤šä¸ªå¼€å‘è€…åä½œå¼€å‘ä»£ç ï¼ŒåŒæ—¶ä¿ç•™æ‰€æœ‰æ›´æ”¹çš„å†å²è®°å½•ã€‚[è¯¦è¿°](https://git-scm.com/video/what-is-git)

### â€‹1.2â€‹ ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ Git

* ä»£ç å†å²å¯è¿½æº¯ï¼Œæ”¯æŒç‰ˆæœ¬å›æ»š
* æ”¯æŒå¤šäººåä½œï¼Œæé«˜å›¢é˜Ÿæ•ˆç‡
* ä¾¿äºåˆ†æ”¯ç®¡ç†ï¼Œé™ä½å¼€å‘å†²çª
* å¯æ‰˜ç®¡åˆ° github gitlabç­‰ï¼Œæ–¹ä¾¿å¤‡ä»½ä¸å…±äº«

### â€‹1.3 åˆ›å»ºä¸€ä¸ªGitHubé¡¹ç›®

* é¦–å…ˆä½ è¦æœ‰ä¸€ä¸ª GitHub è´¦å·ï¼Œå¦‚æœæ²¡æœ‰çš„è¯è¯·å…ˆ [æ³¨å†Œ](https://github.com/join)
* ç™»é™†è´¦å·ï¼Œ[åˆ›å»ºä¸€ä¸ªé¡¹ç›®](https://github.com/new)ï¼ˆNew repositoryï¼‰ä¾‹å¦‚ï¼š**my-project**
* åªéœ€è¦è¾“å…¥é¡¹ç›®åç§° (Repository name) å³å¯ï¼Œé¡¹ç›®æè¿°ï¼ˆDescriptionï¼‰é€‰å¡«ã€‚Public æ˜¯å…¬å¼€ï¼Œå¯ä»¥åœ¨ GitHub æœåˆ°ï¼ŒPrivate æ˜¯ç§å¯†é¡¹ç›®ï¼Œåªæœ‰è‡ªå·±å’Œé¡¹ç›®æˆå‘˜èƒ½çœ‹åˆ°ã€‚ç‚¹å‡» Create repository

![image.png](4_images/img1.png)

### 1.4 åˆå§‹åŒ– Git ä»“åº“å¹¶æ¨é€åˆ° GitHub

1.  åœ¨ GitHub ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„é¡¹ç›®ä»“åº“ï¼ˆRepositoryï¼‰ã€‚
2.  å‡†å¤‡å¥½æäº¤ä»£ç éœ€è¦çš„ token  [åˆ›å»ºæ•™ç¨‹](https://blog.csdn.net/chengwenyang/article/details/120060010),
3.  åœ¨æœ¬åœ°åˆå§‹åŒ– Git ä»“åº“å¹¶æ¨é€ä»£ç ï¼š


```bash
>>> mkdir my-project && â€‹cdâ€‹ my-project
>>> echo "# test" >> README.md
>>> git init

# é¦–æ¬¡ä½¿ç”¨éœ€è¦è®¾ç½®ç”¨æˆ·åå’Œé‚®ç®±
>>> git config --global user.name "ä½ çš„ç”¨æˆ·å"
>>> git config --global user.email "ä½ çš„é‚®ç®±"

>>> git add README.md
>>> git commit -m "test"
>>> git branch -M main
>>> git remote add origin <your-repo-url>
>>> git push -u origin main
```



4.  è¾“å…¥ç”¨æˆ·ååŠtoken å³å¯æ¨åˆ°è¿œç¨‹ä»“åº“



```bash
>>> git push -u origin main
Username for 'https://github.com': lwj-st
Password for 'https://lwj-st@github.com': 
Enumerating objects: 3, done.
Counting objects: 100% (3/3), done.
Writing objects: 100% (3/3), 223 bytes | 223.00 KiB/s, done.
Total 3 (delta 0), reused 0 (delta 0), pack-reused 0
To https://github.com/lwj-st/my-project.git
 * [new branch]      main -> main
Branch 'main' set up to track remote branch 'main' from 'origin'.
```



### â€‹1.5â€‹ æ·»åŠ åŸºæœ¬çš„å·¥ç¨‹æ–‡ä»¶

* `README.md`ä»‹ç»é¡¹ç›®ç”¨é€”ï¼Œç¤ºä¾‹ï¼š

```bash
# my-project

## ä»‹ç»
è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ Python é¡¹ç›®ï¼Œæ”¯æŒè‡ªåŠ¨åŒ–æµ‹è¯•ã€Docker éƒ¨ç½²ï¼Œå¹¶ç¬¦åˆ PEP 8 ä»£ç è§„èŒƒã€‚

## å®‰è£…
pip install my-project
```



* `.gitignore`å¿½ç•¥ä¸éœ€è¦æäº¤çš„æ–‡ä»¶ï¼Œå¦‚ç¼–è¯‘ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€æ—¥å¿—æ–‡ä»¶ç­‰ [è§„åˆ™](https://monsterhxw.github.io/posts/git-gitignore-tutorials/)  ç¤ºä¾‹ï¼š



```text
        __pycache__
        *.pyc
        test/
        dist/
        tmp/
        .vscode
        build
        *.lock
        *.db
```



* `requirements.txt`è®°å½•é¡¹ç›®ä¾èµ–  ç¤ºä¾‹ï¼š



```text
        lazyllm
```



* `Dockerfile`ï¼šé•œåƒæ„å»ºæ–‡ä»¶ ğŸ“ƒ åˆ›å»ºå¹¶æ¨é€é•œåƒ
* `setup.py`ï¼šæ‰“åŒ…ä¸å‘å¸ƒæ–‡ä»¶ ğŸ“ƒ ä½¿ç”¨ setuptools è¿›è¡Œæ‰“åŒ…

<div style="text-align:center; margin:20px 0;">
  <video controls style="width:900px; max-width:100%; height:auto; border:1px solid #ccc; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1);">
    <source src="../4_videos/1.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
</div>

### 1.6 æ·»åŠ ä¸»é¡¹ç›®æ–‡ä»¶

é¡¹ç›®ä»£ç ä»¥ ã€ç¬¬2è®²ï¼š10åˆ†é’Ÿä¸Šæ‰‹ä¸€ä¸ªæœ€å°å¯ç”¨RAGç³»ç»Ÿã€‘ä¸ºä¾‹ï¼Œæ·»åŠ ä¸»ä»£ç æ–‡ä»¶

* `my_project/retriever.py`



```python
from lazyllm import Retriever, Document

def create_retriever(path: str, query: str):
    """
    åˆ›å»ºå¹¶æ‰§è¡Œæ£€ç´¢
    
    Args:
        path (str): æ–‡æ¡£çš„ç»å¯¹è·¯å¾„
        query (str): æŸ¥è¯¢è¯­å¥
        
    Returns:
        list: æ£€ç´¢ç»“æœ
    """
    doc = Document(path)
    retriever = Retriever(doc, group_name="CoarseChunk", similarity="bm25_chinese", topk=3)
    return retriever(query)
```



* `my_project/__init__.py`



```python
from .retriever import create_retriever

__version__ = '0.1.0'
__all__ = ['create_retriever']
```



---

## 2. ç‰ˆæœ¬ç®¡ç†å’Œåˆ†æ”¯ç­–ç•¥

è‰¯å¥½çš„åˆ†æ”¯ç®¡ç†ç­–ç•¥æœ‰åŠ©äºå¤šäººåä½œå’Œç¨³å®šç‰ˆæœ¬å‘å¸ƒã€‚

### 2.1 å¸¸è§åˆ†æ”¯å‘½å

* **â€‹ä¸»åˆ†æ”¯â€‹**ï¼ˆâ€‹`main`ï¼‰â€‹ï¼šå§‹ç»ˆä¿æŒç¨³å®šå¯å‘å¸ƒçŠ¶æ€
* **â€‹å¼€å‘åˆ†æ”¯â€‹**ï¼ˆâ€‹â€‹`dev`â€‹ï¼‰â€‹ï¼šç”¨äºæ—¥å¸¸å¼€å‘
* **â€‹åŠŸèƒ½åˆ†æ”¯â€‹**ï¼ˆ`feature/*`â€‹ï¼‰â€‹ï¼šç”¨äºå¼€å‘æ–°åŠŸèƒ½ï¼Œå®Œæˆååˆå¹¶å› `dev`
* **â€‹ä¿®å¤åˆ†æ”¯â€‹**ï¼ˆ`hotfix/*`â€‹â€‹ï¼‰â€‹ï¼šç”¨äºç´§æ€¥ä¿®å¤ç”Ÿäº§ç¯å¢ƒ bug

### 2.2 Git åˆ†æ”¯ç®¡ç†æ“ä½œç¤ºä¾‹



```bash
# åˆ›å»ºå¹¶åˆ‡æ¢åˆ°å¼€å‘åˆ†æ”¯
>>> git checkout -b dev

# åœ¨devåˆ†æ”¯ä¸Šæ–°åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
>>> git checkout -b feature/new-feature

...ä¿®æ”¹ä»£ç ...

>>> git add .
>>> git commit -m "Add new feature"
>>> git push origin feature/new-feature

# å¼€å‘å®Œæˆååˆå¹¶å› dev
>>> git checkout dev

>>> git merge feature/new-feature
>>> git push origin dev
```



### 2.3 åœ¨githubä¸Šæäº¤pull request

* å½“æ”¹å¥½çš„ä»£ç æåˆ°è¿œç¨‹ä»“åº“åå°±å¯ä»¥æäº¤pull requestäº†
* è¿›å…¥ GitHub ä»“åº“ä¸»é¡µï¼Œç‚¹å‡» "Pull Requests" -> "New Pull Request"
* å¦‚æœæ˜¯åŒä¸€ä»“åº“çš„Pull Requests é€‰æ‹©å¯¹åº”çš„ **base ï¼ˆç›®æ ‡åˆ†æ”¯ï¼‰** å’Œ **compare ï¼ˆæ¯”å¯¹åˆ†æ”¯ï¼‰å³å¯**
* å¦‚æœæ˜¯forkä»“åº“çš„Pull Requests åˆ™æœ‰**â€‹â€‹ base repository ï¼ˆç›®æ ‡ä»“åº“ï¼‰â€‹**å’Œ **â€‹base ï¼ˆç›®æ ‡åˆ†æ”¯ï¼‰â€‹**é»˜è®¤æ˜¯forkçš„æºä»“åº“ä¿¡æ¯ï¼Œ**â€‹head repository ï¼ˆæºä»“åº“ï¼‰â€‹**å’Œ**â€‹â€‹ compare ï¼ˆæ¯”å¯¹åˆ†æ”¯ï¼‰â€‹**é»˜è®¤æ˜¯è‡ªå·±ä»“åº“çš„ä¿¡æ¯
* æ·»åŠ  PR è¯´æ˜ï¼Œç‚¹å‡» "Create Pull Request"

### 2.4 è§£å†³å†²çª

å½“å¤šä¸ªå¼€å‘è€…åŒæ—¶ä¿®æ”¹åŒä¸€éƒ¨åˆ†ä»£ç å¹¶å°è¯•åˆå¹¶æ—¶ï¼ŒGit å¯èƒ½ä¼šæç¤º**â€‹ conflictï¼ˆä»£ç å†²çªï¼‰**

1.åŒåˆ†æ”¯å†²çªè§£å†³

* å½“æäº¤ä»£ç Git æ£€æµ‹åˆ°å†²çªæ—¶ï¼Œå®ƒä¼šè¾“å‡ºç±»ä¼¼ä»¥ä¸‹ä¿¡æ¯ï¼š



```bash
To https://github.com/lwj-st/my-project.git
 ! [rejected]        dev -> dev (fetch first)
error: failed to push some refs to 'https://github.com/lwj-st/my-project.git'
hint: Updates were rejected because the remote contains work that you do
hint: not have locally. This is usually caused by another repository pushing
hint: to the same ref. You may want to first integrate the remote changes
hint: (e.g., 'git pull ...') before pushing again.
hint: See the 'Note about fast-forwards' in 'git push --help' for details.
```



* æ‰§è¡Œ`git pull` mergeè¿œç¨‹åˆ†æ”¯



```bash
CONFLICT (content): Merge conflict in requirements.txt
Automatic merge failed; fix conflicts and then commit the result.
```



* æ­¤æ—¶ï¼Œä½ å¯ä»¥è¿è¡Œ`git status`æŸ¥çœ‹å“ªäº›æ–‡ä»¶å­˜åœ¨å†²çªï¼Œè¾“å‡ºç¤ºä¾‹ï¼š



```bash
>>> git status
On branch dev
Your branch and 'origin/dev' have diverged,
and have 1 and 1 different commits each, respectively.
  (use "git pull" to merge the remote branch into yours)

You have unmerged paths.
  (fix conflicts and run "git commit")
  (use "git merge --abort" to abort the merge)

Unmerged paths:
  (use "git add <file>..." to mark resolution)
        both modified:   requirements.txt

no changes added to commit (use "git add" and/or "git commit -a")
```



* ç›´æ¥ä¿®æ”¹æ–‡ä»¶ï¼Œä¿ç•™æ­£ç¡®çš„ä»£ç ç„¶åæ·»åŠ å¹¶æäº¤ï¼š



```bash
>>> git add requirements.txt
>>> git commit -m "è§£å†³å†²çª"
>>> git push
```



<div style="text-align:center; margin:20px 0;">
  <video controls style="width:900px; max-width:100%; height:auto; border:1px solid #ccc; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1);">
    <source src="../4_videos/2.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
</div>

---

2.PRå†²çªè§£å†³

* å¦‚æœPRå†²çªåˆ™ä¼šåœ¨é¡µé¢å‡ºç° **â€‹This branch has conflicts that must be resolvedï¼ˆè¿™ä¸ªåˆ†æ”¯æœ‰å¿…é¡»è§£å†³çš„å†²çªï¼‰â€‹**å¦‚ä¸‹ï¼š

![image.png](4_images/img3.png)

* é¡µé¢ä¿®æ”¹ï¼Œç›´æ¥ç‚¹å‡» **Resolve conflicts ï¼ˆè§£å†³å†²çªï¼‰**
* ç¼–è¾‘å†²çªæ–‡ä»¶ä¿ç•™éœ€è¦çš„å†…å®¹åç‚¹å‡» æ ‡è®°ä¸º**â€‹â€‹ Mark as resolvedï¼ˆå·²è§£å†³ï¼‰â€‹**å³å¯
* Git ä¼šåœ¨æœ‰å†²çªçš„æ–‡ä»¶ä¸­æ ‡è®°å†²çªéƒ¨åˆ†ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

![image-2.png](4_images/img2.png)


```bash
<<<<<<< dev
xxxx 
=======
xxxx 
>>>>>>> main
```



* `<<<<<<< dev ` è¡¨ç¤º **åˆå¹¶è¿›æ¥çš„ dev** çš„ä»£ç 
* `=======` æ˜¯åˆ†éš”ç¬¦
* `>>>>>>> main`  è¡¨ç¤º **å½“å‰åˆ†æ”¯ï¼ˆmainï¼‰** çš„ä»£ç 

<div style="text-align:center; margin:20px 0;">
  <video controls style="width:900px; max-width:100%; height:auto; border:1px solid #ccc; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1);">
    <source src="../4_videos/3.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
</div>

---

## 3. ä»£ç è§„èŒƒä¸è‡ªåŠ¨æ£€æŸ¥

ä¸ºäº†ä¿è¯ä»£ç è´¨é‡ï¼Œæˆ‘ä»¬éœ€è¦éµå¾ªç»Ÿä¸€çš„ç¼–ç è§„èŒƒã€‚

### 3.1 å¸¸ç”¨ä»£ç æ ¼å¼åŒ–ä¸é£æ ¼æ£€æŸ¥

1.â€‹`black`â€‹ï¼šè‡ªåŠ¨æ ¼å¼åŒ–ä»£ç 

* å®‰è£… `black`



```bash
>>> pip install black
```



* æ ¼å¼åŒ–æ•´ä¸ªé¡¹ç›® `black .`



```bash
>>> black .
reformatted /root/my_project/__init__.py
reformatted /root/my_project/retriever.py

All done! âœ¨ ğŸ° âœ¨
2 files reformatted.
```



* ç‰¹ç‚¹
  * -â€‹**å¼ºåˆ¶ä»£ç æ ¼å¼åŒ–**â€‹ï¼ˆä¸èƒ½è‡ªå®šä¹‰æ ·å¼ï¼Œå‡å°‘å›¢é˜Ÿäº‰è®®ï¼‰
  * -â€‹**é»˜è®¤ 88 å­—ç¬¦æ¢è¡Œ**â€‹ï¼ˆå¯è°ƒæ•´ï¼‰
  * â€‹-**è‡ªåŠ¨è°ƒæ•´å¼•å·**â€‹ï¼ˆä¼˜å…ˆä½¿ç”¨åŒå¼•å·ï¼‰
  * -**å¯¹`if-else`â€‹**ã€åˆ—è¡¨ç­‰ç»“æ„è¿›è¡Œä¼˜åŒ–**

2.â€‹`flake8`â€‹ï¼šä»£ç é£æ ¼æ£€æŸ¥

* å®‰è£… `flake8`



```bash
>>> pip install flake8
```



* æ£€æŸ¥æ•´ä¸ªé¡¹ç›® `flake8 .` æœ‰é—®é¢˜çš„è¯ä¼šæœ‰æ—¥å¿—æç¤ºï¼Œæ²¡æ—¥å¿—ä¿¡æ¯å°±æ˜¯æœ€å¥½çš„ä¿¡æ¯



```bash
>>> flake8 .
```



* ç‰¹ç‚¹
  * -â€‹**ä»£ç é£æ ¼æ£€æŸ¥**â€‹ï¼šåŸºäº PEP 8 è§„èŒƒï¼Œæ£€æµ‹ç¼©è¿›ã€å‘½åã€è¡Œé•¿åº¦ç­‰é—®é¢˜ã€‚
  * â€‹-**è¯­æ³•é”™è¯¯æ£€æµ‹**â€‹ï¼šå‘ç°æœªå®šä¹‰å˜é‡ã€è¯­æ³•é”™è¯¯ç­‰æ½œåœ¨ Bugã€‚
  * â€‹-**å¤æ‚æ€§åˆ†æ**â€‹ï¼šé€šè¿‡ McCabe å¤æ‚åº¦æ£€æŸ¥ï¼Œæç¤ºä»£ç æ˜¯å¦è¿‡äºå¤æ‚ã€‚
  * â€‹-**æ’ä»¶æ‰©å±•æ€§**â€‹ï¼šæ”¯æŒç¬¬ä¸‰æ–¹æ’ä»¶ï¼Œå¯æ‰©å±•æ£€æŸ¥è§„åˆ™ï¼ˆå¦‚ç±»å‹æ£€æŸ¥ï¼‰ã€‚

3. `pre-commit`â€‹ï¼šåœ¨æäº¤ä»£ç å‰è‡ªåŠ¨è¿è¡Œæ£€æŸ¥

* å®‰è£…`pre-commit`



```bash
>>> pip install pre-commit
```



* åˆå§‹åŒ–`pre-commit`



```bash
>>> pre-commit install
```



* åœ¨ `.pre-commit-config.yaml` ä¸­æ·»åŠ è§„åˆ™ï¼š



```yaml
repos:
  - repo: https://github.com/psf/black
    rev: 23.1.0
    hooks:
      - id: black

  - repo: https://github.com/pycqa/flake8
    rev: 6.0.0
    hooks:
      - id: flake8
```



---

## 4. å•å…ƒæµ‹è¯•ä¸ä»£ç è´¨é‡ä¿éšœ

### 4.1 ä¸ºä»€ä¹ˆè¦å†™å•å…ƒæµ‹è¯•

* å¯ä»¥ç¡®ä¿æ”¹åŠ¨åä»ç„¶ä¿æŒæ­£ç¡®æ€§ï¼Œæé«˜ä»£ç è´¨é‡
* æé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§ï¼Œé™ä½ç»´æŠ¤æˆæœ¬
* å•å…ƒæµ‹è¯•å¯ä»¥å‘ç° Bugï¼Œé¿å…æ„å¤–æ”¹åŠ¨å½±å“å·²æœ‰åŠŸèƒ½ï¼Œæé«˜å¼€å‘æ•ˆç‡
* å•å…ƒæµ‹è¯•å¯ä»¥ä½œä¸ºæ–‡æ¡£ï¼Œå¸®åŠ©å›¢é˜Ÿç†è§£ä»£ç 

---

### 4.2 ä½¿ç”¨ â€‹`pytest`â€‹ ç¼–å†™æµ‹è¯•

> Pytest æ˜¯ Python è¯­è¨€ä¸­æœ€æµè¡Œçš„æµ‹è¯•æ¡†æ¶ä¹‹ä¸€ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨åŒ–æµ‹è¯•ä»£ç ï¼Œç¡®ä¿ä»£ç æŒ‰ç…§é¢„æœŸè¿è¡Œï¼Œå‡å°‘äººå·¥æµ‹è¯•çš„å·¥ä½œé‡ã€‚

1.æµ‹è¯•ç”¨ä¾‹è§„åˆ™

* æ–‡ä»¶å å¿…é¡»ä»¥ `test_` å¼€å¤´æˆ– `_test.py` ç»“å°¾ã€‚
* ç±»å å¿…é¡»ä»¥ `Test` å¼€å¤´ï¼Œå¹¶ä¸”ä¸èƒ½æœ‰`init`æ–¹æ³•ã€‚
* å‡½æ•°/æ–¹æ³• å¿…é¡»ä»¥ `test_` å¼€å¤´ã€‚
* å¯é€šè¿‡ `pytest.ini` è‡ªå®šä¹‰è§„åˆ™ã€‚

2.å®‰è£… `pytest`ï¼š



```bash
>>> pip install pytest
```



3.åˆ›å»º `tests/test_retriever.py`ï¼š



```python
import pytest
from my_project import create_retriever

# æµ‹è¯•æ–‡æ¡£è·¯å¾„
TEST_PATH = "./data_kb"

def test_retriever_contains_keyword():
    test_query = "ä¸ºæˆ‘ä»‹ç»ä¸€ä¸‹2008å¹´åŒ—äº¬å¥¥è¿ä¼š"
    expected_keyword = "å¥¥è¿æ¯”èµ›"
    
    results = create_retriever(TEST_PATH, test_query)
    top_content = results[0].get_content() if results else ""
    
    assert expected_keyword in top_content, f"æ£€ç´¢ç»“æœä¸­æœªæ‰¾åˆ°å…³é”®è¯ '{expected_keyword}'"

def test_retriever_empty_query():
    results = create_retriever(TEST_PATH, "")
    assert isinstance(results, list), "ç»“æœåº”è¯¥æ˜¯åˆ—è¡¨ç±»å‹"
```



4.è¿è¡Œæµ‹è¯•ï¼šï¼ˆæå‰å‡†å¤‡å¥½æµ‹è¯•æ•°æ® ./data\_kbï¼‰



```bash
>>> export PYTHONPATH=${PWD}:$PYTHONPATH
>>> pytest --disable-warnings tests/test_retriever.py 
==================================== test session starts ====================================
platform linux -- Python 3.10.9, pytest-8.3.3, pluggy-1.5.0
rootdir: /root
plugins: anyio-4.4.0, hydra-core-1.3.2
collected 2 items                                                                                                                                                                                        

tests/test_retriever.py ..                                                                   [100%]

===================================== 2 passed in 0.01s =====================================
```


* --disable-warnings  å¿½ç•¥è­¦å‘Šæ—¥å¿—ï¼ˆåªä¼šæ‰“å°é”™è¯¯æ—¥å¿—ï¼‰

---

### 4.3 pytestä¸­å¸¸ç”¨çš„æ ‡è®°â€‹ï¼ˆæ‰©å±•ï¼‰

1.pytest æä¾›äº† `markers`ï¼ˆæ ‡è®°ï¼‰ æœºåˆ¶ï¼Œå¯ä»¥ç”¨æ¥åˆ†ç±»æµ‹è¯•ã€æ§åˆ¶æµ‹è¯•æ‰§è¡Œã€å‚æ•°åŒ–æµ‹è¯•ç­‰ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ pytest æ ‡è®°åŠå…¶ç”¨é€”ã€‚
2.ç¤ºä¾‹ `tests/test_server.py`



```python
# content of test_server.py
import pytest

@pytest.mark.webtest
def test_send_http():
    pass  # perform some webtest test for your app
    
@pytest.mark.device(serial="123")
def test_something_quick():
    pass
    
@pytest.mark.device(serial="abc")
def test_another():
    pass
    
class TestClass:
    def test_method(self):
        pass
```



3.ç„¶åï¼Œæ‚¨å¯ä»¥å°†æµ‹è¯•è¿è¡Œé™åˆ¶ä¸ºä»…è¿è¡Œæ ‡æœ‰ çš„æµ‹è¯•`webtest`



```bash
>>>  pytest -v -m webtest
==================================== test session starts ====================================
platform linux -- Python 3.10.9, pytest-8.3.3, pluggy-1.5.0 -- /opt/miniconda3/envs/lazyllm/bin/python
cachedir: .pytest_cache
rootdir: /root/my-project
plugins: anyio-4.4.0, hydra-core-1.3.2
collected 4 items / 3 deselected / 1 selected

tests/test_server.py::test_send_http PASSED                                           [100%]
======================== 1 passed, 3 deselected, 3 warnings in 0.01s ========================
```



4.æ­¤å¤–ï¼Œæ‚¨å¯ä»¥é™åˆ¶æµ‹è¯•è¿è¡Œï¼Œä»…è¿è¡Œä¸ä¸€ä¸ªæˆ–å¤šä¸ªæ ‡è®°å…³é”®å­—å‚æ•°åŒ¹é…çš„æµ‹è¯•ï¼Œä¾‹å¦‚ï¼Œä»…è¿è¡Œæ ‡æœ‰`device`å’Œç‰¹å®šçš„æµ‹è¯•`serial="123"`ï¼š



```bash
>>>  pytest -v -m "device(serial='123')"
==================================== test session starts ====================================
platform linux -- Python 3.10.9, pytest-8.3.3, pluggy-1.5.0 -- /opt/miniconda3/envs/lazyllm/bin/python
cachedir: .pytest_cache
rootdir: /root/my-project
plugins: anyio-4.4.0, hydra-core-1.3.2
collected 4 items / 3 deselected / 1 selected

tests/test_server.py::test_something_quick PASSED                                     [100%]
======================== 1 passed, 3 deselected, 3 warnings in 0.03s ========================
```

5.æ›´å¤šä¿¡æ¯å¯å‚è€ƒ [markers](https://docs.pytest.org/en/stable/example/markers.html)

---

### 4.4 æµ‹è¯•è¦†ç›–ç‡

* åœ¨æŒç»­é›†æˆï¼ˆCIï¼‰ä¸­ï¼Œæµ‹è¯•è¦†ç›–ç‡æ˜¯è¡¡é‡ä»£ç è´¨é‡çš„é‡è¦æŒ‡æ ‡ã€‚ä½¿ç”¨ `pytest` ç»“åˆ `pytest-cov` æ’ä»¶ï¼Œå¯ä»¥ç”Ÿæˆè¯¦ç»†çš„æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Šï¼Œå¸®åŠ©å¼€å‘è€…åˆ†æå“ªäº›ä»£ç æœªè¢«æµ‹è¯•ã€‚
* æ‰§è¡Œæµ‹è¯•ï¼Œæ·»åŠ è¦†ç›–ç‡ç»Ÿè®¡ï¼š


```bash
    export PYTHONPATH=${PWD}:$PYTHONPATH
    pytest --cov=my_project --cov-append --cov-report=html
```



* æµ‹è¯•å®Œæˆåï¼Œå¯ä»¥åœ¨ **htmlcov â€‹**ç›®å½• æŸ¥çœ‹HTML æŠ¥å‘Šã€‚
* `pytest --cov=my-project` ç»Ÿè®¡ `my-project` ç›®å½•ä¸‹çš„ä»£ç è¦†ç›–ç‡ã€‚
* `--cov-append` ç¡®ä¿å¤šæ¬¡è¿è¡Œæ—¶ï¼Œè¦†ç›–ç‡ä¸ä¼šè¢«é‡ç½®ã€‚
* `--cov-report=html` ç”Ÿæˆå¯è§†åŒ– HTML æŠ¥å‘Šï¼Œå¸®åŠ©åˆ†ææµ‹è¯•è¦†ç›–ç‡ã€‚
* è¯¦ç»†å¯å‚è€ƒ [pytest-cov](https://pytest-cov.readthedocs.io/en/latest/)

![image.png](4_images/img4.png)
---

## 5. æŒç»­é›†æˆï¼ˆCIï¼‰ï¼šè®©æµ‹è¯•è‡ªåŠ¨åŒ–

### 5.1 ä¸ºä»€ä¹ˆè¦CI

1.ä¼ ç»Ÿé¡¹ç›®å¼€å‘æµ‹è¯•ä¼šé‡åˆ°ä¸‹é¢ç­‰é—®é¢˜
   - ä¼ ç»Ÿæ‰‹åŠ¨è¿è¡Œæµ‹è¯•ï¼Œå¯èƒ½ä¼šå¿˜è®°æˆ–æ‰§è¡Œä¸å®Œæ•´ã€‚
   - å¤šäººåä½œæ—¶ï¼Œæ¯ä¸ªäººçš„æµ‹è¯•ç¯å¢ƒå¯èƒ½ä¸åŒï¼Œå¯¼è‡´\*\*â€œåœ¨æˆ‘ç”µè„‘ä¸Šèƒ½è·‘â€\*\*çš„é—®é¢˜ã€‚
   - å¦‚æœä»£ç åˆå¹¶åæ‰æ‰‹åŠ¨æµ‹è¯•ï¼Œå¯èƒ½è¦åˆ°åæœŸæ‰å‘ç° Bugï¼Œä¿®å¤æˆæœ¬æ›´é«˜ã€‚
   - ä»£ç å˜æ›´è¾ƒå¤šæ—¶ï¼Œæ‰‹åŠ¨æµ‹è¯•å¯èƒ½é—æ¼è¾¹ç•Œæƒ…å†µã€‚
   - ä¸åŒå¼€å‘è€…çš„ä»£ç é£æ ¼ä¸åŒï¼Œå¯èƒ½å¯¼è‡´ä»£ç é£æ ¼æ··ä¹±ã€‚

   
2.ä½¿ç”¨GitHub Actions CIæœ‰ä¸‹é¢ç­‰ä¼˜ç‚¹
   - æ¯æ¬¡**â€‹æäº¤ï¼ˆpushï¼‰â€‹**æˆ–**â€‹æ‹‰å–è¯·æ±‚ï¼ˆpull requestï¼‰â€‹**æ—¶ï¼Œè‡ªåŠ¨è¿è¡Œæµ‹è¯•ï¼Œé¿å…é—®é¢˜è¿›å…¥ä¸»åˆ†æ”¯ã€‚
   - å¼€å‘è€…èƒ½åœ¨ç¬¬ä¸€æ—¶é—´çŸ¥é“ä»£ç æ˜¯å¦é€šè¿‡æ‰€æœ‰æµ‹è¯•ã€‚
   - ä»£ç æµ‹è¯•åœ¨æ ‡å‡†åŒ–çš„GitHub Runnerç¯å¢ƒè¿è¡Œï¼Œä¸å—å¼€å‘è€…æœ¬åœ°ç¯å¢ƒå½±å“ã€‚
   - å¯ä»¥å¹¶è¡Œè¿è¡Œå¤šä¸ªæµ‹è¯•ï¼ŒåŠ å¿«åé¦ˆé€Ÿåº¦ã€‚
   - ä½¿ç”¨ â€‹`prettier`â€‹ã€`black`â€‹ã€`flake8`â€‹ã€`eslint` ç­‰å·¥å…·ï¼Œè‡ªåŠ¨æ£€æŸ¥ä»£ç æ ¼å¼ï¼Œä¿æŒä»£ç é£æ ¼ä¸€è‡´ã€‚
   - Github æä¾›å…è´¹çš„runnerä½¿ç”¨ï¼Œå¯ä»¥ç™½å«–

---

### â€‹5.2 é…ç½®CI

* æ·»åŠ  `.github/workflows/test.yml` ï¼š



```yaml
name: Run Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run tests
        run: |
          export PYTHONPATH=${PWD}:$PYTHONPATH 
          pytest
```


* å¯å®ç°æ¯æ¬¡æäº¤præˆ–åˆå…¥åˆ†æ”¯æ—¶è¿›è¡Œæµ‹è¯•

![image.png](4_images/img5.png)

---

## 6. ä»£ç æ–‡æ¡£ç®¡ç†ï¼šç”¨ MkDocs æ­å»ºæ–‡æ¡£ç³»ç»Ÿ

### 6.1 ä¸ºä»€ä¹ˆè¦ç”¨MkDocs

1.åœ¨é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæ–‡æ¡£ç®¡ç†å¸¸å¸¸é‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š
   - ä¸åŒå¼€å‘è€…å¯èƒ½ä½¿ç”¨ **Wordã€Markdownã€PDFã€Wiki** ç­‰ä¸åŒæ ¼å¼ï¼Œå¯¼è‡´éš¾ä»¥ç»´æŠ¤ã€‚
   - è®¸å¤šæ–‡æ¡£å­˜å‚¨åœ¨æœ¬åœ°ï¼Œç¼ºå°‘ç‰ˆæœ¬æ§åˆ¶ï¼Œéš¾ä»¥è¿½è¸ªæ›´æ”¹å†å²ã€‚
   - éœ€è¦æ‰‹åŠ¨æ›´æ–°ç¼–è¯‘ï¼Œè¿‡ç¨‹ç¹çã€‚

2.ä½¿ç”¨MkDocs å¯ä»¥å¾ˆå¥½çš„è¿™äº›é—®é¢˜
   - ä½¿ç”¨ Markdown ç¼–å†™ï¼Œç®€å•æ˜“è¯»ï¼Œç»Ÿä¸€æ ¼å¼ï¼Œé™ä½å­¦ä¹ æˆæœ¬ã€‚
   - Git ç‰ˆæœ¬æ§åˆ¶ï¼Œæ–‡æ¡£ä¸ä»£ç ä¸€èµ·ç®¡ç†ï¼Œéšä»£ç æ›´æ–°è€Œæ›´æ–°ã€‚
   - ç»“åˆ GitHub Actions æˆ– Read the Docsï¼Œæäº¤ä»£ç åè‡ªåŠ¨ç”Ÿæˆæœ€æ–°æ–‡æ¡£ï¼Œæ— éœ€æ‰‹åŠ¨æ›´æ–°ã€‚

---

### â€‹6.2â€‹ ä½¿ç”¨ MkDocs ç”Ÿæˆæ–‡æ¡£

1.å®‰è£…ä¾èµ–åŒ…ï¼Œæœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…[å®‰è£…æŒ‡å—](https://www.mkdocs.org/user-guide/installation/)ã€‚



```bash
>>> pip install mkdocs
```



2.åˆå§‹åŒ– MkDocsï¼š



```bash
>>> mkdocs new my-project
>>> cd my-project
```



3.åˆ›å»ºæ–‡ä»¶ç›®å½•å¦‚ä¸‹ï¼šæœ‰ä¸€ä¸ªé…ç½®æ–‡ä»¶`mkdocs.yml`ï¼Œä»¥åŠä¸€ä¸ªåä¸º  `docs` çš„æ–‡ä»¶å¤¹ï¼Œå…¶ä¸­åŒ…å«æ‚¨çš„æ–‡æ¡£æºæ–‡ä»¶ï¼ˆæ˜¯[docs\_dir](https://www.mkdocs.org/user-guide/configuration/#docs_dir) é…ç½®è®¾ç½®çš„é»˜è®¤å€¼ï¼‰ã€‚ç›®å‰è¯¥ `docs` æ–‡ä»¶å¤¹ä»…åŒ…å«ä¸€ä¸ªåä¸º`index.md` çš„æ–‡æ¡£é¡µé¢ã€‚



```yaml
my-project/
â”œâ”€â”€ docs
â”‚   â””â”€â”€ index.md
â””â”€â”€ mkdocs.yml
```



4.æŸ¥çœ‹é¡¹ç›®

* ç„¶åé€šè¿‡è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨æœåŠ¡å™¨`mkdocs serve`
  * ç«¯å£è¢«å ç”¨æ—¶å¯ä»¥ç”¨ `-a` æŒ‡å®šç«¯å£ `mkdocs serve -a 0.0.0.0:8008`
  


```bash
  $ mkdocs serve
  INFO    -  Building documentation...
  INFO    -  Cleaning site directory
  INFO    -  Documentation built in 0.22 seconds
  INFO    -  [15:50:43] Watching paths for changes: 'docs', 'mkdocs.yml'
  INFO    -  [15:50:43] Serving on http://127.0.0.1:8000/
```

* åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€[http://127.0.0.1:8000/](http://127.0.0.1:8000/)ï¼Œæ‚¨å°†çœ‹åˆ°æ˜¾ç¤ºçš„é»˜è®¤ä¸»é¡µï¼š
* è¯¦ç»†é…ç½®å‚è€ƒï¼šhttps://www.mkdocs.org/

![image.png](4_images/img6.png)

---

### â€‹6.3 æ‰˜ç®¡åˆ° Read the Docs

1.ä¸ºä»€ä¹ˆé€‰æ‹©**Read the Docs ï¼Ÿ**

åœ¨å¼€å‘é¡¹ç›®æ—¶ï¼Œè‰¯å¥½çš„ **æ–‡æ¡£** æ˜¯ä¸å¯æˆ–ç¼ºçš„ã€‚ç›¸æ¯”æŠŠæ–‡æ¡£æ•£è½åœ¨æœ¬åœ°æ–‡ä»¶ã€Markdown æ–‡ä»¶æˆ– Wiki é¡µé¢ä¸Šï¼Œ**Read the Docs** æä¾›äº†ä¸€ä¸ªé«˜æ•ˆçš„åœ¨çº¿æ–‡æ¡£æ‰˜ç®¡å’Œè‡ªåŠ¨æ„å»ºå¹³å°ï¼Œç‰¹åˆ«é€‚åˆ **å¼€æºé¡¹ç›®** å’Œ â€‹**æŒç»­æ›´æ–°çš„æŠ€æœ¯æ–‡æ¡£**â€‹ã€‚

ä»¥ä¸‹æ˜¯æ‰˜ç®¡åˆ° Read the Docs çš„å‡ ä¸ªæ ¸å¿ƒä¼˜åŠ¿ï¼š

* â€‹**è‡ªåŠ¨æ„å»º**â€‹ï¼šæ¨é€ä»£ç åˆ° GitHubï¼ŒRead the Docs å°±ä¼š è‡ªåŠ¨æ„å»ºå¹¶æ›´æ–°æ–‡æ¡£ã€‚
* â€‹**ç‰ˆæœ¬ç®¡ç†**â€‹ï¼šæ”¯æŒå¤šä¸ªæ–‡æ¡£ç‰ˆæœ¬ï¼Œå¯ä»¥è®©ç”¨æˆ·æŸ¥çœ‹ä¸åŒç‰ˆæœ¬çš„æ–‡æ¡£ï¼ˆæ¯”å¦‚ `latest`ã€`stable`ã€`v1.0`ï¼‰
* **åœ¨çº¿æœç´¢ï¼š â€‹**æä¾›åœ¨çº¿æœç´¢åŠŸèƒ½ï¼Œå¯ä»¥å¿«é€ŸæŸ¥æ‰¾å†…å®¹ã€‚
* â€‹**å…è´¹æ‰˜ç®¡**â€‹ï¼šå®Œå…¨å…è´¹ï¼Œä¸éœ€è¦é¢å¤–è´­ä¹°æœåŠ¡å™¨æˆ–åŸŸåã€‚ä¸”è‡ªå¸¦â€‹**https å®‰å…¨è®¿é—®**â€‹ï¼Œæ— éœ€é…ç½® SSL è¯ä¹¦ã€‚

2.æ·»åŠ `.readthedocs.yaml` æ–‡ä»¶ [é…ç½®è¯´æ˜](https://docs.readthedocs.com/platform/stable/config-file/v2.html)



```yaml
# .readthedocs.yaml
# Read the Docs é…ç½®æ–‡ä»¶

# å¿…éœ€çš„ç‰ˆæœ¬å­—æ®µ
version: 2

# è®¾ç½®æ„å»ºç¯å¢ƒ
build:
  os: ubuntu-24.04
  tools:
    python: "3.10"  # MkDocs éœ€è¦ Python

# é…ç½® MkDocs
mkdocs:
  configuration: mkdocs.yml  # é»˜è®¤çš„ MkDocs é…ç½®æ–‡ä»¶

# å¯é€‰ï¼šæŒ‡å®š Python ä¾èµ–ï¼ˆå¦‚æœæœ‰ï¼‰
#python:
#  install:
#    - requirements: requirements.txt  # å¦‚æœä½ æœ‰ä¾èµ–æ–‡ä»¶
```



3.æ³¨å†Œ [Read the Docs](https://readthedocs.org/) è´¦å· ï¼ˆé€‰æ‹©githubè‡ªåŠ¨ç™»å½•ï¼‰

4.åœ¨ Read the Docs ä¸»é¡µï¼Œç‚¹å‡» `å¯¼å…¥ä¸€ä¸ªé¡¹ç›®`ï¼ˆâ€‹**Import a Projectâ€‹**ï¼‰â€‹ã€‚

5.é€‰æ‹©éœ€è¦æ‰˜ç®¡çš„ GitHub ä»“åº“ï¼Œç‚¹å‡» **â•** ç»§ç»­ã€‚

6.è®¾ç½®

    -åç§° ï¼šé»˜è®¤ä»“åº“å

    -é»˜è®¤åˆ†æ”¯ ï¼šé€‰ä¸»åˆ†æ”¯

    -è¯­è¨€ï¼šè¯¥é¡¹ç›®çš„æ–‡æ¡£æ‰€å‘ˆç°çš„è¯­è¨€

7.ç‚¹å‡» â€‹`ä¸‹ä¸€é¡µ`â€‹ï¼Œç³»ç»Ÿä¼šå¼€å§‹è‡ªåŠ¨æ„å»ºæ–‡æ¡£ã€‚

8.Read the Docs ä¼šè‡ªåŠ¨æ„å»ºå¹¶æ‰˜ç®¡æ–‡æ¡£

9.æŸ¥çœ‹æ–‡æ¡£ [https://<your-project>.readthedocs.io/](https://your-project.readthedocs.io/)   <your-project> æ¢æˆè‡ªå·±çš„é¡¹ç›®å

<div style="text-align:center; margin:20px 0;">
  <video controls style="width:900px; max-width:100%; height:auto; border:1px solid #ccc; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1);">
    <source src="../4_videos/4.mp4" type="video/mp4" />
    Your browser does not support the video tag.
  </video>
</div>

---

## 7. åˆ¶å“

### 7.1 ä¸ºä»€ä¹ˆè¦åšåˆ¶å“

åœ¨ Python é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œé™¤äº†ç¼–å†™ä»£ç ï¼Œæˆ‘ä»¬é€šå¸¸è¿˜éœ€è¦å°†é¡¹ç›®æ‰“åŒ…æˆ **å¯å‘å¸ƒã€å¯å®‰è£…ã€å¯å¤ç°** çš„æ ¼å¼ï¼Œè¿™äº›è¢«ç§°ä¸º â€‹**åˆ¶å“ï¼ˆArtifactsï¼‰**â€‹ã€‚åˆ¶å“å¯ä»¥æ˜¯ â€‹**Python åŒ…ï¼ˆwheelã€sdistï¼‰ã€Docker é•œåƒã€äºŒè¿›åˆ¶æ–‡ä»¶ã€å¯æ‰§è¡Œç¨‹åº**â€‹ã€‚

é¡¹ç›®åˆ¶ä½œåˆ¶å“çš„æ ¸å¿ƒæ„ä¹‰ï¼š

* â€‹**ä¾¿äºå‘å¸ƒä¸åˆ†å‘**â€‹ï¼šå¦‚æœæ²¡æœ‰åˆ¶å“ï¼Œç”¨æˆ·éœ€è¦è‡ªå·±ä¸‹è½½æºç ã€å®‰è£…ä¾èµ–ã€é…ç½®ç¯å¢ƒï¼Œè¿‡ç¨‹ç¹çä¸”å®¹æ˜“å‡ºé”™ã€‚
* â€‹**ç¡®ä¿ç¯å¢ƒä¸€è‡´æ€§**â€‹ï¼šä¸åŒç¯å¢ƒï¼ˆå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰å¯èƒ½ä¾èµ–ä¸åŒç‰ˆæœ¬çš„è½¯ä»¶ï¼Œå¯¼è‡´ç¨‹åºè¡Œä¸ºä¸ä¸€è‡´ã€‚
* â€‹**ä¾¿äºæµ‹è¯•ä¸å›æ»š**â€‹ï¼šæœ‰å¯¹åº”çš„åˆ¶å“æ–¹ä¾¿ç›´æ¥é€‰ç”¨å¯¹åº”çš„ç‰ˆæœ¬çš„åˆ¶å“ä½¿ç”¨ï¼Œå¦‚æœæ²¡æœ‰åˆ¶å“ï¼Œæ¯æ¬¡æµ‹è¯•éƒ½éœ€è¦é‡æ–°æ­å»ºç¯å¢ƒï¼Œå›æ»šç‰ˆæœ¬å›°éš¾ã€‚

### 7.2 whlåŒ…åˆ¶å“

#### 7.2.1 ä¸ºä»€ä¹ˆè¦åšwhlåŒ…åˆ¶å“

`.whl`ï¼ˆWheelï¼‰æ˜¯ä¸€ç§ â€‹**Python åŒ…çš„äºŒè¿›åˆ¶åˆ†å‘æ ¼å¼**â€‹ï¼Œç›¸æ¯”æºç å®‰è£…æ›´é«˜æ•ˆï¼Œå¹¿æ³›ç”¨äºå‘å¸ƒå’Œéƒ¨ç½² Python é¡¹ç›®ã€‚

* **æé«˜å®‰è£…é€Ÿåº¦: â€‹**æ‰“æˆwhlåŒ…å¯ä»¥ç›´æ¥é€šè¿‡ `pip install my-project.whl` æ¯”æºç å®‰è£…æ›´å¿«
* **â€‹è¡Œä¸šå…±è¯†ï¼šâ€‹**ç°åœ¨pythonåˆ¶å“é€šå¸¸éƒ½æ˜¯åšæˆwhlåŒ…ï¼Œå¹¶ä¸Šä¼ å®˜æ–¹pypiä»“åº“ï¼Œæ–¹ä¾¿æ›´å¥½çš„ä¼ æ’­ä¸ä½¿ç”¨

---

#### â€‹7.2.2â€‹ ä½¿ç”¨ `setuptoolsâ€‹` â€‹ è¿›è¡Œæ‰“åŒ…

åœ¨ `setup.py` ä¸­å®šä¹‰ï¼š



```python
from setuptools import setup, find_packages

setup(
    name="my_project",
    version="0.1.0",
    packages=find_packages(),
    install_requires=[
        "lazyllm", 
    ],
    author="Your Name",
    author_email="your@email.com",
    description="A simple RAG retriever package",
    long_description=open("README.md").read(),
    long_description_content_type="text/markdown",
    python_requires=">=3.6",
)
```



ç”Ÿæˆ `.whl` åŒ…ï¼š



```bash
>>> python setup.py bdist_wheel
running bdist_wheel
running build
running build_py
creating build
creating build/lib
creating build/lib/my_project

....

adding 'my_project-0.1.0.dist-info/WHEEL'
adding 'my_project-0.1.0.dist-info/top_level.txt'
adding 'my_project-0.1.0.dist-info/RECORD'
removing build/bdist.linux-x86_64/wheel
>>> ls dist/
my_project-0.1.0-py3-none-any.whl
```



---

#### â€‹7.2.3 æ³¨å†Œpypiè´¦å·

1.è®¿é—® [PyPI å®˜ç½‘](https://pypi.org/) åˆ›å»ºè´¦å·å¹¶ç™»å½•ã€‚

2.ç‚¹å‡»å³ä¸Šè§’ "[Account settings](https://pypi.org/manage/account/)" è¿›å…¥è®¾ç½®é¡µé¢ã€‚

3.åœ¨ "API tokens"ï¼ˆAPI ä»¤ç‰Œï¼‰ éƒ¨åˆ†ï¼Œç‚¹å‡» "Add API token"ï¼ˆæ·»åŠ  API ä»¤ç‰Œï¼‰ã€‚

4.é…ç½® Tokenï¼š
   - åç§°ï¼ˆNameï¼‰ï¼šä¾‹å¦‚ `INDEX_PYPI_TOKEN`
   - ä½œç”¨èŒƒå›´ï¼ˆScopeï¼‰ï¼š
      * Entire accountï¼ˆæ•´ä¸ªè´¦æˆ·ï¼‰ï¼šå…è®¸ç®¡ç†æ‰€æœ‰ PyPI é¡¹ç›®ï¼ˆä¸æ¨èï¼‰
      * Specific projectï¼ˆæŒ‡å®šé¡¹ç›®ï¼‰ï¼šå»ºè®®é€‰æ‹©ä½ çš„é¡¹ç›®åç§°ï¼ˆæ›´å®‰å…¨ï¼‰

5.ç‚¹å‡» Create tokenï¼ˆåˆ›å»ºä»¤ç‰Œï¼‰ã€‚

6.å¤åˆ¶ç”Ÿæˆçš„ API Tokenï¼ˆä»…æ˜¾ç¤ºä¸€æ¬¡ï¼Œæ³¨æ„ï¼šä¸è¦æ³„éœ²æ­¤ä»¤ç‰Œï¼ï¼‰

---

#### 7.2.4 åˆ¶ä½œå¹¶æ¨é€whlåŒ…

7.æœ¬åœ°æ·»åŠ   `~/.pypirc` æ–‡ä»¶



```bash
[pypi]
  username = __token__
  password = pypi-xxxxxxxxxxxxxxxxxxxYjNjNS0xMDExNWMwMzhlNDMiXQAABiDpxiNjoqIT3SJDNrQPP-BJl_AhO7pHErgKvOnS4jzNrQ
```


8.å®‰è£…å·¥å…·åŠä¸Šä¼ åˆ¶å“



```bash
>>> pip install twine
>>> twine upload dist/*
```



---

#### 7.2.5 é€šè¿‡æŒç»­éƒ¨ç½²æ¥å‘å¸ƒåº”ç”¨

>é€šè¿‡é›†æˆgithub actionå®ç°è‡ªåŠ¨åŒ–å‘å¸ƒï¼Œæ˜¯githubé¡¹ç›®ç»å¸¸ä½¿ç”¨çš„ä¸€ç§æ–¹å¼ï¼Œä¸ç”¨äººä¸ºæ‰‹åŠ¨æ„å»ºï¼Œå¯ä»¥åœ¨è®¾å®šæƒ…å†µä¸‹æ„å»ºåŒ…å¹¶ä¸Šä¼ åˆ°å®˜æ–¹pypiä»“åº“ ï¼ˆæ¯”å¦‚ æ‰“tagï¼‰

1.è¿›å…¥ä½ çš„ GitHub ä»“åº“ ã€‚

2.ç‚¹å‡» "Settings" â†’ "Secrets and variables" â†’ "Actions"ã€‚

3.åœ¨ "Secrets" éƒ¨åˆ†ç‚¹å‡» "New repository secret"ã€‚

4.å¡«å†™ï¼š
   - Nameï¼ˆåç§°ï¼‰ï¼šå¦‚ `INDEX_PYPI_TOKEN`
   - Valueï¼ˆå€¼ï¼‰ï¼šç²˜è´´ä½ çš„ API Token

5.ç‚¹å‡» "Add secret"ã€‚

6.ä»“åº“ä¸­æ·»åŠ `.github/workflows/publish-to-pypi.yaml`æ–‡ä»¶



```yaml

name: Publish to PyPI

on:
  push:
    tags:
      - "v*"  # ä»…åœ¨åˆ›å»º tagï¼ˆå¦‚ v1.0.0ï¼‰æ—¶è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: python -m build

      - name: Upload to PyPI
        env:
          INDEX_PYPI_TOKEN: ${{ secrets.INDEX_PYPI_TOKEN }}
        run: |
          twine upload --username __token__ --password $INDEX_PYPI_TOKEN dist/*
```



* æ¯æ¬¡æ‰“tagæ—¶ï¼Œä¼šè‡ªåŠ¨è§¦å‘ç¼–è¯‘whlåŒ…ï¼Œå¹¶ä¸Šä¼ è‡³å®˜æ–¹ä»“åº“

#### 7.2.6 ä½¿ç”¨

1.ç„¶åå…¶ä»–äººå°±å¯ä»¥é€šè¿‡pipæ¥å®‰è£…ä½ çš„é¡¹ç›®ï¼Œé»˜è®¤æœ€æ–°ç‰ˆæœ¬ã€‚



```bash
>>> pip install my-project
```


2.ä¹Ÿå¯ä»¥é™åˆ¶ç‰ˆæœ¬å®‰è£…



```bash
>>> pip install "my-project==0.1.0"
>>> pip install "my-project>=0.1.0"
```



---

### 7.3 é•œåƒåˆ¶å“

#### 7.3.1 ä¸ºä»€ä¹ˆè¦åšDockeré•œåƒ

>**Docker** æ˜¯ä¸€ç§å¼€æºçš„å®¹å™¨åŒ–å¹³å°ï¼Œç”¨äºè‡ªåŠ¨åŒ–åº”ç”¨éƒ¨ç½²ã€‚å®ƒé€šè¿‡å®¹å™¨æŠ€æœ¯å°†åº”ç”¨ç¨‹åºåŠå…¶ä¾èµ–æ‰“åŒ…æˆä¸€ä¸ª â€‹**è½»é‡**â€‹ã€**å¯ç§»æ¤**çš„å•å…ƒï¼Œèƒ½åœ¨ä¸åŒç¯å¢ƒä¸­ä¸€è‡´è¿è¡Œã€‚

ä½¿ç”¨Dockeråˆ¶ä½œé•œåƒåˆ¶å“æœ‰ä¸‹é¢å¥½å¤„ï¼š

* **â€‹ç¯å¢ƒä¸€è‡´æ€§ï¼šâ€‹**é¿å…â€œåœ¨æˆ‘æœºå™¨ä¸Šèƒ½è·‘ï¼Œä½†åœ¨æœåŠ¡å™¨ä¸Šä¸è¡Œâ€çš„é—®é¢˜ã€‚ä¿è¯åœ¨ å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒï¼Œä»£ç å’Œä¾èµ–éƒ½ä¸€æ ·ã€‚
* **â€‹ä¾¿äºéƒ¨ç½²å’Œæ‰©å±•ï¼šâ€‹**ä¸€æ¬¡æ„å»ºï¼Œéšå¤„è¿è¡Œï¼Œå¯ä»¥åœ¨ æœåŠ¡å™¨ã€Kubernetesã€äº‘ç¯å¢ƒ è¿è¡Œã€‚
* **â€‹è¡Œä¸šå½±å“åŠ›ï¼šâ€‹**Dockeråœ¨ä¸šå†…ä½¿ç”¨å¹¿æ³›ï¼Œæœ‰è‡ªå·±çš„å®˜ç½‘ï¼ŒåŸºäºæ­¤æœ‰åˆ©äºæ›´å¥½çš„ä¼ æ’­ä¸ä½¿ç”¨ã€‚

#### 7.3.2 æ³¨å†Œ Docker Hub è´¦å·

* è®¿é—® [Docker Hub å®˜ç½‘](https://hub.docker.com/) å¹¶æ³¨å†Œä¸€ä¸ªè´¦å·ã€‚æ³¨å†Œçš„è´¦å·åå°±æ˜¯ **å‘½åç©ºé—´ï¼ˆNamespaceï¼‰**
* æ³¨å†ŒæˆåŠŸåï¼Œç™»å½•ä½ çš„ Docker Hub è´¦æˆ·ã€‚

---

#### 7.3.3 åˆ›å»ºä»“åº“ï¼ˆâ€‹Repositoryâ€‹ï¼‰

1.ç‚¹å‡»å³ä¸Šè§’çš„**â€‹ â€‹**[Create a repository](https://hub.docker.com/repository/create) (åˆ›å»ºä»“åº“) ã€‚

2.å¡«å†™ä»“åº“ä¿¡æ¯ï¼š

* Repository Nameï¼ˆä»“åº“åç§°ï¼‰ï¼šå¦‚ `my-project`
* Visibilityï¼ˆå¯è§æ€§ï¼‰ï¼š
  * Publicï¼ˆå…¬å¼€ï¼‰ï¼šä»»ä½•äººéƒ½å¯ä»¥æ‹‰å–ä½ çš„é•œåƒ
  * Privateï¼ˆç§æœ‰ï¼‰ï¼šåªæœ‰ä½ æˆ–æˆæƒç”¨æˆ·å¯ä»¥è®¿é—®

3.ç‚¹å‡» Createï¼ˆåˆ›å»ºï¼‰ã€‚

---

#### 7.3.4 ç™»å½• Docker Hub

* åœ¨ç»ˆç«¯æˆ–å‘½ä»¤è¡Œè¿è¡Œï¼š



```bash
>>> docker login
```



* ç„¶åæµè§ˆå™¨æ‰“å¼€ https://login.docker.com/activate ï¼Œå¹¶è¾“å…¥ç»ˆç«¯å¯¹åº”çš„code `SPQK-WMDJ` ã€‚å¦‚æœç™»å½•æˆåŠŸï¼Œä¼šæ˜¾ç¤ºï¼š`Login Succeeded`

![image.png](4_images/img7.png)

---

#### 7.3.5 æ„å»ºå¹¶æ¨é€é•œåƒ

1.ç¼–è¾‘`Dockerfile`



```bash
# 1. é€‰æ‹©åŸºç¡€é•œåƒ
FROM python:3.10

# 2. è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1

# 3. åˆ›å»ºåº”ç”¨æ–‡ä»¶å¤¹
RUN mkdir /app

# 4. æ‹·è´æºç 
COPY my_project /app/my_project
COPY requirements.txt /tmp/requirements.txt
ENV PYTHONPATH="/app:${PYTHONPATH}"

# 5. å®‰è£…ä¾èµ–
RUN pip install -r /tmp/requirements.txt \
    && rm -rf /tmp/requirements.txt

# 6. åˆ›å»ºé root ç”¨æˆ·ï¼Œæå‡å®‰å…¨æ€§
RUN useradd -m myuser
USER myuser

# 7. è®¾ç½®é»˜è®¤å¯åŠ¨å‘½ä»¤ 
CMD ["/bin/bash"]
```



2.æ„å»ºé•œåƒ



```bash
>>> docker build  -t username/my-project:0.1.0 .
```



3.å‘å¸ƒé•œåƒ



```bash
>>> docker push username/my-project:0.1.0
```



#### 7.3.6 é•œåƒä½¿ç”¨

1.æ‹‰å–é•œåƒ



```bash
>>> docker pull username/my-project:0.1.0
```



2.èµ·å®¹å™¨ä½¿ç”¨



```bash
>>> docker run -it --name my-project username/my-project:0.1.0
```